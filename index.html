<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly: Ultimate Host</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --primary: #27ae60;
            --accent: #f1c40f;
            --sidebar-width: 320px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        .screen { display: none; width: 100%; height: 100%; }
        .active { display: flex; }

        /* --- UI COMPONENTS --- */
        .btn {
            padding: 15px 30px; font-size: 1.2rem; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-text { background: transparent; color: #ccc; padding: 10px; font-size: 1rem; }
        .btn-text:hover { color: white; text-decoration: underline; }

        /* --- 1. LANDING --- */
        #landing-screen { flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2c3e50 0%, #000 100%); }
        #landing-screen h1 { font-size: 4rem; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 5px; }
        
        .input-std { padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 8px; border:none; width: 280px; margin: 5px 0; display: block;}
        .input-code { text-transform: uppercase; letter-spacing: 4px; font-weight: bold; }
        
        .menu-container { display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; }
        #main-menu { display: flex; }
        #join-flow { display: none; flex-direction: column; align-items: center; gap: 10px; }

        /* --- 2. LOBBY --- */
        #lobby-screen { flex-direction: column; align-items: center; padding: 40px; background: #222; }
        .lobby-container { display: flex; gap: 50px; width: 100%; max-width: 1000px; height: 100%; }
        .lobby-panel { flex: 1; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; display: flex; flex-direction: column; }
        .lobby-title { font-size: 2rem; margin-bottom: 20px; color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .code-display { font-size: 4rem; color: white; font-weight: 900; vertical-align: middle; margin-left: 15px; letter-spacing: 2px; }

        .rule-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- 3. HOST BOARD --- */
        #host-screen { flex-direction: row; position: relative; }
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        
        #board-wrapper { 
            height: 95vh; width: 95vh; 
            background-image: url('monopoly_board.jpg'); 
            background-size: cover; 
            border-radius: 5px; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            position: relative; 
        }
        
        #host-sidebar { width: var(--sidebar-width); background: #2c3e50; display: flex; flex-direction: column; padding: 20px; border-left: 2px solid #444; }
        
        /* OVERLAYS */
        .overlay-layer { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; display:none; flex-direction: column; align-items:center; justify-content:center; }
        .card-display { width: 320px; height: 200px; background: white; border-radius: 12px; padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; color: black; animation: popIn 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .cd-chance { border: 12px solid #e67e22; } .cd-chest { border: 12px solid #3498db; }
        .cd-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .cd-text { font-size: 1.2rem; }

        /* DICE GRAPHICS */
        .dice-container { display: flex; gap: 20px; justify-content: center; margin-top: 10px; }
        .die { width: 60px; height: 60px; background: white; border-radius: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; padding: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .pip { background: black; border-radius: 50%; width: 10px; height: 10px; place-self: center; }
        
        /* BOARD ELEMENTS */
        .token { position: absolute; width: 3.5%; height: 3.5%; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); transition: top 0.25s linear, left 0.25s linear; z-index: 20; box-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        
        /* OWNERSHIP BARS */
        .owner-bar { position: absolute; z-index: 5; transition: all 0.3s; }
        .bar-bottom { height: 0.6%; width: 8.1%; bottom: 0; transform: translateX(-50%); }
        .bar-left   { height: 8.1%; width: 0.6%; left: 0; top: auto; transform: translateY(-50%); }
        .bar-top    { height: 0.6%; width: 8.1%; top: 0; bottom: auto; transform: translateX(-50%); }
        .bar-right  { height: 8.1%; width: 0.6%; right: 0; left: auto; transform: translateY(-50%); }

        .pot-display { background: #27ae60; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; }

        /* --- 4. CLIENT (PHONE) --- */
        #client-screen { flex-direction: column; background: #34495e; padding: 15px; position:relative; overflow: hidden; }
        .c-header { text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; margin-bottom: 15px; }
        .c-balance { font-size: 2.5rem; color: #2ecc71; font-weight: bold; }
        
        /* DEED CARDS */
        .deed-card { background: white; color: black; padding: 0; width: 100%; max-width: 320px; margin: 0 auto; display: none; border: 1px solid black; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .deed-header { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 1.2rem; border: 2px solid black; margin: 5px; }
        .deed-body { padding: 10px 15px; font-family: 'Arial Narrow', sans-serif; font-size: 0.9rem; text-align: center; }
        .rent-row { display: flex; justify-content: space-between; margin: 5px 0; }
        
        .btn-action { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; border-radius: 10px; border: none; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }

        /* INVENTORY / SWIPE UI */
        #inventory-container { 
            display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; 
            margin-top: auto; border-top: 1px solid rgba(255,255,255,0.2);
        }
        .prop-group-btn {
            min-width: 60px; height: 60px; border-radius: 8px; border: 2px solid white;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.2rem; color: white; text-shadow: 0 1px 3px black;
            cursor: pointer; position: relative;
        }
        .prop-badge {
            position: absolute; top: -5px; right: -5px; background: red; color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem;
            display: flex; justify-content: center; align-items: center; border: 1px solid white;
        }

        #swipe-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.95); z-index: 500; display: none;
            flex-direction: column;
        }
        .swipe-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .swipe-container {
            flex-grow: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory;
            align-items: center; padding: 0 20px; gap: 20px;
        }
        .swipe-item {
            scroll-snap-align: center; flex: 0 0 100%; display: flex; justify-content: center;
        }

        /* ERROR TOAST */
        #error-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 30px; z-index: 1000; font-weight: bold; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        /* COLORS */
        .p-red { background: #e74c3c; } .p-blue { background: #3498db; } .p-green { background: #2ecc71; } .p-yellow { background: #f1c40f; }
        
        .bg-brown { background: #8b4513; color: white; } .bg-lightblue { background: #87ceeb; color: black; } .bg-pink { background: #ff69b4; color: black; }
        .bg-orange { background: #ffa500; color: black; } .bg-red { background: #ff0000; color: white; } .bg-yellow { background: #ffff00; color: black; }
        .bg-green { background: #008000; color: white; } .bg-darkblue { background: #00008b; color: white; }
        .bg-black { background: #000; color: white; } .bg-gray { background: #95a5a6; color: black; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="error-toast">Error Message</div>

    <div id="landing-screen" class="screen active">
        <h1>Monopoly</h1>
        <div id="main-menu" class="menu-container">
            <button class="btn btn-green" onclick="initHost()" style="width: 250px;">HOST GAME</button>
            <button class="btn btn-blue" onclick="showJoin()" style="width: 250px;">JOIN GAME</button>
        </div>
        <div id="join-flow" class="menu-container">
            <input type="text" id="name-input" class="input-std" placeholder="NICKNAME" maxlength="12">
            <input type="text" id="code-input" class="input-std input-code" placeholder="ROOM CODE" maxlength="4">
            <button id="btn-connect" class="btn btn-green" onclick="initPlayer()" style="width: 250px;">CONNECT</button>
            <button class="btn btn-text" onclick="hideJoin()">Back</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-title">
            GAME LOBBY 
            <span style="font-size: 1rem; color: #888; vertical-align: middle;">CODE:</span>
            <span id="lobby-code" class="code-display"></span>
        </div>
        <div class="lobby-container">
            <div class="lobby-panel">
                <div class="lobby-title" style="font-size: 1.5rem;">House Rules</div>
                <div class="rule-item">
                    <span>Free Parking Jackpot</span>
                    <label class="switch"><input type="checkbox" id="rule-pot"><span class="slider"></span></label>
                </div>
                <div class="rule-item">
                    <span>Double Salary on GO ($400)</span>
                    <label class="switch"><input type="checkbox" id="rule-go"><span class="slider"></span></label>
                </div>
                <div class="rule-item">
                    <span>Snake Eyes Bonus ($500)</span>
                    <label class="switch"><input type="checkbox" id="rule-snake"><span class="slider"></span></label>
                </div>
                <div class="rule-item">
                    <span>No Rent in Jail</span>
                    <label class="switch"><input type="checkbox" id="rule-jail"><span class="slider"></span></label>
                </div>
                <div style="margin-top:auto">
                    <button class="btn btn-green" style="width:100%" onclick="startGame()">START GAME</button>
                </div>
            </div>
            <div class="lobby-panel">
                <div class="lobby-title" style="font-size: 1.5rem;">Players Joined</div>
                <div id="lobby-player-list"></div>
                <div style="margin-top:auto; text-align: center;">
                    <button class="btn btn-purple" onclick="addAI()" style="width:100%; margin-bottom:10px;">ADD AI PLAYER</button>
                    <div style="color: #888;">Waiting for players...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="host-screen" class="screen">
        <div id="dice-overlay" class="overlay-layer">
            <div style="width:300px; height:150px; background:transparent; display:flex; justify-content:center; align-items:center; flex-direction:column;">
                <div id="dice-container-host" class="dice-container"></div>
            </div>
        </div>

        <div id="overlay-card" class="overlay-layer">
            <div id="overlay-card-content" class="card-display">
                <div id="ov-title" class="cd-title">CHANCE</div>
                <div id="ov-text" class="cd-text">Text</div>
            </div>
        </div>

        <div id="board-area">
            <div id="board-wrapper"></div>
        </div>
        <div id="host-sidebar">
            <div class="pot-display" id="pot-display" style="display:none;">POT: $<span id="pot-amount">0</span></div>
            <div class="lobby-title" style="font-size: 1.2rem; border:none; margin:0;">PLAYERS</div>
            <div id="game-player-list" style="flex-grow:1; margin-top:10px;"></div>
            <div id="game-log" style="height:150px; background:rgba(0,0,0,0.2); overflow-y:auto; font-size:0.8rem; padding:5px; border-radius:5px;"></div>
        </div>
    </div>

    <div id="client-screen" class="screen">
        <div id="swipe-overlay">
            <div class="swipe-header">
                <h2 style="margin:0">MY PROPERTIES</h2>
                <button class="btn btn-red" style="padding: 5px 15px;" onclick="closeSwipe()">X</button>
            </div>
            <div id="swipe-container" class="swipe-container"></div>
            <div style="text-align:center; padding:10px; color:#aaa;">Swipe to view</div>
        </div>

        <div id="client-dice-overlay" class="overlay-layer" style="z-index: 300; display:none;">
            <div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; margin-bottom:20px;">ROLLED</div>
                <div id="dice-container-client" class="dice-container"></div>
            </div>
        </div>

        <div id="client-overlay-card" class="overlay-layer" style="z-index: 200;">
            <div style="display:flex; flex-direction:column; align-items:center;">
                <div id="c-ov-content" class="card-display">
                    <div id="c-ov-title" class="cd-title">CHANCE</div>
                    <div id="c-ov-text" class="cd-text">Text</div>
                </div>
                <div style="margin-top: 25px;">
                    <button class="btn btn-green" style="padding:15px 40px; font-size:1.5rem; box-shadow:0 0 10px black;" onclick="send('OK')">OK</button>
                </div>
            </div>
        </div>

        <div class="c-header">
            <h2 id="c-name" style="margin:0">Player</h2>
            <div id="c-balance" class="c-balance">$1500</div>
            <div id="c-status" style="color: #bbb; margin-top:5px;">Waiting for host...</div>
        </div>

        <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <div id="deed-card" class="deed-card">
                <div id="deed-header" class="deed-header">TITLE</div>
                <div class="deed-body">
                    <div style="text-align:center; margin-bottom:10px;">Rent <span id="r-base">$0</span></div>
                    <div class="rent-row"><span>1 House</span> <span id="r-1">$0</span></div>
                    <div class="rent-row"><span>2 Houses</span> <span id="r-2">$0</span></div>
                    <div class="rent-row"><span>3 Houses</span> <span id="r-3">$0</span></div>
                    <div class="rent-row"><span>4 Houses</span> <span id="r-4">$0</span></div>
                    <div class="rent-row"><span>HOTEL</span> <span id="r-h">$0</span></div>
                    <div style="margin-top:15px; border-top:1px solid #ccc; padding-top:5px;">
                        Mortgage Value: <span id="r-mort">$0</span><br>
                        Houses cost <span id="r-build">$0</span> each
                    </div>
                </div>
                <div style="background:black; color:white; text-align:center; padding:5px; font-weight:bold; font-size:1.5rem;">PRICE <span id="r-price">$0</span></div>
            </div>
        </div>

        <div id="c-controls"></div>
        
        <div style="padding: 5px 0; font-size: 0.8rem; color:#aaa; text-transform:uppercase; letter-spacing:1px;">My Properties</div>
        <div id="inventory-container"></div>
    </div>

<script>
    const APP_ID = "poly-lob-v10-"; 
    const CODE_CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    
    const PEER_CONFIG = {
        debug: 1,
        config: {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        }
    };

    const chanceCards = [
        { text: "Advance to Go (Collect $200)", action: "move", target: 0 },
        { text: "Advance to Illinois Ave", action: "move", target: 24 },
        { text: "Advance to St. Charles Place", action: "move", target: 11 },
        { text: "Advance to nearest Utility", action: "nearest_util" },
        { text: "Advance to nearest Railroad", action: "nearest_rr" },
        { text: "Bank pays you dividend of $50", action: "money", amount: 50 },
        { text: "Get Out of Jail Free", action: "keep_jail" },
        { text: "Go Back 3 Spaces", action: "back_3" },
        { text: "Go to Jail", action: "gotojail" },
        { text: "General Repairs: Pay $25/House, $100/Hotel", action: "repairs", house: 25, hotel: 100 },
        { text: "Speeding fine $15", action: "money", amount: -15 },
        { text: "Take a trip to Reading Railroad", action: "move", target: 5 },
        { text: "Advance to Boardwalk", action: "move", target: 39 },
        { text: "Elected Chairman of the Board. Pay each player $50", action: "pay_all", amount: 50 },
        { text: "Your building loan matures. Collect $150", action: "money", amount: 150 }
    ];

    const chestCards = [
        { text: "Advance to Go (Collect $200)", action: "move", target: 0 },
        { text: "Bank error in your favor. Collect $200", action: "money", amount: 200 },
        { text: "Doctor's fees. Pay $50", action: "money", amount: -50 },
        { text: "From sale of stock you get $50", action: "money", amount: 50 },
        { text: "Get Out of Jail Free", action: "keep_jail" },
        { text: "Go to Jail", action: "gotojail" },
        { text: "Grand Opera Night. Collect $50 from every player", action: "collect_all", amount: 50 },
        { text: "Holiday Fund matures. Receive $100", action: "money", amount: 100 },
        { text: "Income tax refund. Collect $20", action: "money", amount: 20 },
        { text: "It is your birthday. Collect $10 from every player", action: "collect_all", amount: 10 },
        { text: "Life insurance matures. Collect $100", action: "money", amount: 100 },
        { text: "Pay hospital fees of $100", action: "money", amount: -100 },
        { text: "Pay school fees of $50", action: "money", amount: -50 },
        { text: "Receive $25 consultancy fee", action: "money", amount: 25 },
        { text: "You are assessed for street repairs. $40/House, $115/Hotel", action: "repairs", house: 40, hotel: 115 },
        { text: "You have won second prize in a beauty contest. Collect $10", action: "money", amount: 10 }
    ];

    const POS = [93.5, 82.2, 74.5, 66.4, 58.2, 50.0, 41.5, 33.6, 25.8, 17.1, 6.5];
    
    const boardMap = [
        { name: "GO", type: "go", top: POS[0], left: POS[0], side: 'bottom' },
        { name: "Mediter. Ave", type: "prop", group: "bg-brown", price: 60, rent: [2,10,30,90,160,250], mortgage: 30, build: 50, owner: null, houses: 0, top: POS[0], left: POS[1], side: 'bottom' },
        { name: "Comm. Chest", type: "chest", top: POS[0], left: POS[2], side: 'bottom' },
        { name: "Baltic Ave", type: "prop", group: "bg-brown", price: 60, rent: [4,20,60,180,320,450], mortgage: 30, build: 50, owner: null, houses: 0, top: POS[0], left: POS[3], side: 'bottom' },
        { name: "Income Tax", type: "tax", cost: 200, top: POS[0], left: POS[4], side: 'bottom' },
        { name: "Reading RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, top: POS[0], left: POS[5], side: 'bottom' },
        { name: "Oriental Ave", type: "prop", group: "bg-lightblue", price: 100, rent: [6,30,90,270,400,550], mortgage: 50, build: 50, owner: null, houses: 0, top: POS[0], left: POS[6], side: 'bottom' },
        { name: "Chance", type: "chance", top: POS[0], left: POS[7], side: 'bottom' },
        { name: "Vermont Ave", type: "prop", group: "bg-lightblue", price: 100, rent: [6,30,90,270,400,550], mortgage: 50, build: 50, owner: null, houses: 0, top: POS[0], left: POS[8], side: 'bottom' },
        { name: "Conn. Ave", type: "prop", group: "bg-lightblue", price: 120, rent: [8,40,100,300,450,600], mortgage: 60, build: 50, owner: null, houses: 0, top: POS[0], left: POS[9], side: 'bottom' },
        { name: "Jail", type: "jail", top: POS[0], left: POS[10], side: 'bottom' },
        
        { name: "St. Charles", type: "prop", group: "bg-pink", price: 140, rent: [10,50,150,450,625,750], mortgage: 70, build: 100, owner: null, houses: 0, top: POS[1], left: POS[10], side: 'left' },
        { name: "Electric Co", type: "prop", group: "bg-gray", price: 150, rent: [0,0,0,0,0,0], mortgage: 75, build: 0, owner: null, houses: 0, top: POS[2], left: POS[10], side: 'left' },
        { name: "States Ave", type: "prop", group: "bg-pink", price: 140, rent: [10,50,150,450,625,750], mortgage: 70, build: 100, owner: null, houses: 0, top: POS[3], left: POS[10], side: 'left' },
        { name: "Virginia Ave", type: "prop", group: "bg-pink", price: 160, rent: [12,60,180,500,700,900], mortgage: 80, build: 100, owner: null, houses: 0, top: POS[4], left: POS[10], side: 'left' },
        { name: "Penn RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, top: POS[5], left: POS[10], side: 'left' },
        { name: "St. James", type: "prop", group: "bg-orange", price: 180, rent: [14,70,200,550,750,950], mortgage: 90, build: 100, owner: null, houses: 0, top: POS[6], left: POS[10], side: 'left' },
        { name: "Comm. Chest", type: "chest", top: POS[7], left: POS[10], side: 'left' },
        { name: "Tennessee", type: "prop", group: "bg-orange", price: 180, rent: [14,70,200,550,750,950], mortgage: 90, build: 100, owner: null, houses: 0, top: POS[8], left: POS[10], side: 'left' },
        { name: "New York", type: "prop", group: "bg-orange", price: 200, rent: [16,80,220,600,800,1000], mortgage: 100, build: 100, owner: null, houses: 0, top: POS[9], left: POS[10], side: 'left' },
        { name: "Free Parking", type: "parking", top: POS[10], left: POS[10], side: 'top' },
        
        { name: "Kentucky", type: "prop", group: "bg-red", price: 220, rent: [18,90,250,700,875,1050], mortgage: 110, build: 150, owner: null, houses: 0, top: POS[10], left: POS[9], side: 'top' },
        { name: "Chance", type: "chance", top: POS[10], left: POS[8], side: 'top' },
        { name: "Indiana", type: "prop", group: "bg-red", price: 220, rent: [18,90,250,700,875,1050], mortgage: 110, build: 150, owner: null, houses: 0, top: POS[10], left: POS[7], side: 'top' },
        { name: "Illinois", type: "prop", group: "bg-red", price: 240, rent: [20,100,300,750,925,1100], mortgage: 120, build: 150, owner: null, houses: 0, top: POS[10], left: POS[6], side: 'top' },
        { name: "B&O RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, top: POS[10], left: POS[5], side: 'top' },
        { name: "Atlantic", type: "prop", group: "bg-yellow", price: 260, rent: [22,110,330,800,975,1150], mortgage: 130, build: 150, owner: null, houses: 0, top: POS[10], left: POS[4], side: 'top' },
        { name: "Ventnor", type: "prop", group: "bg-yellow", price: 260, rent: [22,110,330,800,975,1150], mortgage: 130, build: 150, owner: null, houses: 0, top: POS[10], left: POS[3], side: 'top' },
        { name: "Water Works", type: "prop", group: "bg-gray", price: 150, rent: [0,0,0,0,0,0], mortgage: 75, build: 0, owner: null, houses: 0, top: POS[10], left: POS[2], side: 'top' },
        { name: "Marvin G.", type: "prop", group: "bg-yellow", price: 280, rent: [24,120,360,850,1025,1200], mortgage: 140, build: 150, owner: null, houses: 0, top: POS[10], left: POS[1], side: 'top' },
        { name: "Go To Jail", type: "gotojail", top: POS[10], left: POS[0], side: 'top' },
        
        { name: "Pacific", type: "prop", group: "bg-green", price: 300, rent: [26,130,390,900,1100,1275], mortgage: 150, build: 200, owner: null, houses: 0, top: POS[9], left: POS[0], side: 'right' },
        { name: "N. Carolina", type: "prop", group: "bg-green", price: 300, rent: [26,130,390,900,1100,1275], mortgage: 150, build: 200, owner: null, houses: 0, top: POS[8], left: POS[0], side: 'right' },
        { name: "Comm. Chest", type: "chest", top: POS[7], left: POS[0], side: 'right' },
        { name: "Penn Ave", type: "prop", group: "bg-green", price: 320, rent: [28,150,450,1000,1200,1400], mortgage: 160, build: 200, owner: null, houses: 0, top: POS[6], left: POS[0], side: 'right' },
        { name: "Short Line", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, top: POS[5], left: POS[0], side: 'right' },
        { name: "Chance", type: "chance", top: POS[4], left: POS[0], side: 'right' },
        { name: "Park Place", type: "prop", group: "bg-darkblue", price: 350, rent: [35,175,500,1100,1300,1500], mortgage: 175, build: 200, owner: null, houses: 0, top: POS[3], left: POS[0], side: 'right' },
        { name: "Luxury Tax", type: "tax", cost: 100, top: POS[2], left: POS[0], side: 'right' },
        { name: "Boardwalk", type: "prop", group: "bg-darkblue", price: 400, rent: [50,200,600,1400,1700,2000], mortgage: 200, build: 200, owner: null, houses: 0, top: POS[1], left: POS[0], side: 'right' },
    ];

    let peer;
    let connections = {}; 
    let myId = null; 
    let hostConn = null;
    let heartbeater = null;
    let clientPropState = []; // Holds ownership data on client

    let gameState = {
        players: [], 
        rules: { pot: false, goDouble: false, snake: false, jailRent: true },
        potMoney: 0,
        turnIndex: 0,
        turnPhase: 'ROLLING', 
        pendingProp: null,
        activeCard: null,
        pendingCardAction: null,
        gameStarted: false,
        movedByCard: false 
    };

    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function generateCode() { let r=""; for(let i=0;i<4;i++) r+=CODE_CHARS.charAt(Math.floor(Math.random()*CODE_CHARS.length)); return r; }
    function log(msg) { const d = document.createElement('div'); d.innerText = msg; document.getElementById('game-log').prepend(d); }
    function showError(msg) {
        const t = document.getElementById('error-toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }
    function startHeartbeat(conn) {
        if(heartbeater) clearInterval(heartbeater);
        heartbeater = setInterval(() => { if(conn && conn.open) conn.send({type: 'PING'}); }, 2000); 
    }

    function showJoin() { document.getElementById('main-menu').style.display = 'none'; document.getElementById('join-flow').style.display = 'flex'; }
    function hideJoin() { document.getElementById('join-flow').style.display = 'none'; document.getElementById('main-menu').style.display = 'flex'; }

    // --- AI LOGIC ---
    function addAI() {
        if (gameState.players.length >= 4) return;
        const pId = gameState.players.length;
        const newPlayer = {
            id: pId,
            name: `Bot ${pId + 1}`,
            colorClass: ["p-red", "p-blue", "p-green", "p-yellow"][pId],
            money: 1500, position: 0, jailed: false, jailTurns: 0, getOutCard: 0, isAI: true
        };
        gameState.players.push(newPlayer);
        renderLobbyList();
        broadcastState();
    }

    function processAITurn() {
        const pId = gameState.turnIndex;
        const p = gameState.players[pId];
        if (!p || !p.isAI) return;

        setTimeout(() => {
            if (gameState.turnIndex !== pId) return;

            if (gameState.turnPhase === 'ROLLING') {
                if (p.jailed && p.money >= 600) {
                     handleHostAction(pId, {type: 'PAY_JAIL'});
                } else {
                     handleHostAction(pId, {type: 'ROLL'});
                }
            }
            else if (gameState.turnPhase === 'DECIDING') {
                const sq = boardMap[gameState.pendingProp];
                if (p.money >= sq.price) {
                    handleHostAction(pId, {type: 'BUY'});
                } else {
                    handleHostAction(pId, {type: 'PASS'});
                }
            }
            else if (gameState.turnPhase === 'ACKNOWLEDGING') {
                handleHostAction(pId, {type: 'OK'});
            }
        }, 1500); 
    }

    // --- HOST LOGIC ---
    function initHost() {
        if(typeof Peer === 'undefined') { showError("PeerJS failed to load. Check internet."); return; }
        const code = generateCode();
        switchScreen('lobby-screen');
        document.getElementById('lobby-code').innerText = code;
        peer = new Peer(APP_ID + code, PEER_CONFIG);
        peer.on('error', (err) => {
            if(err.type === 'unavailable-id') { showError("Code collision, restarting..."); setTimeout(initHost, 1000); } 
            else { showError("Host Network Error. Check Internet."); }
        });
        peer.on('connection', handleHostConn);
    }

    function handleHostConn(conn) {
        if(gameState.gameStarted) { conn.close(); return; }
        conn.on('data', (data) => {
            if(data.type === 'JOIN') {
                const pId = gameState.players.length;
                if(pId >= 4) { conn.send({type:'ERROR', msg:'Lobby Full'}); return; }
                const newPlayer = {
                    id: pId, name: data.name || `Player ${pId+1}`,
                    colorClass: ["p-red","p-blue","p-green","p-yellow"][pId],
                    money: 1500, position: 0, jailed: false, jailTurns: 0, getOutCard: 0
                };
                gameState.players.push(newPlayer);
                connections[pId] = conn;
                renderLobbyList();
                conn.send({ type: 'WELCOME', player: newPlayer });
                conn.send({ type: 'LOBBY_UPDATE', players: gameState.players, rules: gameState.rules });
                conn.off('data'); conn.on('data', d => handleHostAction(pId, d));
                setInterval(() => { if(conn.open) conn.send({type:'PING'}); }, 2000);
            }
        });
    }

    function renderLobbyList() {
        const el = document.getElementById('lobby-player-list');
        el.innerHTML = gameState.players.map(p => `<div style="padding:10px; background:rgba(255,255,255,0.1); margin-bottom:5px; border-left:5px solid ${getColorHex(p.colorClass)}">${p.name} ${p.isAI ? '(BOT)' : ''}</div>`).join('');
    }
    function getColorHex(cls) { if(cls==='p-red') return '#e74c3c'; if(cls==='p-blue') return '#3498db'; if(cls==='p-green') return '#2ecc71'; return '#f1c40f'; }

    function startGame() {
        gameState.rules.pot = document.getElementById('rule-pot').checked;
        gameState.rules.goDouble = document.getElementById('rule-go').checked;
        gameState.rules.snake = document.getElementById('rule-snake').checked;
        gameState.rules.jailRent = !document.getElementById('rule-jail').checked; 
        gameState.gameStarted = true;
        switchScreen('host-screen');
        if(gameState.rules.pot) document.getElementById('pot-display').style.display = 'block';
        gameState.players.forEach(p => createToken(p));
        renderGameList();
        broadcastState("Game Started!");
        processAITurn();
    }

    function renderDiceHTML(val) {
        const map = { 1: [4], 2: [0,8], 3: [0,4,8], 4: [0,2,6,8], 5: [0,2,4,6,8], 6: [0,2,3,5,6,8] };
        const dots = map[val] || [];
        let html = '<div class="die">';
        for(let i=0; i<9; i++) {
            if(dots.includes(i)) html += '<div class="pip"></div>';
            else html += '<div></div>';
        }
        html += '</div>';
        return html;
    }

    function showDiceResult(d1, d2) {
        const html = renderDiceHTML(d1) + renderDiceHTML(d2);
        const hostEl = document.getElementById('dice-container-host');
        hostEl.innerHTML = html;
        document.getElementById('dice-overlay').style.display = 'flex';
        Object.values(connections).forEach(c => c.send({type: 'DICE_ANIM', html: html}));
        setTimeout(() => {
            document.getElementById('dice-overlay').style.display = 'none';
            Object.values(connections).forEach(c => c.send({type: 'HIDE_DICE'}));
        }, 2000);
    }

    async function movePlayerSequence(p, steps) {
        const direction = steps > 0 ? 1 : -1;
        const count = Math.abs(steps);
        for(let i=0; i<count; i++) {
            p.position = (p.position + direction + 40) % 40;
            if(direction === 1 && p.position === 0) {
                const sal = gameState.rules.goDouble ? 400 : 200;
                p.money += sal;
                log(`Passed GO. Collect $${sal}`);
            }
            updateToken(p);
            broadcastState();
            await new Promise(r => setTimeout(r, 250));
        }
        handleLanding(p);
    }

    function handleHostAction(pId, action) {
        if(action.type === 'PING') return;
        if(pId !== gameState.turnIndex) return;
        const p = gameState.players[pId];

        if(action.type === 'PAY_JAIL') {
            if(p.money >= 50) {
                p.money -= 50;
                p.jailed = false;
                p.jailTurns = 0;
                if(gameState.rules.pot) { gameState.potMoney += 50; updatePot(); }
                log(`${p.name} paid $50 to leave jail.`);
                gameState.turnPhase = 'ROLLING';
                broadcastState();
                processAITurn();
            }
            return;
        }

        if(action.type === 'ROLL' && gameState.turnPhase === 'ROLLING') {
            const d1 = Math.ceil(Math.random()*6);
            const d2 = Math.ceil(Math.random()*6);
            const total = d1+d2;
            log(`${p.name} rolled ${total}`);
            showDiceResult(d1, d2);

            setTimeout(() => {
                if(d1===1 && d2===1 && gameState.rules.snake) {
                    p.money += 500;
                    log("Snake Eyes! +$500 Bonus");
                }
                if(p.jailed) {
                    if(d1===d2) { 
                        p.jailed = false; p.jailTurns = 0; log("Doubles! Released."); 
                        movePlayerSequence(p, total); 
                    } else {
                        p.jailTurns++;
                        log(`Failed roll. Jail turn ${p.jailTurns}/3.`);
                        if(p.jailTurns >= 3) {
                            log("3rd Fail. Paying $50.");
                            p.money -= 50;
                            if(gameState.rules.pot) { gameState.potMoney += 50; updatePot(); }
                            p.jailed = false; p.jailTurns = 0;
                            movePlayerSequence(p, total);
                        } else {
                            endTurn();
                        }
                    }
                } else {
                    movePlayerSequence(p, total);
                }
            }, 2000);
        }
        else if(action.type === 'BUY') {
            const sq = boardMap[gameState.pendingProp];
            if(p.money >= sq.price) {
                p.money -= sq.price;
                sq.owner = pId;
                addOwnerBar(gameState.pendingProp, p.colorClass);
                log(`Bought ${sq.name}`);
            }
            endTurn();
        }
        else if(action.type === 'PASS') {
            log("Passed property.");
            endTurn();
        }
        else if(action.type === 'OK') {
            closeOverlay();
            if(gameState.pendingCardAction) {
                const card = gameState.pendingCardAction;
                gameState.pendingCardAction = null;
                executeCardAction(p, card);
            } else if(gameState.movedByCard) {
                gameState.movedByCard = false;
                handleLanding(p);
            } else {
                endTurn();
            }
        }
    }

    function executeCardAction(p, card) {
        if(card.action === 'move') {
            let dist = card.target - p.position;
            if(dist < 0) dist += 40;
            gameState.movedByCard = true;
            movePlayerSequence(p, dist); 
        } 
        else if(card.action === 'money') { p.money += card.amount; endTurn(); }
        else if(card.action === 'back_3') { gameState.movedByCard = true; movePlayerSequence(p, -3); }
        else if(card.action === 'gotojail') { 
            p.position = 10; p.jailed = true; p.jailTurns = 0; updateToken(p); log("Sent to Jail!"); endTurn(); 
        }
        else if(card.action === 'nearest_util') {
            let dist = 0;
            if (p.position < 12) dist = 12 - p.position;
            else if (p.position < 28) dist = 28 - p.position;
            else dist = (12 + 40) - p.position;
            gameState.movedByCard = true; movePlayerSequence(p, dist);
        }
        else if(card.action === 'nearest_rr') {
            let dist = 0;
            if (p.position < 5) dist = 5 - p.position;
            else if (p.position < 15) dist = 15 - p.position;
            else if (p.position < 25) dist = 25 - p.position;
            else if (p.position < 35) dist = 35 - p.position;
            else dist = (5 + 40) - p.position;
            gameState.movedByCard = true; movePlayerSequence(p, dist);
        }
        else if(card.action === 'pay_all') {
            gameState.players.forEach(pl => { if(pl.id !== p.id) { p.money -= card.amount; pl.money += card.amount; } });
            endTurn();
        }
        else if(card.action === 'collect_all') {
            gameState.players.forEach(pl => { if(pl.id !== p.id) { pl.money -= card.amount; p.money += card.amount; } });
            endTurn();
        }
        else if(card.action === 'repairs') {
            let cost = 0;
            boardMap.forEach(sq => { if(sq.owner === p.id) { cost += (sq.houses === 5) ? card.hotel : (sq.houses * card.house); } });
            p.money -= cost;
            if(gameState.rules.pot) { gameState.potMoney += cost; updatePot(); }
            endTurn();
        }
        else if(card.action === 'keep_jail') { p.getOutCard++; endTurn(); }
        else { endTurn(); }
        broadcastState();
    }

    function handleLanding(p) {
        const sq = boardMap[p.position];
        log(`Landed on ${sq.name}`);
        if(sq.type === 'prop') {
            if(sq.owner === null) {
                if(p.money >= sq.price) {
                    gameState.turnPhase = 'DECIDING';
                    gameState.pendingProp = p.position;
                    broadcastState();
                    processAITurn();
                } else { log("Can't afford property."); endTurn(); }
            } else if (sq.owner !== p.id) {
                if(gameState.players[sq.owner].jailed && !gameState.rules.jailRent) {
                    log("Owner is jailed. No rent.");
                    endTurn();
                    return;
                }
                const rent = sq.rent[sq.houses];
                p.money -= rent;
                gameState.players[sq.owner].money += rent;
                log(`Paid $${rent} rent.`);
                endTurn();
            } else { endTurn(); }
        }
        else if(sq.type === 'chance' || sq.type === 'chest') { drawCard(p, sq.type); }
        else if(sq.type === 'tax') { payTax(p, sq.cost); endTurn(); }
        else if(sq.type === 'parking') {
            if(gameState.rules.pot && gameState.potMoney > 0) {
                p.money += gameState.potMoney;
                log(`Won Jackpot! $${gameState.potMoney}`);
                gameState.potMoney = 0;
                updatePot();
            }
            endTurn();
        }
        else if(sq.type === 'gotojail') {
            p.position = 10; p.jailed = true; p.jailTurns = 0;
            updateToken(p);
            log("Sent to Jail!");
            endTurn();
        }
        else { endTurn(); }
    }

    function payTax(p, amt) {
        p.money -= amt;
        if(gameState.rules.pot) { gameState.potMoney += amt; updatePot(); log(`Paid $${amt} tax to Pot.`); } 
        else { log(`Paid $${amt} tax.`); }
    }

    function drawCard(p, type) {
        const deck = type === 'chance' ? chanceCards : chestCards;
        const card = deck[Math.floor(Math.random()*deck.length)];
        gameState.turnPhase = 'ACKNOWLEDGING';
        gameState.activeCard = { title: type.toUpperCase(), text: card.text, type: type };
        gameState.pendingCardAction = card;
        showOverlay(card.text, type);
        broadcastState();
        processAITurn();
    }

    function endTurn() {
        gameState.turnPhase = 'ROLLING';
        gameState.pendingProp = null;
        gameState.activeCard = null;
        gameState.turnIndex = (gameState.turnIndex + 1) % gameState.players.length;
        broadcastState();
        processAITurn();
    }

    function createToken(p) {
        const d = document.createElement('div'); d.className=`token ${p.colorClass}`; d.id=`tok-${p.id}`;
        document.getElementById('board-wrapper').appendChild(d);
        updateToken(p);
    }
    function updateToken(p) {
        const sq = boardMap[p.position];
        const el = document.getElementById(`tok-${p.id}`);
        const rX = (Math.random()*1.5)-0.75;
        const rY = (Math.random()*1.5)-0.75;
        el.style.top = (sq.top + rY) + '%'; 
        el.style.left = (sq.left + rX) + '%';
    }
    function addOwnerBar(idx, color) {
        const sq = boardMap[idx];
        const m = document.createElement('div'); 
        m.className = `owner-bar bar-${sq.side} ${color}`;
        m.style.top = (sq.side === 'left' || sq.side === 'right') ? sq.top + '%' : '';
        m.style.left = (sq.side === 'top' || sq.side === 'bottom') ? sq.left + '%' : '';
        document.getElementById('board-wrapper').appendChild(m);
    }
    function updatePot() { document.getElementById('pot-amount').innerText = gameState.potMoney; }
    
    function renderGameList() {
        const el = document.getElementById('game-player-list');
        el.innerHTML = gameState.players.map((p,i) => {
            const border = i===gameState.turnIndex ? '2px solid white' : 'none';
            return `<div style="padding:10px; background:rgba(255,255,255,0.1); margin-bottom:5px; border:${border}; display:flex; justify-content:space-between;">
                <div style="display:flex; gap:5px;"><div style="width:20px; height:20px; background:${getColorHex(p.colorClass)}; border-radius:50%"></div> ${p.name}</div>
                <div style="color:#2ecc71; font-weight:bold;">$${p.money}</div>
            </div>`;
        }).join('');
    }

    function showOverlay(text, type) {
        const ov = document.getElementById('overlay-card');
        const cont = document.getElementById('overlay-card-content');
        document.getElementById('ov-title').innerText = type.toUpperCase();
        document.getElementById('ov-text').innerText = text;
        cont.className = `card-display cd-${type}`;
        ov.style.display = 'flex';
    }
    function closeOverlay() { document.getElementById('overlay-card').style.display = 'none'; }

    function broadcastState(msg) {
        if(msg) log(msg);
        renderGameList();
        
        // Include property ownership data for clients
        const propData = boardMap.map(s => ({owner: s.owner, houses: s.houses}));
        
        const payload = {
            type: 'STATE',
            players: gameState.players,
            turnIndex: gameState.turnIndex,
            turnPhase: gameState.turnPhase,
            activeCard: gameState.activeCard,
            pendingProp: gameState.pendingProp !== null ? boardMap[gameState.pendingProp] : null,
            properties: propData // NEW FIELD
        };
        Object.values(connections).forEach(c => c.send(payload));
    }

    // --- CLIENT ---
    function initPlayer() {
        if(typeof Peer === 'undefined') { showError("PeerJS failed to load. Check internet."); return; }
        const name = document.getElementById('name-input').value.trim();
        const code = document.getElementById('code-input').value.toUpperCase();
        const btn = document.getElementById('btn-connect');
        if(!code) { showError("Please enter room code"); return; }
        btn.innerText = "CONNECTING...";
        peer = new Peer(PEER_CONFIG);
        peer.on('error', (err) => { btn.innerText = "CONNECT"; showError("Connection Failed: " + err.type); });
        peer.on('open', () => {
            hostConn = peer.connect(APP_ID + code, { reliable: true });
            hostConn.on('open', () => { hostConn.send({ type: 'JOIN', name: name || "Player" }); startHeartbeat(hostConn); });
            hostConn.on('error', () => { showError("Could not reach host. Retrying..."); setTimeout(initPlayer, 1000); });
            hostConn.on('data', handleClientData);
            setTimeout(() => { if(!hostConn.open) { showError("Connection timed out. Check code."); btn.innerText = "CONNECT"; } }, 5000);
        });
    }

    function handleClientData(data) {
        if(data.type === 'PING') return;
        if(data.type === 'DICE_ANIM') {
            const el = document.getElementById('dice-container-client');
            el.innerHTML = data.html;
            document.getElementById('client-dice-overlay').style.display = 'flex';
            return;
        }
        if(data.type === 'HIDE_DICE') {
            document.getElementById('client-dice-overlay').style.display = 'none';
            return;
        }

        if(data.type === 'WELCOME') { switchScreen('client-screen'); myId = data.player.id; document.getElementById('c-name').innerText = data.player.name; }
        else if(data.type === 'ERROR') { showError(data.msg); document.getElementById('btn-connect').innerText = "CONNECT"; }
        else if(data.type === 'LOBBY_UPDATE') { document.getElementById('c-status').innerText = "Host is configuring rules..."; }
        else if(data.type === 'STATE') { 
            // Update local ownership cache
            if(data.properties) clientPropState = data.properties;
            updateClientUI(data); 
        }
    }

    function updateClientUI(state) {
        const me = state.players.find(p => p.id === myId);
        document.getElementById('c-balance').innerText = `$${me.money}`;
        const isMyTurn = state.turnIndex === myId;
        const con = document.getElementById('c-controls');
        con.innerHTML = ''; 
        document.getElementById('deed-card').style.display = 'none';
        document.getElementById('client-overlay-card').style.display = 'none';

        // Render Inventory
        renderInventory();

        if(!isMyTurn) { document.getElementById('c-status').innerText = `${state.players[state.turnIndex].name}'s Turn`; return; }
        document.getElementById('c-status').innerText = "YOUR TURN";

        if(state.turnPhase === 'ROLLING') {
            if(me.jailed) {
                con.innerHTML = `
                    <div style="text-align:center; margin-bottom:10px; color:#e74c3c; font-weight:bold;">YOU ARE IN JAIL (Turn ${me.jailTurns}/3)</div>
                    <button class="btn-action btn-red" onclick="send('PAY_JAIL')">PAY $50 TO LEAVE</button>
                    <button class="btn-action btn-green" onclick="send('ROLL')">ROLL FOR DOUBLES</button>
                `;
            } else {
                con.innerHTML = `<button class="btn-action btn-green" onclick="send('ROLL')">ROLL DICE</button>`;
            }
        }
        else if(state.turnPhase === 'DECIDING') {
            const p = state.pendingProp;
            renderDeed(p, 'deed-card');
            document.getElementById('deed-card').style.display = 'block';
            con.innerHTML = `<button class="btn-action btn-green" onclick="send('BUY')">BUY for $${p.price}</button><button class="btn-action btn-blue" onclick="send('PASS')">PASS</button>`;
        }
        else if(state.turnPhase === 'ACKNOWLEDGING') {
            const card = state.activeCard;
            document.getElementById('c-ov-title').innerText = card.title;
            document.getElementById('c-ov-text').innerText = card.text;
            document.getElementById('c-ov-content').className = `card-display cd-${card.type}`;
            document.getElementById('client-overlay-card').style.display = 'flex';
        }
    }

    // --- CLIENT INVENTORY LOGIC ---
    function renderInventory() {
        const container = document.getElementById('inventory-container');
        container.innerHTML = '';
        
        // Group my properties by color
        const myProps = [];
        clientPropState.forEach((pState, index) => {
            if(pState.owner === myId) {
                myProps.push(boardMap[index]);
            }
        });

        if(myProps.length === 0) {
            container.innerHTML = '<div style="color:#666; margin:0 auto;">No properties yet</div>';
            return;
        }

        const groups = {};
        myProps.forEach(p => {
            if(!groups[p.group]) groups[p.group] = [];
            groups[p.group].push(p);
        });

        // Create buttons for each group
        for(const [group, props] of Object.entries(groups)) {
            const btn = document.createElement('div');
            btn.className = `prop-group-btn ${group}`;
            btn.innerHTML = `<div class="prop-badge">${props.length}</div>${getGroupIcon(group)}`;
            btn.onclick = () => openSwipeModal(props);
            container.appendChild(btn);
        }
    }

    function getGroupIcon(group) {
        // Just use color squares or simple text
        return ""; // CSS bg handles color
    }

    function openSwipeModal(props) {
        const cont = document.getElementById('swipe-container');
        cont.innerHTML = '';
        
        props.forEach(p => {
            // Clone deed card structure for swipe
            const wrap = document.createElement('div');
            wrap.className = 'swipe-item';
            
            // Generate deed HTML
            let html = `
                <div style="background:white; color:black; padding:0; width:280px; border:1px solid black; box-shadow:0 0 10px white;">
                    <div class="${p.group}" style="padding:10px; text-align:center; font-weight:bold; color:white; border:2px solid black; margin:5px; text-transform:uppercase;">${p.name}</div>
                    <div style="padding:10px; font-size:0.9rem; text-align:center;">
                        <div style="margin-bottom:5px;">Rent $${p.rent[0]}</div>
                        <div style="display:flex; justify-content:space-between;"><span>1 House</span><span>$${p.rent[1]}</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>2 Houses</span><span>$${p.rent[2]}</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>3 Houses</span><span>$${p.rent[3]}</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>4 Houses</span><span>$${p.rent[4]}</span></div>
                        <div style="display:flex; justify-content:space-between;"><span>HOTEL</span><span>$${p.rent[5]}</span></div>
                        <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
                            Mortgage: $${p.mortgage}<br>Build Cost: $${p.build}
                        </div>
                    </div>
                </div>
            `;
            wrap.innerHTML = html;
            cont.appendChild(wrap);
        });

        document.getElementById('swipe-overlay').style.display = 'flex';
    }

    window.closeSwipe = function() {
        document.getElementById('swipe-overlay').style.display = 'none';
    }

    function renderDeed(prop, elementId) {
        // ... (Existing deed render logic reused in swipe)
        // Kept for buying phase
        const head = document.querySelector(`#${elementId} .deed-header`);
        if(head) {
            head.className = `deed-header ${prop.group}`;
            head.innerText = prop.name;
            document.querySelector(`#${elementId} #r-base`).innerText = `$${prop.rent[0]}`;
            document.querySelector(`#${elementId} #r-1`).innerText = `$${prop.rent[1]}`;
            document.querySelector(`#${elementId} #r-2`).innerText = `$${prop.rent[2]}`;
            document.querySelector(`#${elementId} #r-3`).innerText = `$${prop.rent[3]}`;
            document.querySelector(`#${elementId} #r-4`).innerText = `$${prop.rent[4]}`;
            document.querySelector(`#${elementId} #r-h`).innerText = `$${prop.rent[5]}`;
            document.querySelector(`#${elementId} #r-mort`).innerText = `$${prop.mortgage}`;
            document.querySelector(`#${elementId} #r-build`).innerText = `$${prop.build}`;
            document.querySelector(`#${elementId} #r-price`).innerText = `$${prop.price}`;
        }
    }

    function send(type) { if(hostConn && hostConn.open) hostConn.send({type:type}); }

</script>
</body>
</html>
