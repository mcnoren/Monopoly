<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly: Stable Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #1a1a1a; --primary: #27ae60; --blue: #2980b9; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        button { padding: 20px 40px; font-size: 1.2rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        
        input { padding: 20px; font-size: 1.5rem; text-align: center; border-radius: 8px; border: none; margin: 10px; width: 70%; text-transform: uppercase; }
        
        /* STATUS LOGS */
        #status-log { color: #f1c40f; margin-top: 15px; font-weight: bold; font-family: monospace; text-align: center; padding: 0 20px;}

        /* BOARD STYLES */
        #board-wrapper { width: 95vh; height: 95vh; background: url('monopoly_board.png') center/cover; position: relative; box-shadow: 0 0 50px black; }
        .token { position: absolute; width: 4%; height: 4%; border-radius: 50%; border: 2px solid white; transform: translate(-50%,-50%); transition: all 0.5s; z-index: 10; }
        .owner-strip { position: absolute; width: 5.5%; height: 1.5%; transform: translate(-50%,-50%); z-index: 5; border: 1px solid rgba(255,255,255,0.5); }
        
        /* CARD OVERLAYS */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
        .card-box { background: white; color: black; padding: 30px; border-radius: 15px; text-align: center; width: 300px; animation: pop 0.3s; }
        .cd-chance { border: 15px solid #e67e22; } .cd-chest { border: 15px solid #3498db; }
        .p-red { background: #e74c3c; } .p-blue { background: #3498db; } .p-green { background: #2ecc71; } .p-yellow { background: #f1c40f; }

        @keyframes pop { from{transform:scale(0.5)} to{transform:scale(1)} }
    </style>
</head>
<body>

    <div id="landing" class="screen active">
        <h1>MONOPOLY</h1>
        <button class="btn-green" onclick="initHost()">HOST GAME (TV)</button>
        <button class="btn-blue" onclick="toJoin()">JOIN GAME (PHONE)</button>
    </div>

    <div id="join" class="screen">
        <h2>CONNECT</h2>
        <input type="text" id="j-code" placeholder="CODE" maxlength="4">
        <input type="text" id="j-name" placeholder="NAME" maxlength="10">
        <button class="btn-blue" onclick="attemptConnect()">CONNECT</button>
        <button onclick="location.reload()" style="background:transparent; color:#888;">BACK</button>
        <div id="status-log"></div>
    </div>

    <div id="host" class="screen" style="flex-direction:row; background:#111;">
        <div id="host-overlay" class="overlay">
            <div id="h-card-box" class="card-box">
                <h2 id="h-card-title">CHANCE</h2>
                <p id="h-card-text">...</p>
            </div>
        </div>

        <div style="flex:1; display:flex; justify-content:center; align-items:center;">
            <div id="board-wrapper"></div>
        </div>
        <div style="width:300px; background:#222; padding:20px; display:flex; flex-direction:column;">
            <div style="font-size:2rem; font-weight:bold; color:white; text-align:center;">CODE: <span id="display-code" style="color:#f1c40f">...</span></div>
            <div id="player-list" style="margin-top:20px;"></div>
            <button class="btn-green" id="start-btn" onclick="startGame()" style="width:100%; margin-top:auto;">START</button>
        </div>
    </div>

    <div id="client" class="screen" style="background:#34495e; padding:20px; justify-content: flex-start;">
        <div id="client-overlay" class="overlay">
            <div id="c-card-box" class="card-box">
                <h2 id="c-card-title">CHANCE</h2>
                <p id="c-card-text">...</p>
                <button class="btn-green" onclick="send('OK')">OK</button>
            </div>
        </div>

        <div style="text-align:center; border-bottom:1px solid #aaa; padding-bottom:10px; width:100%;">
            <h1 id="c-disp-name" style="margin:0;">Player</h1>
            <div id="c-balance" style="font-size:3rem; color:#2ecc71; font-weight:bold;">$1500</div>
            <div id="c-status" style="color:#ccc;">Waiting...</div>
        </div>
        
        <div id="c-controls" style="width:100%; margin-top:20px;"></div>
    </div>

<script>
    // --- SETUP ---
    // Random prefix prevents ID collisions on PeerJS servers
    const PREFIX = "poly-stable-" + Math.floor(Math.random() * 1000) + "-"; 
    const CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    
    // PeerJS Objects
    let peer = null;
    let conn = null;
    let myId = null;

    // Game Data
    let players = [];
    let turnIdx = 0;
    let turnPhase = 'ROLLING'; // ROLLING, DECIDING, ACKNOW
    let pendingProp = null;
    let activeCard = null;
    let gameStarted = false;

    // --- BOARD DATA ---
    const board = [
        {name:"GO", type:"go", t:93, l:93},
        {name:"Mediter. Ave", type:"prop", cost:60, group:"p-brown", rent:[2,10,30,90,160,250], owner:null, houses:0, t:93, l:85.5},
        {name:"Comm Chest", type:"chest", t:93, l:77.5},
        {name:"Baltic Ave", type:"prop", cost:60, group:"p-brown", rent:[4,20,60,180,320,450], owner:null, houses:0, t:93, l:69.5},
        {name:"Tax", type:"tax", cost:200, t:93, l:61.5},
        {name:"Reading RR", type:"prop", cost:200, group:"p-black", rent:[25,50,100,200,0,0], owner:null, houses:0, t:93, l:53.5},
        {name:"Oriental Ave", type:"prop", cost:100, group:"p-lblue", rent:[6,30,90,270,400,550], owner:null, houses:0, t:93, l:45.5},
        {name:"Chance", type:"chance", t:93, l:37.5},
        {name:"Vermont Ave", type:"prop", cost:100, group:"p-lblue", rent:[6,30,90,270,400,550], owner:null, houses:0, t:93, l:29.5},
        {name:"Conn Ave", type:"prop", cost:120, group:"p-lblue", rent:[8,40,100,300,450,600], owner:null, houses:0, t:93, l:21.5},
        {name:"Jail", type:"jail", t:93, l:7},
        {name:"St. Charles", type:"prop", cost:140, group:"p-pink", rent:[10,50,150,450,625,750], owner:null, houses:0, t:85.5, l:7},
        {name:"Electric", type:"prop", cost:150, group:"p-gray", rent:[0,0,0,0,0,0], owner:null, houses:0, t:77.5, l:7},
        {name:"States Ave", type:"prop", cost:140, group:"p-pink", rent:[10,50,150,450,625,750], owner:null, houses:0, t:69.5, l:7},
        {name:"Virginia Ave", type:"prop", cost:160, group:"p-pink", rent:[12,60,180,500,700,900], owner:null, houses:0, t:61.5, l:7},
        {name:"Penn RR", type:"prop", cost:200, group:"p-black", rent:[25,50,100,200,0,0], owner:null, houses:0, t:53.5, l:7},
        {name:"St James", type:"prop", cost:180, group:"p-orange", rent:[14,70,200,550,750,950], owner:null, houses:0, t:45.5, l:7},
        {name:"Comm Chest", type:"chest", t:37.5, l:7},
        {name:"Tennessee", type:"prop", cost:180, group:"p-orange", rent:[14,70,200,550,750,950], owner:null, houses:0, t:29.5, l:7},
        {name:"New York", type:"prop", cost:200, group:"p-orange", rent:[16,80,220,600,800,1000], owner:null, houses:0, t:21.5, l:7},
        {name:"Parking", type:"parking", t:7, l:7},
        {name:"Kentucky", type:"prop", cost:220, group:"p-red", rent:[18,90,250,700,875,1050], owner:null, houses:0, t:7, l:21.5},
        {name:"Chance", type:"chance", t:7, l:29.5},
        {name:"Indiana", type:"prop", cost:220, group:"p-red", rent:[18,90,250,700,875,1050], owner:null, houses:0, t:7, l:37.5},
        {name:"Illinois", type:"prop", cost:240, group:"p-red", rent:[20,100,300,750,925,1100], owner:null, houses:0, t:7, l:45.5},
        {name:"B&O RR", type:"prop", cost:200, group:"p-black", rent:[25,50,100,200,0,0], owner:null, houses:0, t:7, l:53.5},
        {name:"Atlantic", type:"prop", cost:260, group:"p-yellow", rent:[22,110,330,800,975,1150], owner:null, houses:0, t:7, l:61.5},
        {name:"Ventnor", type:"prop", cost:260, group:"p-yellow", rent:[22,110,330,800,975,1150], owner:null, houses:0, t:7, l:69.5},
        {name:"Water", type:"prop", cost:150, group:"p-gray", rent:[0,0,0,0,0,0], owner:null, houses:0, t:7, l:77.5},
        {name:"Marvin", type:"prop", cost:280, group:"p-yellow", rent:[24,120,360,850,1025,1200], owner:null, houses:0, t:7, l:85.5},
        {name:"Go To Jail", type:"gotojail", t:7, l:93},
        {name:"Pacific", type:"prop", cost:300, group:"p-green", rent:[26,130,390,900,1100,1275], owner:null, houses:0, t:21.5, l:93},
        {name:"N Carolina", type:"prop", cost:300, group:"p-green", rent:[26,130,390,900,1100,1275], owner:null, houses:0, t:29.5, l:93},
        {name:"Comm Chest", type:"chest", t:37.5, l:93},
        {name:"Penn Ave", type:"prop", cost:320, group:"p-green", rent:[28,150,450,1000,1200,1400], owner:null, houses:0, t:45.5, l:93},
        {name:"Short Line", type:"prop", cost:200, group:"p-black", rent:[25,50,100,200,0,0], owner:null, houses:0, t:53.5, l:93},
        {name:"Chance", type:"chance", t:61.5, l:93},
        {name:"Park Place", type:"prop", cost:350, group:"p-dblue", rent:[35,175,500,1100,1300,1500], owner:null, houses:0, t:69.5, l:93},
        {name:"Lux Tax", type:"tax", cost:100, t:77.5, l:93},
        {name:"Boardwalk", type:"prop", cost:400, group:"p-dblue", rent:[50,200,600,1400,1700,2000], owner:null, houses:0, t:85.5, l:93},
    ];

    const cards = [
        {text:"Advance to GO", action:"move", target:0},
        {text:"Go to Jail", action:"gotojail"},
        {text:"Bank Error: Collect $200", action:"money", amt:200},
        {text:"Doctor's Fee: Pay $50", action:"money", amt:-50},
        {text:"Go Back 3 Spaces", action:"back3"},
        {text:"Speeding Fine $15", action:"money", amt:-15},
        {text:"Advance to Boardwalk", action:"move", target:39}
    ];

    // --- UTILS ---
    function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function genCode() { let r=""; for(let i=0;i<4;i++) r+=CHARS.charAt(Math.floor(Math.random()*CHARS.length)); return r; }
    function log(msg) { document.getElementById('status-log').innerText = msg; }

    // --- HOST LOGIC ---
    function initHost() {
        const code = genCode();
        // IMPORTANT: We use the PREFIX + CODE to generate a unique ID
        const hostId = PREFIX + code; 
        
        show('host');
        document.getElementById('display-code').innerText = "REGISTERING...";

        // Create Host Peer
        peer = new Peer(hostId);

        peer.on('open', (id) => {
            document.getElementById('display-code').innerText = code;
            console.log("Host ID:", id);
        });

        peer.on('connection', (c) => {
            if(gameStarted) { c.close(); return; }
            handleJoin(c);
        });

        peer.on('error', (err) => {
            alert("Host Error: " + err.type);
        });
    }

    function handleJoin(c) {
        if(players.length >= 4) return;
        
        const pId = players.length;
        const meta = c.metadata || {};
        const name = meta.name || "Player " + (pId+1);
        const color = ["p-red","p-blue","p-green","p-yellow"][pId];

        const p = { id:pId, name:name, color:color, money:1500, pos:0, conn:c };
        players.push(p);

        // UI Update
        const el = document.createElement('div');
        el.innerText = name;
        el.style.cssText = `padding:10px; background:#333; margin:5px; border-left:5px solid ${getColor(color)}`;
        document.getElementById('player-list').appendChild(el);
        createToken(p);

        c.on('open', () => {
            c.send({type:'WELCOME', pId:pId});
            broadcastState();
        });
        
        c.on('data', (d) => handleAction(pId, d));
        c.on('close', () => {
             // Handle disconnect (reload page for now)
             alert(name + " disconnected");
             location.reload();
        });
    }

    function createToken(p) {
        const d = document.createElement('div');
        d.className = `token ${p.color}`;
        d.id = `tok-${p.id}`;
        // Initial pos
        d.style.top = "93%"; d.style.left = "93%";
        document.getElementById('board-wrapper').appendChild(d);
        updateTokenPos(p);
    }
    
    function updateTokenPos(p) {
        const sq = board[p.pos];
        const el = document.getElementById(`tok-${p.id}`);
        // Add slight offset based on ID so they don't stack perfectly
        const offset = (p.id * 1.5) - 2; 
        el.style.top = (sq.t + offset) + "%";
        el.style.left = (sq.l + offset) + "%";
    }

    // --- ACCURATE STRIP PLACEMENT ---
    function addStrip(idx, color) {
        const sq = board[idx];
        const s = document.createElement('div');
        let bg = "";
        if(color === 'p-red') bg = '#e74c3c';
        else if(color === 'p-blue') bg = '#3498db';
        else if(color === 'p-green') bg = '#2ecc71';
        else bg = '#f1c40f';

        s.className = 'owner-strip';
        s.style.backgroundColor = bg;

        let t = sq.t; let l = sq.l; let w="5.5%"; let h="1.5%";

        // Logic based on side of board
        if(idx > 0 && idx < 10) { // Bottom
             t -= 6; 
        } else if(idx > 10 && idx < 20) { // Left
             l += 6; w="1.5%"; h="5.5%";
        } else if(idx > 20 && idx < 30) { // Top
             t += 6;
        } else if(idx > 30 && idx < 40) { // Right
             l -= 6; w="1.5%"; h="5.5%";
        }

        s.style.top=t+"%"; s.style.left=l+"%"; s.style.width=w; s.style.height=h;
        document.getElementById('board-wrapper').appendChild(s);
    }

    function startGame() {
        if(players.length < 1) return alert("Wait for players");
        gameStarted = true;
        document.getElementById('start-btn').style.display = 'none';
        broadcastState();
    }

    function handleAction(pId, data) {
        if(pId !== turnIdx) return;
        const p = players[pId];

        if(data.type === 'ROLL' && turnPhase === 'ROLLING') {
            const move = Math.ceil(Math.random()*6) + Math.ceil(Math.random()*6);
            
            // Move Logic
            p.pos += move;
            if(p.pos >= 40) { p.pos -= 40; p.money += 200; } // Pass Go
            updateTokenPos(p);
            
            setTimeout(() => land(p), 1000);
        }
        else if(data.type === 'BUY') {
            const sq = board[pendingProp];
            if(p.money >= sq.cost) {
                p.money -= sq.cost;
                sq.owner = pId;
                addStrip(pendingProp, p.color);
            }
            nextTurn();
        }
        else if(data.type === 'OK' || data.type === 'PASS') {
            document.getElementById('host-overlay').style.display = 'none';
            nextTurn();
        }
    }

    function land(p) {
        const sq = board[p.pos];
        if(sq.type === 'prop') {
            if(sq.owner === null) {
                if(p.money >= sq.cost) {
                    turnPhase = 'DECIDING';
                    pendingProp = p.pos;
                    broadcastState();
                    return;
                }
            } else if(sq.owner !== p.id) {
                // Pay Rent
                const rent = sq.rent[0];
                p.money -= rent;
                players[sq.owner].money += rent;
            }
        }
        else if(sq.type === 'chance' || sq.type === 'chest') {
            // Draw Card
            const card = cards[Math.floor(Math.random()*cards.length)];
            turnPhase = 'ACKNOW';
            activeCard = { title: sq.type.toUpperCase(), text: card.text, type: sq.type };
            
            // Show on Host
            document.getElementById('h-card-title').innerText = activeCard.title;
            document.getElementById('h-card-text').innerText = activeCard.text;
            document.getElementById('h-card-box').className = `card-box cd-${sq.type}`;
            document.getElementById('host-overlay').style.display = 'flex';

            // Apply Effect (Simplified)
            if(card.action === 'move') {
                p.pos = card.target; updateTokenPos(p);
            } else if(card.action === 'money') {
                p.money += card.amt;
            } else if(card.action === 'gotojail') {
                p.pos = 10; updateTokenPos(p);
            } else if(card.action === 'back3') {
                p.pos -= 3; updateTokenPos(p);
            }
            
            broadcastState();
            return;
        }
        else if(sq.type === 'tax') { p.money -= sq.cost; }
        else if(sq.type === 'gotojail') { p.pos = 10; updateTokenPos(p); }
        
        nextTurn();
    }

    function nextTurn() {
        turnPhase = 'ROLLING';
        pendingProp = null;
        activeCard = null;
        turnIdx = (turnIdx + 1) % players.length;
        broadcastState();
    }

    function broadcastState() {
        const cleanPlayers = players.map(pl => ({id:pl.id, name:pl.name, money:pl.money}));
        const data = {
            type: 'STATE',
            players: cleanPlayers,
            turnIdx: turnIdx,
            turnPhase: turnPhase,
            pendingProp: pendingProp !== null ? board[pendingProp] : null,
            activeCard: activeCard
        };
        players.forEach(pl => pl.conn.send(data));
    }

    function getColor(cls) {
        if(cls==='p-red') return '#e74c3c'; if(cls==='p-blue') return '#3498db'; 
        if(cls==='p-green') return '#2ecc71'; return '#f1c40f';
    }

    // --- CLIENT LOGIC ---
    function toJoin() { show('join'); }
    
    function attemptConnect() {
        const code = document.getElementById('j-code').value.toUpperCase();
        const name = document.getElementById('j-name').value || "Player";
        if(code.length !== 4) return alert("Enter 4 letter code");

        log("Connecting to Peer Server...");
        peer = new Peer(); // Client peer

        peer.on('error', (err) => {
             log("Error: " + err.type);
             alert("Connection Failed: " + err.type);
        });

        peer.on('open', (id) => {
            log("Server Connected. Finding Host...");
            // Connect to PREFIX + CODE
            const hostId = PREFIX + code;
            conn = peer.connect(hostId, { metadata: { name: name } });

            // Connection Timeout handler
            const tm = setTimeout(() => {
                if(!conn.open) {
                    log("Host Not Found");
                    alert("Could not find Host with code " + code + ". Make sure you are on the same WiFi.");
                }
            }, 5000);

            conn.on('open', () => {
                clearTimeout(tm);
                log("Connected to Host!");
                show('client');
                document.getElementById('c-disp-name').innerText = name;
            });

            conn.on('data', handleClientData);
            conn.on('close', () => { alert("Host Closed Game"); location.reload(); });
        });
    }

    function handleClientData(d) {
        if(d.type === 'WELCOME') {
            myId = d.pId;
        } else if(d.type === 'STATE') {
            renderClient(d);
        }
    }

    function renderClient(s) {
        const me = s.players.find(p => p.id === myId);
        document.getElementById('c-balance').innerText = "$" + me.money;

        const isTurn = s.turnIdx === myId;
        const con = document.getElementById('c-controls');
        con.innerHTML = "";
        
        // CARD OVERLAY LOGIC
        const ov = document.getElementById('client-overlay');
        if(s.turnPhase === 'ACKNOW') {
            ov.style.display = 'flex';
            document.getElementById('c-card-title').innerText = s.activeCard.title;
            document.getElementById('c-card-text').innerText = s.activeCard.text;
            document.getElementById('c-card-box').className = `card-box cd-${s.activeCard.type}`;
            // Only show OK button if it's my turn
            const btn = ov.querySelector('button');
            btn.style.display = isTurn ? 'inline-block' : 'none';
        } else {
            ov.style.display = 'none';
        }

        if(!isTurn) {
            document.getElementById('c-status').innerText = s.players[s.turnIdx].name + "'s Turn";
            return;
        }
        
        document.getElementById('c-status').innerText = "YOUR TURN";

        if(s.turnPhase === 'ROLLING') {
            con.innerHTML = `<button class="btn-green" onclick="send('ROLL')">ROLL</button>`;
        } else if(s.turnPhase === 'DECIDING') {
            con.innerHTML = `
                <div style="background:white; color:black; padding:10px; border-radius:10px; margin-bottom:10px;">
                    <h3>${s.pendingProp.name}</h3>
                    <p>Price: $${s.pendingProp.cost}</p>
                </div>
                <button class="btn-green" onclick="send('BUY')">BUY</button>
                <button class="btn-blue" onclick="send('PASS')">PASS</button>
            `;
        }
    }

    function send(type) { conn.send({type:type}); }

</script>
</body>
</html>
