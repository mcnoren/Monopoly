<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly: Robust Connect</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #121212; --green: #2ecc71; --blue: #3498db; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; overflow: hidden; height: 100vh; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .active { display: flex; }
        
        button { padding: 15px 30px; font-size: 1.2rem; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin: 10px; width: 80%; max-width: 300px; }
        .btn-green { background: var(--green); color: black; }
        .btn-blue { background: var(--blue); color: white; }
        
        input { padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 8px; border: 2px solid #444; background: #222; color: white; margin: 10px; width: 70%; text-transform: uppercase; }
        
        #debug-log { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px; 
            background: rgba(0,0,0,0.8); color: lime; font-family: monospace; 
            font-size: 0.8rem; overflow-y: auto; padding: 10px; z-index: 9999;
            pointer-events: none; border-top: 1px solid #444;
        }

        /* BOARD */
        #board-container { width: 95vh; height: 95vh; background: url('monopoly_board.jpg') center/cover; position: relative; box-shadow: 0 0 50px black; }
        .token { position: absolute; width: 4.5%; height: 4.5%; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); z-index: 20; transition: all 0.5s; }
        .owner-bar { position: absolute; z-index: 5; border: 1px solid rgba(255,255,255,0.6); box-shadow: 0 0 4px black; }
        
        /* OVERLAYS */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
        .card-box { background: white; color: black; padding: 30px; border-radius: 15px; text-align: center; width: 300px; animation: pop 0.3s; }
        .cd-chance { border: 15px solid #e67e22; } .cd-chest { border: 15px solid #3498db; }
        .dice-box { border: 4px solid white; background: #222; color: white; padding: 20px; border-radius: 20px; text-align: center; min-width: 250px; }
        .dice-val { font-size: 4rem; font-weight: bold; color: var(--green); }

        /* COLORS */
        .p-red { background: #e74c3c; } .p-blue { background: #3498db; } .p-green { background: #2ecc71; } .p-yellow { background: #f1c40f; }

        @keyframes pop { from{transform:scale(0.8)} to{transform:scale(1)} }
    </style>
</head>
<body>

    <div id="debug-log">Debug Log Initialized...</div>

    <div id="landing" class="screen active">
        <h1>MONOPOLY</h1>
        <button class="btn-green" onclick="initHost()">HOST GAME (TV)</button>
        <button class="btn-blue" onclick="show('join')">JOIN GAME (PHONE)</button>
    </div>

    <div id="join" class="screen">
        <h2>CONNECT</h2>
        <input type="text" id="j-code" placeholder="ROOM CODE" maxlength="4">
        <input type="text" id="j-name" placeholder="NAME" maxlength="10">
        <button class="btn-blue" onclick="joinGame()">CONNECT</button>
        <button onclick="location.reload()" style="background:transparent; color:#888;">BACK</button>
    </div>

    <div id="host" class="screen" style="flex-direction:row; background:#111;">
        <div style="flex:1; display:flex; justify-content:center; align-items:center;">
            <div id="board-container"></div>
        </div>
        <div style="width:300px; background:#222; padding:20px; display:flex; flex-direction:column;">
            <div style="text-align:center;">
                <div style="color:#888;">CODE</div>
                <div id="host-code" style="font-size:4rem; font-weight:bold; color:var(--green);">...</div>
            </div>
            <div id="player-list" style="margin-top:20px;"></div>
            <button class="btn-green" id="start-btn" onclick="startGame()" style="width:100%; margin-top:auto;">START</button>
        </div>
        <div id="host-ov-card" class="overlay"><div id="h-card-box" class="card-box"><h2>TITLE</h2><p id="h-card-text">...</p></div></div>
        <div id="host-ov-dice" class="overlay"><div class="dice-box"><h2>ROLLED</h2><div id="h-dice-val" class="dice-val">0</div></div></div>
    </div>

    <div id="client" class="screen" style="background:#34495e; padding:20px; justify-content:flex-start;">
        <div style="text-align:center; border-bottom:1px solid #555; padding-bottom:10px;">
            <h1 id="c-name" style="margin:0;">Player</h1>
            <div id="c-money" style="font-size:3rem; color:var(--green); font-weight:bold;">$1500</div>
            <div id="c-status" style="color:#ccc;">Waiting...</div>
        </div>
        <div id="c-controls" style="margin-top:20px; display:flex; flex-direction:column; align-items:center;"></div>
        <div id="client-ov-card" class="overlay"><div id="c-card-box" class="card-box"><h2>TITLE</h2><p id="c-card-text">...</p><button class="btn-green" onclick="send('OK')">OK</button></div></div>
        <div id="client-ov-dice" class="overlay"><div class="dice-box"><h2>ROLLED</h2><div id="c-dice-val" class="dice-val">0</div></div></div>
    </div>

<script>
    // --- DEBUGGER ---
    function log(msg) {
        const d = document.getElementById('debug-log');
        const line = document.createElement('div');
        line.innerText = `> ${msg}`;
        d.prepend(line);
        console.log(msg);
    }

    // --- CONFIG ---
    // Using a simpler prefix to avoid "Invalid ID" errors
    const APP_ID = "mono-game-" + Math.floor(Math.random() * 999); 
    const CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";

    // --- STATE ---
    let peer, conn, myId;
    let players = [];
    let turnIdx = 0;
    let turnPhase = 'ROLLING';
    let pendingProp = null;
    let activeCard = null;
    let gameStarted = false;

    // --- BOARD MAPPING (Accurate) ---
    // Standard Monopoly: 13.5% corners, ~8.1% spaces.
    // Logic: Bottom (0-10) goes Right to Left. 0=Start(93.5%), 10=End(6.5%)
    const getCoord = (i) => {
        const step = 8.13; const start = 93.5; const end = 6.5;
        if(i<=10) return {t:93.5, l: (i===0?start : i===10?end : start-(i*step)+2)};
        if(i<=20) return {t: (i===20?end : start-((i-10)*step)+2), l:6.5};
        if(i<=30) return {t:6.5, l: (i===30?start : end+((i-20)*step)-2)};
        return {t: end+((i-30)*step)-2, l:93.5};
    };

    const props = [
        "GO","Mediter","Comm","Baltic","Tax","ReadRR","Oriental","Chance","Vermont","Conn",
        "Jail","StChar","Elec","States","Virg","PennRR","StJames","Comm","Tenn","NY",
        "Park","Kent","Chance","Ind","Ill","B&ORR","Atl","Vent","Water","Marv",
        "GoJail","Pac","NC","Comm","Penn","Short","Chance","ParkPl","Tax","Board"
    ];

    const board = props.map((n, i) => {
        const c = getCoord(i);
        let type='prop', cost=0, group='p-black', rent=[0];
        if(n==="GO") type="go";
        else if(n==="Jail") type="jail";
        else if(n==="Park") type="parking";
        else if(n==="GoJail") type="gotojail";
        else if(n.includes("Comm")) type="chest";
        else if(n.includes("Chance")) type="chance";
        else if(n.includes("Tax")) {type="tax"; cost=100;}
        else if(n.includes("RR")||n==="Short") {cost=200; rent=[25];}
        else if(n==="Elec"||n==="Water") {group="p-gray"; cost=150;}
        else {
            if(i<5){group="p-brown";cost=60;} else if(i<10){group="p-blue";cost=100;}
            else if(i<15){group="p-pink";cost=140;} else if(i<20){group="p-orange";cost=180;}
            else if(i<25){group="p-red";cost=220;} else if(i<30){group="p-yellow";cost=260;}
            else if(i<35){group="p-green";cost=300;} else {group="p-blue";cost=350;if(i===39)cost=400;}
            rent=[cost/10]; // Simplified rent
        }
        return {index:i, name:n, type, t:c.t, l:c.l, cost, group, rent, owner:null};
    });

    const cards = [
        {text:"Advance to GO", action:"move", target:0}, {text:"Bank Dividend $50", action:"money", amt:50},
        {text:"Go to Jail", action:"gotojail"}, {text:"Back 3 Spaces", action:"back3"},
        {text:"Pay Poor Tax $15", action:"money", amt:-15}, {text:"Advance to Boardwalk", action:"move", target:39}
    ];

    // --- NAV ---
    function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function genCode() { let r=""; for(let i=0;i<4;i++) r+=CHARS.charAt(Math.floor(Math.random()*CHARS.length)); return r; }
    function getColor(c) { if(c==='p-red') return '#e74c3c'; if(c==='p-blue') return '#3498db'; if(c==='p-green') return '#2ecc71'; return '#f1c40f'; }

    // --- HOST ---
    function initHost() {
        const code = genCode();
        // Create a SIMPLE, UNIQUE ID
        const hostId = "monopoly-" + code; 
        
        show('host');
        document.getElementById('host-code').innerText = code;
        log(`Initializing Host with ID: ${hostId}`);

        peer = new Peer(hostId);

        peer.on('open', (id) => {
            log(`Host Online! ID: ${id}`);
        });

        peer.on('connection', (c) => {
            log(`Incoming connection...`);
            if(gameStarted) { c.close(); return; }
            
            const pid = players.length;
            if(pid >= 4) return;
            
            const name = c.metadata?.name || "Player "+(pid+1);
            const color = ["p-red","p-blue","p-green","p-yellow"][pid];
            const p = {id:pid, name:name, color:color, money:1500, pos:0, conn:c};
            players.push(p);

            // UI
            const div = document.createElement('div');
            div.innerText = name;
            div.style.cssText = `padding:10px; background:#333; margin:5px; border-left:5px solid ${getColor(color)}`;
            document.getElementById('player-list').appendChild(div);
            
            spawnToken(p);
            
            c.on('open', () => {
                log(`${name} connected!`);
                c.send({type:'WELCOME', pid:pid});
                broadcast();
            });
            c.on('data', d => handleAction(pid, d));
            c.on('close', () => log(`${name} disconnected`));
            c.on('error', e => log(`Conn Error: ${e}`));
        });

        peer.on('error', err => log(`Peer Error: ${err.type}`));
    }

    function spawnToken(p) {
        const t = document.createElement('div');
        t.className = `token ${p.color}`; t.id = `tok-${p.id}`;
        const off = (p.id*1.5)-2.25; 
        t.style.marginLeft=off+"%"; t.style.marginTop=off+"%";
        document.getElementById('board-container').appendChild(t);
        moveVisual(p);
    }
    function moveVisual(p) {
        const sq = board[p.pos];
        const t = document.getElementById(`tok-${p.id}`);
        t.style.top = sq.t+"%"; t.style.left = sq.l+"%";
    }

    // --- BAR LOGIC ---
    function addBar(idx, color) {
        const sq = board[idx];
        const b = document.createElement('div');
        b.className = 'owner-bar';
        b.style.backgroundColor = getColor(color);
        let t=sq.t, l=sq.l, w="5.5%", h="1.5%";

        if(idx>0 && idx<10) t -= 5.5; // Bottom row -> Top of square
        else if(idx>10 && idx<20) { l += 5.5; w="1.5%"; h="5.5%"; } // Left row -> Right of square
        else if(idx>20 && idx<30) t += 5.5; // Top row -> Bottom of square
        else if(idx>30 && idx<40) { l -= 5.5; w="1.5%"; h="5.5%"; } // Right row -> Left of square

        b.style.top=t+"%"; b.style.left=l+"%"; b.style.width=w; b.style.height=h;
        b.style.transform="translate(-50%,-50%)";
        document.getElementById('board-container').appendChild(b);
    }

    function startGame() {
        if(players.length < 1) return alert("Need players");
        gameStarted = true;
        document.getElementById('start-btn').style.display='none';
        broadcast();
    }

    function handleAction(pid, d) {
        if(pid !== turnIdx) return;
        const p = players[pid];

        if(d.type === 'ROLL') {
            const r1 = Math.ceil(Math.random()*6);
            const r2 = Math.ceil(Math.random()*6);
            
            // Show dice
            showDice(r1, r2);
            broadcast({type:'DICE', r1, r2});

            setTimeout(() => {
                hideDice();
                broadcast({type:'DICE_HIDE'});
                p.pos += (r1+r2);
                if(p.pos >= 40) { p.pos-=40; p.money+=200; }
                moveVisual(p);
                setTimeout(() => land(p), 800);
            }, 2000);
        }
        else if(d.type === 'BUY') {
            const sq = board[pendingProp];
            if(p.money >= sq.cost) {
                p.money -= sq.cost;
                sq.owner = pid;
                addBar(pendingProp, p.color);
            }
            nextTurn();
        }
        else if(d.type === 'OK' || d.type === 'PASS') {
            document.getElementById('host-ov-card').style.display='none';
            nextTurn();
        }
    }

    function land(p) {
        const sq = board[p.pos];
        if(sq.type === 'prop' || sq.group.includes('p-')) {
            if(sq.owner === null) {
                if(p.money >= sq.cost) {
                    turnPhase = 'DECIDING';
                    pendingProp = p.pos;
                    broadcast();
                    return;
                }
            } else if(sq.owner !== p.id) {
                p.money -= sq.rent[0];
                players[sq.owner].money += sq.rent[0];
            }
        }
        else if(sq.type === 'chance' || sq.type === 'chest') {
            const c = cards[Math.floor(Math.random()*cards.length)];
            turnPhase = 'ACKNOW';
            activeCard = {title:sq.type.toUpperCase(), text:c.text, type:sq.type};
            
            document.getElementById('h-card-text').innerText = c.text;
            document.getElementById('h-card-box').className = `card-box cd-${sq.type}`;
            document.getElementById('host-ov-card').style.display = 'flex';

            if(c.action==='move') { p.pos=c.target; moveVisual(p); }
            else if(c.action==='money') p.money+=c.amt;
            else if(c.action==='gotojail') { p.pos=10; moveVisual(p); }
            else if(c.action==='back3') { p.pos-=3; moveVisual(p); }
            broadcast();
            return;
        }
        else if(sq.type==='tax') p.money-=sq.cost;
        else if(sq.type==='gotojail') { p.pos=10; moveVisual(p); }
        nextTurn();
    }

    function nextTurn() {
        turnPhase = 'ROLLING';
        pendingProp = null;
        activeCard = null;
        turnIdx = (turnIdx + 1) % players.length;
        broadcast();
    }

    function showDice(r1,r2) {
        document.getElementById('h-dice-val').innerText = `${r1} & ${r2}`;
        document.getElementById('host-ov-dice').style.display='flex';
    }
    function hideDice() { document.getElementById('host-ov-dice').style.display='none'; }

    function broadcast(ex) {
        if(ex) players.forEach(p=>p.conn.send(ex));
        const s = {
            type:'STATE', 
            players: players.map(x=>({id:x.id, name:x.name, money:x.money})),
            turnIdx, turnPhase, 
            pendingProp: pendingProp!==null ? board[pendingProp] : null,
            activeCard
        };
        players.forEach(p=>p.conn.send(s));
    }


    // --- CLIENT ---
    function joinGame() {
        const code = document.getElementById('j-code').value.toUpperCase();
        const name = document.getElementById('j-name').value || "Player";
        if(code.length !== 4) return alert("Code?");
        
        log("Initializing Client Peer...");
        peer = new Peer();

        peer.on('error', err => {
            log("Client Peer Error: " + err.type);
        });

        peer.on('open', id => {
            const hostId = "monopoly-" + code;
            log(`Peer Open. Connecting to ${hostId}...`);
            
            conn = peer.connect(hostId, {metadata:{name:name}, reliable:true});
            
            // Connection timeout safety
            setTimeout(() => {
                if(!conn.open) log("Connection taking long... (Check WiFi/Code)");
            }, 3000);

            conn.on('open', () => {
                log("Connected to Host!");
                show('client');
                document.getElementById('c-name').innerText = name;
            });

            conn.on('data', d => {
                if(d.type==='WELCOME') myId = d.pid;
                else if(d.type==='STATE') renderClient(d);
                else if(d.type==='DICE') {
                    document.getElementById('c-dice-val').innerText = `${d.r1} & ${d.r2}`;
                    document.getElementById('client-ov-dice').style.display='flex';
                }
                else if(d.type==='DICE_HIDE') {
                    document.getElementById('client-ov-dice').style.display='none';
                }
            });
            conn.on('close', () => alert("Disconnected from Host"));
            conn.on('error', e => log("Conn Error: " + e));
        });
    }

    function renderClient(s) {
        const me = s.players.find(x=>x.id===myId);
        document.getElementById('c-money').innerText = "$"+me.money;
        
        const isTurn = (s.turnIdx === myId);
        const con = document.getElementById('c-controls');
        con.innerHTML = "";

        // Card Overlay
        const co = document.getElementById('client-ov-card');
        if(s.turnPhase === 'ACKNOW' && s.activeCard) {
            document.getElementById('c-card-text').innerText = s.activeCard.text;
            document.getElementById('c-card-box').className = `card-box cd-${s.activeCard.type}`;
            co.style.display = 'flex';
            co.querySelector('button').style.display = isTurn ? 'inline-block' : 'none';
        } else {
            co.style.display = 'none';
        }

        if(!isTurn) {
            document.getElementById('c-status').innerText = s.players[s.turnIdx].name + "'s Turn";
            return;
        }
        document.getElementById('c-status').innerText = "YOUR TURN";

        if(s.turnPhase === 'ROLLING') {
            con.innerHTML = `<button class="btn-green" onclick="send('ROLL')">ROLL DICE</button>`;
        }
        else if(s.turnPhase === 'DECIDING') {
            const p = s.pendingProp;
            con.innerHTML = `
                <div style="background:white; color:black; padding:20px; border-radius:10px; margin-bottom:20px; text-align:center;">
                    <h3>${p.name}</h3><h2>$${p.cost}</h2>
                </div>
                <button class="btn-green" onclick="send('BUY')">BUY</button>
                <button class="btn-blue" onclick="send('PASS')">PASS</button>
            `;
        }
    }

    function send(t) { conn.send({type:t}); }

</script>
</body>
</html>
