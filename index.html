<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly: Ultimate Host</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --primary: #27ae60;
            --accent: #f1c40f;
            --sidebar-width: 320px;
            /* Defined Colors for CSS Var Usage */
            --brown: #8b4513; --lightblue: #87ceeb; --pink: #ff69b4; --orange: #ffa500;
            --red: #ff0000; --yellow: #ffff00; --green: #008000; --darkblue: #00008b;
            --black: #000000; --gray: #95a5a6;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
        }

        .screen { display: none; width: 100%; height: 100%; }
        .active { display: flex; }

        .btn { padding: 15px; font-size: 1.1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: #3498db; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-purple { background: #9b59b6; color: white; }
        .btn-orange { background: #e67e22; color: white; }
        .btn-text { background: transparent; color: #ccc; padding: 10px; font-size: 1rem; }

        #landing-screen { flex-direction: column; align-items: center; justify-content: center; background: radial-gradient(circle, #2c3e50 0%, #000 100%); }
        #landing-screen h1 { font-size: 4rem; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 5px; }
        .input-std { padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 8px; border:none; width: 280px; margin: 5px 0; display: block;}
        
        .menu-container { display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; }
        #main-menu { display: flex; }
        #join-flow { display: none; flex-direction: column; align-items: center; gap: 10px; }

        #lobby-screen { flex-direction: column; align-items: center; padding: 40px; background: #222; }
        .lobby-container { display: flex; gap: 50px; width: 100%; max-width: 1000px; height: 100%; }
        .lobby-panel { flex: 1; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; display: flex; flex-direction: column; }
        .lobby-title { font-size: 2rem; margin-bottom: 20px; color: var(--accent); border-bottom: 1px solid #444; padding-bottom: 10px; }
        .code-display { font-size: 4rem; color: white; font-weight: 900; vertical-align: middle; margin-left: 15px; letter-spacing: 2px; }
        .rule-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        #host-screen { flex-direction: row; position: relative; }
        #board-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #111; }
        #board-wrapper { height: 95vh; width: 95vh; background-image: url('monopoly_board.jpg'); background-size: cover; border-radius: 5px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; }
        #host-sidebar { width: var(--sidebar-width); background: #2c3e50; display: flex; flex-direction: column; padding: 20px; border-left: 2px solid #444; }
        
        .overlay-layer { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:100; display:none; flex-direction: column; align-items:center; justify-content:center; }
        .card-display { width: 320px; height: 200px; background: white; border-radius: 12px; padding: 20px; text-align: center; display: flex; flex-direction: column; justify-content: center; color: black; animation: popIn 0.3s; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .cd-chance { border: 12px solid #e67e22; } .cd-chest { border: 12px solid #3498db; }
        .cd-title { font-size: 2rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; }
        .cd-text { font-size: 1.2rem; }

        .dice-container { display: flex; gap: 20px; justify-content: center; margin-top: 10px; }
        .die { width: 60px; height: 60px; background: white; border-radius: 10px; display: grid; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr; padding: 6px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }
        .pip { background: black; border-radius: 50%; width: 10px; height: 10px; place-self: center; }
        
        .token { position: absolute; width: 3.5%; height: 3.5%; border-radius: 50%; border: 3px solid white; transform: translate(-50%, -50%); transition: top 0.25s linear, left 0.25s linear; z-index: 20; box-shadow: 2px 2px 4px rgba(0,0,0,0.8); }
        
        .building { position: absolute; z-index: 10; border: 1px solid rgba(0,0,0,0.5); box-shadow: 1px 1px 2px black; }
        .b-house { width: 1.5%; height: 1.5%; background: #2ecc71; }
        .b-hotel { width: 3%; height: 1.5%; background: #e74c3c; }

        .owner-bar { position: absolute; z-index: 5; transition: all 0.3s; }
        .bar-bottom { height: 0.6%; width: 8.1%; bottom: 0; transform: translateX(-50%); }
        .bar-left { height: 8.1%; width: 0.6%; left: 0; top: auto; transform: translateY(-50%); }
        .bar-top { height: 0.6%; width: 8.1%; top: 0; bottom: auto; transform: translateX(-50%); }
        .bar-right { height: 8.1%; width: 0.6%; right: 0; left: auto; transform: translateY(-50%); }
        .pot-display { background: #27ae60; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 1.2rem; }

        #client-screen { flex-direction: column; background: #34495e; padding: 15px; position:relative; overflow: hidden; }
        
        .c-header { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; margin-bottom: 15px; position:relative; }
        .header-left { display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.2rem; }
        .trade-icon-btn { background: none; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; width: 40px; height: 40px; color: white; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; display: none; }
        .trade-icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.1); }
        .c-balance { font-size: 2rem; color: #2ecc71; font-weight: bold; }
        .balance-debt { color: #e74c3c !important; animation: blink 2s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .money-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); padding: 20px 40px; border-radius: 15px; font-size: 3rem; font-weight: 900; color: white; z-index: 1000; animation: popFade 2.5s forwards; text-shadow: 2px 2px 0 #000; pointer-events: none; }
        .mp-gain { background: rgba(39, 174, 96, 0.9); border: 3px solid #2ecc71; }
        .mp-loss { background: rgba(192, 57, 43, 0.9); border: 3px solid #e74c3c; }
        @keyframes popFade { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); } 15% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 25% { transform: translate(-50%, -50%) scale(1); } 75% { opacity: 1; transform: translate(-50%, -50%) scale(1); } 100% { opacity: 0; transform: translate(-50%, -100%) scale(0.8); } }

        .deed-card { background: white; color: black; padding: 0; width: 100%; max-width: 320px; margin: 0 auto; display: none; border: 1px solid black; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .deed-header { background: #333; color: white; padding: 10px; text-align: center; font-weight: bold; text-transform: uppercase; font-size: 1.2rem; border: 2px solid black; margin: 5px; }
        .deed-body { padding: 10px 15px; font-family: 'Arial Narrow', sans-serif; font-size: 0.9rem; text-align: center; }
        .rent-row { display: flex; justify-content: space-between; margin: 5px 0; padding: 2px 5px; }
        .rent-highlight { background-color: #f1c40f; font-weight: bold; border-radius: 4px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .btn-action { width: 100%; padding: 20px; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; border-radius: 10px; border: none; cursor: pointer; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .deed-text-block { margin: 15px 0; font-size: 1rem; line-height: 1.5; }

        #client-main-area { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; position: relative; width: 100%; overflow:hidden; }
        #inventory-grid { display: flex; flex-wrap: wrap; gap: 15px; justify-content: flex-start; align-content: flex-start; width: 100%; max-width: 400px; padding: 10px; overflow-y: auto; }

        .card-stack { width: 100px; height: 140px; background: white; border-radius: 6px; position: relative; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.4); transition: transform 0.1s; border: 1px solid #999; display: flex; flex-direction: column; }
        .card-stack:active { transform: scale(0.95); }
        .card-stack::before { content: ""; position: absolute; top: -3px; left: 3px; width: 100%; height: 100%; background: white; border: 1px solid #999; border-radius: 6px; z-index: -1; }
        .card-stack::after { content: ""; position: absolute; top: -6px; left: 6px; width: 100%; height: 100%; background: white; border: 1px solid #999; border-radius: 6px; z-index: -2; }
        
        .monopoly-glow { box-shadow: 0 0 15px gold; border: 2px solid gold; }
        .monopoly-badge { background: gold; color: black; font-weight: bold; font-size: 0.6rem; text-align: center; padding: 2px; text-transform: uppercase; letter-spacing: 1px; }
        
        .mortgaged-badge { background: #333; color: white; font-weight: bold; font-size: 0.6rem; text-align: center; padding: 2px; text-transform: uppercase; }
        .mortgaged-style { background: repeating-linear-gradient(45deg, #eee, #eee 10px, #ccc 10px, #ccc 20px); opacity: 0.8; }

        .stack-header { height: 25px; border-radius: 5px 5px 0 0; border-bottom: 2px solid black; }
        .stack-body { flex-grow: 1; display: flex; flex-direction: column; padding: 5px; overflow: hidden; }
        .prop-name-mini { font-size: 0.65rem; color: black; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; border-bottom: 1px solid #eee; }

        #swipe-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 500; display: none; flex-direction: column; backdrop-filter: blur(5px); }
        .swipe-header { padding: 20px; display: flex; justify-content: center; align-items: center; color: white; pointer-events: none; }
        .swipe-container { flex-grow: 1; display: flex; overflow-x: auto; scroll-snap-type: x mandatory; align-items: center; padding: 0 25px; gap: 15px; }
        .swipe-item { scroll-snap-align: center; flex: 0 0 auto; width: 300px; display: flex; justify-content: center; pointer-events: auto; position: relative; }
        
        .build-btn-container { margin-top: 10px; width: 100%; display: flex; flex-direction: column; gap: 5px; }
        .ghost-house-indicator { color: #2ecc71; font-weight: bold; margin-top: 5px; animation: pulse 1s infinite; text-shadow: 0 0 5px black; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* TRADE UI */
        #trade-ui { position: absolute; top:0; left:0; width:100%; height:100%; background:#2c3e50; z-index:400; display:none; flex-direction:column; padding:10px; }
        #trade-player-tabs { display:flex; gap:5px; overflow-x:auto; padding-bottom:10px; border-bottom:1px solid #555; margin-bottom:10px; }
        .trade-tab { padding:10px 15px; background:rgba(0,0,0,0.3); border-radius:20px; white-space:nowrap; cursor:pointer; color:#ccc; border:2px solid transparent; font-weight: bold; }
        .trade-tab.active { border-color:white; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        .trade-section { background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px; margin-bottom: 5px; display:flex; flex-direction:column; gap:2px; flex:1; overflow-y:auto; }
        .trade-group-header { padding:5px; font-size:0.8rem; font-weight:bold; color:white; text-transform:uppercase; margin-top:5px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;}
        .trade-group-header span { font-size:0.7rem; background:rgba(255,255,255,0.2); padding:2px 5px; border-radius:4px; }
        .trade-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; margin-left:5px; }
        
        .trade-prop-name { flex-grow:1; font-weight:bold; padding:2px 5px; border-radius:3px; color:black; text-shadow:none; margin-right:10px; }
        .trade-check { transform: scale(1.3); }

        /* ANIMATED TRADE & RENT OVERLAY */
        .tr-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:700; display:none; flex-direction:column; align-items:center; justify-content:center; overflow:hidden; }
        
        .trade-anim-container { display:flex; justify-content:space-between; width:100%; max-width:800px; height:300px; position:relative; align-items:center; }
        .ta-side { width:40%; display:flex; flex-direction:column; align-items:center; color:white; font-weight:bold; font-size:1.5rem; z-index:2; }
        .ta-center { width:20%; display:flex; justify-content:center; align-items:center; font-size:3rem; z-index:2; }
        
        /* New detailed flying cards */
        .flying-card { width:80px; height:110px; background:white; border-radius:6px; border:2px solid black; position:absolute; display:flex; flex-direction:column; box-shadow:0 0 15px rgba(0,0,0,0.7); z-index:1; overflow:hidden; }
        .fc-header { height:20px; width:100%; border-bottom:2px solid black; }
        .fc-body { flex-grow:1; display:flex; align-items:center; justify-content:center; padding:2px; text-align:center; color:black; font-weight:bold; font-size:0.7rem; word-break:break-word; }
        .fc-money { background:#27ae60; color:white; border-color:#2ecc71; }
        .fc-money .fc-body { color:white; font-size:1.2rem; }

        @keyframes flyRight { 0% { left: 10%; opacity:1; transform:scale(1) rotate(0deg); } 50% { transform:scale(1.2) rotate(10deg); } 100% { left: 80%; opacity:0; transform:scale(0.5) rotate(20deg); } }
        @keyframes flyLeft { 0% { right: 10%; opacity:1; transform:scale(1) rotate(0deg); } 50% { transform:scale(1.2) rotate(-10deg); } 100% { right: 80%; opacity:0; transform:scale(0.5) rotate(-20deg); } }

        /* RENT ANIMATION */
        .rent-anim-box { width:100%; display:flex; justify-content:space-between; align-items:center; max-width:600px; font-size:1.5rem; font-weight:bold; position:relative; }
        .rent-money-bag { position:absolute; font-size:3rem; top:-10px; animation: slideRent 2s ease-in-out forwards; }
        @keyframes slideRent { 0% { left:10%; opacity:0; transform:scale(0.5); } 20% { opacity:1; transform:scale(1.2); } 80% { opacity:1; transform:scale(1.2); } 100% { left:85%; opacity:0; transform:scale(0.5); } }

        #error-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 30px; z-index: 1000; font-weight: bold; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .p-red { background: #e74c3c; } .p-blue { background: #3498db; } .p-green { background: #2ecc71; } .p-yellow { background: #f1c40f; }
        
        /* Board Colors (Explicit) */
        .bg-brown { background-color: var(--brown); color: white; } 
        .bg-lightblue { background-color: var(--lightblue); color: black; } 
        .bg-pink { background-color: var(--pink); color: black; }
        .bg-orange { background-color: var(--orange); color: black; } 
        .bg-red { background-color: var(--red); color: white; } 
        .bg-yellow { background-color: var(--yellow); color: black; }
        .bg-green { background-color: var(--green); color: white; } 
        .bg-darkblue { background-color: var(--darkblue); color: white; }
        .bg-black { background-color: black; color: white; } 
        .bg-gray { background-color: #95a5a6; color: black; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>
    <div id="error-toast">Error Message</div>

    <div id="landing-screen" class="screen active">
        <h1>Monopoly</h1>
        <div id="main-menu" class="menu-container">
            <button class="btn btn-green" onclick="initHost()" style="width: 250px;">HOST GAME</button>
            <button class="btn btn-blue" onclick="showJoin()" style="width: 250px;">JOIN GAME</button>
        </div>
        <div id="join-flow" class="menu-container">
            <input type="text" id="name-input" class="input-std" placeholder="NICKNAME" maxlength="12">
            <input type="text" id="code-input" class="input-std input-code" placeholder="ROOM CODE" maxlength="4">
            <button id="btn-connect" class="btn btn-green" onclick="initPlayer()" style="width: 250px;">CONNECT</button>
            <button class="btn btn-text" onclick="hideJoin()">Back</button>
        </div>
    </div>

    <div id="lobby-screen" class="screen">
        <div class="lobby-title">
            GAME LOBBY 
            <span style="font-size: 1rem; color: #888; vertical-align: middle;">CODE:</span>
            <span id="lobby-code" class="code-display"></span>
        </div>
        <div class="lobby-container">
            <div class="lobby-panel">
                <div class="lobby-title" style="font-size: 1.5rem;">House Rules</div>
                <div class="rule-item"><span>Free Parking Jackpot</span><label class="switch"><input type="checkbox" id="rule-pot"><span class="slider"></span></label></div>
                <div class="rule-item"><span>Double Salary on GO ($400)</span><label class="switch"><input type="checkbox" id="rule-go"><span class="slider"></span></label></div>
                <div class="rule-item"><span>Snake Eyes Bonus ($500)</span><label class="switch"><input type="checkbox" id="rule-snake"><span class="slider"></span></label></div>
                <div class="rule-item"><span>No Rent in Jail</span><label class="switch"><input type="checkbox" id="rule-jail"><span class="slider"></span></label></div>
                <div style="margin-top:auto"><button class="btn btn-green" style="width:100%" onclick="startGame()">START GAME</button></div>
            </div>
            <div class="lobby-panel">
                <div class="lobby-title" style="font-size: 1.5rem;">Players Joined</div>
                <div id="lobby-player-list"></div>
                <div style="margin-top:auto; text-align: center;">
                    <button class="btn btn-purple" onclick="addAI()" style="width:100%; margin-bottom:10px;">ADD AI PLAYER</button>
                    <div style="color: #888;">Waiting for players...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="host-screen" class="screen">
        <div id="trade-anim-overlay" class="tr-overlay">
            <div class="tr-title" style="margin-bottom:30px;">TRADE SUCCESSFUL</div>
            <div class="trade-anim-container" id="host-trade-anim-area"></div>
        </div>
        
        <div id="rent-anim-overlay" class="tr-overlay" style="background:rgba(0,0,0,0.8);">
            <div class="tr-title" style="color:#f1c40f; margin-bottom:50px;">RENT PAYMENT</div>
            <div class="rent-anim-box" id="host-rent-anim-area"></div>
        </div>

        <div id="dice-overlay" class="overlay-layer">
            <div style="width:300px; height:150px; background:transparent; display:flex; justify-content:center; align-items:center; flex-direction:column;">
                <div id="dice-container-host" class="dice-container"></div>
            </div>
        </div>
        <div id="overlay-card" class="overlay-layer">
            <div id="overlay-card-content" class="card-display"><div id="ov-title" class="cd-title">CHANCE</div><div id="ov-text" class="cd-text">Text</div></div>
        </div>
        <div id="board-area"><div id="board-wrapper"></div></div>
        <div id="host-sidebar">
            <div class="pot-display" id="pot-display" style="display:none;">POT: $<span id="pot-amount">0</span></div>
            <div class="lobby-title" style="font-size: 1.2rem; border:none; margin:0;">PLAYERS</div>
            <div id="game-player-list" style="flex-grow:1; margin-top:10px;"></div>
            <div id="game-log" style="height:150px; background:rgba(0,0,0,0.2); overflow-y:auto; font-size:0.8rem; padding:5px; border-radius:5px;"></div>
        </div>
    </div>

    <div id="client-screen" class="screen">
        <div id="client-trade-anim-overlay" class="tr-overlay">
            <div class="tr-title" style="margin-bottom:30px;">TRADE SUCCESSFUL</div>
            <div class="trade-anim-container" id="client-trade-anim-area"></div>
        </div>
        
        <div id="client-rent-anim-overlay" class="tr-overlay" style="background:rgba(0,0,0,0.8);">
            <div class="tr-title" style="color:#f1c40f; margin-bottom:50px;">RENT PAYMENT</div>
            <div class="rent-anim-box" id="client-rent-anim-area"></div>
        </div>

        <div id="trade-ui" onclick="if(event.target.id==='trade-ui') closeTrade()">
            <div class="trade-header">TRADE WITH...</div>
            <div id="trade-player-tabs"></div>
            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <div style="flex:1; text-align:center; font-weight:bold; font-size:0.8rem;">YOU GIVE <span id="trade-my-money-disp" style="color:#2ecc71; display:block;"></span></div>
                <div style="flex:1; text-align:center; font-weight:bold; font-size:0.8rem;">YOU GET <span id="trade-their-money-disp" style="color:#2ecc71; display:block;"></span></div>
            </div>
            <div style="display:flex; gap:10px; flex-grow:1;">
                <div class="trade-section" id="trade-give-list"></div>
                <div class="trade-section" id="trade-get-list"></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="number" id="trade-give-money" placeholder="$ Give" style="width:50%; padding:10px;">
                <input type="number" id="trade-get-money" placeholder="$ Get" style="width:50%; padding:10px;">
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-red" style="flex:1" onclick="closeTrade()">CANCEL</button>
                <button class="btn btn-green" style="flex:1" onclick="sendTradeOffer()">SEND OFFER</button>
            </div>
        </div>

        <div id="incoming-trade-overlay" class="overlay-layer" style="z-index: 600;" onclick="closeSwipe(event)">
            <div class="card-display" style="height:auto; min-height:300px;" onclick="event.stopPropagation()">
                <div class="cd-title">TRADE OFFER</div>
                <div id="inc-trade-desc" style="text-align:left; margin:10px 0; font-size:0.9rem;"></div>
                <div style="display:flex; gap:5px; width:100%;">
                    <button class="btn btn-green" style="flex:1" onclick="respondTrade(true)">ACCEPT</button>
                    <button class="btn btn-red" style="flex:1" onclick="respondTrade(false)">DECLINE</button>
                </div>
                <button class="btn btn-blue" style="width:100%; margin-top:5px;" onclick="counterTrade()">COUNTER</button>
            </div>
        </div>

        <div id="swipe-overlay" onclick="closeSwipe(event)">
            <div class="swipe-header"><h2 style="margin:0">MY PROPERTIES</h2></div>
            <div id="swipe-container" class="swipe-container" onclick="closeSwipe(event)"></div>
            <div style="text-align:center; padding:10px; color:#aaa; pointer-events:none;">Swipe to view ‚Ä¢ Tap outside to close</div>
        </div>

        <div id="client-dice-overlay" class="overlay-layer" style="z-index: 300; display:none;">
            <div style="text-align:center;">
                <div style="font-size:2rem; font-weight:bold; margin-bottom:20px;">ROLLED</div>
                <div id="dice-container-client" class="dice-container"></div>
            </div>
        </div>

        <div id="client-overlay-card" class="overlay-layer" style="z-index: 200;" onclick="closeSwipe(event)">
            <div style="display:flex; flex-direction:column; align-items:center;" onclick="event.stopPropagation()">
                <div id="c-ov-content" class="card-display"><div id="c-ov-title" class="cd-title">CHANCE</div><div id="c-ov-text" class="cd-text">Text</div></div>
                <div style="margin-top: 25px;"><button class="btn btn-green" style="padding:15px 40px; font-size:1.5rem; box-shadow:0 0 10px black;" onclick="send('OK')">OK</button></div>
            </div>
        </div>

        <div class="c-header">
            <div class="header-left">
                <button id="trade-btn" class="trade-icon-btn" onclick="openTrade()">ü§ù</button>
                <div id="c-name" style="margin:0">Player</div>
            </div>
            <div class="c-balance-wrap" style="position:relative;"><span id="c-balance" class="c-balance">$1500</span></div>
        </div>
        <div id="c-status" style="text-align:center; color: #bbb; padding-bottom:10px;">Waiting for host...</div>

        <div id="client-main-area" onclick="closeSwipe(event)">
            <div id="deed-card" class="deed-card" onclick="event.stopPropagation()">
                <div id="deed-header" class="deed-header">TITLE</div>
                <div id="deed-body-container"></div>
                <div style="background:black; color:white; text-align:center; padding:5px; font-weight:bold; font-size:1.5rem;">PRICE <span id="r-price">$0</span></div>
            </div>
            <div id="inventory-grid" onclick="event.stopPropagation()"><div style="color:#888;">No properties owned</div></div>
        </div>
        <div id="c-controls" onclick="event.stopPropagation()"></div>
    </div>

<script>
    const APP_ID = "poly-lob-v22-"; 
    const CODE_CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    const PEER_CONFIG = { debug: 1, config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] } };

    // ... (Cards, POS, boardMap are same as previous, abbreviated for length, but assumed full content here)
    const chanceCards = [{text:"Advance to Go ($200)",action:"move",target:0},{text:"Advance to Illinois",action:"move",target:24},{text:"Advance St. Charles",action:"move",target:11},{text:"Nearest Utility",action:"nearest_util"},{text:"Nearest RR",action:"nearest_rr"},{text:"Bank Dividend $50",action:"money",amount:50},{text:"Get Out of Jail",action:"keep_jail"},{text:"Back 3",action:"back_3"},{text:"Go to Jail",action:"gotojail"},{text:"Repairs",action:"repairs",house:25,hotel:100},{text:"Speeding Fine $15",action:"money",amount:-15},{text:"Trip to Reading RR",action:"move",target:5},{text:"Advance Boardwalk",action:"move",target:39},{text:"Pay each $50",action:"pay_all",amount:50},{text:"Collect $150",action:"money",amount:150}];
    const chestCards = [{text:"Advance to Go ($200)",action:"move",target:0},{text:"Bank Error $200",action:"money",amount:200},{text:"Dr Fee $50",action:"money",amount:-50},{text:"Stock Sale $50",action:"money",amount:50},{text:"Get Out of Jail",action:"keep_jail"},{text:"Go to Jail",action:"gotojail"},{text:"Collect $50 from each",action:"collect_all",amount:50},{text:"Fund Matures $100",action:"money",amount:100},{text:"Tax Refund $20",action:"money",amount:20},{text:"Birthday Collect $10",action:"collect_all",amount:10},{text:"Life Ins. $100",action:"money",amount:100},{text:"Hospital $100",action:"money",amount:-100},{text:"School Tax $50",action:"money",amount:-50},{text:"Consultancy $25",action:"money",amount:25},{text:"Street Repairs",action:"repairs",house:40,hotel:115},{text:"Beauty Contest $10",action:"money",amount:10}];
    const POS = [93.5, 82.2, 74.5, 66.4, 58.2, 50.0, 41.5, 33.6, 25.8, 17.1, 6.5];
    const boardMap = [
        { name: "GO", type: "go", top: POS[0], left: POS[0], side: 'bottom' },
        { name: "Mediter. Ave", type: "prop", group: "bg-brown", price: 60, rent: [2,10,30,90,160,250], mortgage: 30, build: 50, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[1], side: 'bottom' },
        { name: "Comm. Chest", type: "chest", top: POS[0], left: POS[2], side: 'bottom' },
        { name: "Baltic Ave", type: "prop", group: "bg-brown", price: 60, rent: [4,20,60,180,320,450], mortgage: 30, build: 50, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[3], side: 'bottom' },
        { name: "Income Tax", type: "tax", cost: 200, top: POS[0], left: POS[4], side: 'bottom' },
        { name: "Reading RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[5], side: 'bottom' },
        { name: "Oriental Ave", type: "prop", group: "bg-lightblue", price: 100, rent: [6,30,90,270,400,550], mortgage: 50, build: 50, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[6], side: 'bottom' },
        { name: "Chance", type: "chance", top: POS[0], left: POS[7], side: 'bottom' },
        { name: "Vermont Ave", type: "prop", group: "bg-lightblue", price: 100, rent: [6,30,90,270,400,550], mortgage: 50, build: 50, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[8], side: 'bottom' },
        { name: "Conn. Ave", type: "prop", group: "bg-lightblue", price: 120, rent: [8,40,100,300,450,600], mortgage: 60, build: 50, owner: null, houses: 0, mortgaged: false, top: POS[0], left: POS[9], side: 'bottom' },
        { name: "Jail", type: "jail", top: POS[0], left: POS[10], side: 'bottom' },
        { name: "St. Charles", type: "prop", group: "bg-pink", price: 140, rent: [10,50,150,450,625,750], mortgage: 70, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[1], left: POS[10], side: 'left' },
        { name: "Electric Co", type: "prop", group: "bg-gray", price: 150, rent: [], mortgage: 75, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[2], left: POS[10], side: 'left' },
        { name: "States Ave", type: "prop", group: "bg-pink", price: 140, rent: [10,50,150,450,625,750], mortgage: 70, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[3], left: POS[10], side: 'left' },
        { name: "Virginia Ave", type: "prop", group: "bg-pink", price: 160, rent: [12,60,180,500,700,900], mortgage: 80, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[4], left: POS[10], side: 'left' },
        { name: "Penn RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[5], left: POS[10], side: 'left' },
        { name: "St. James", type: "prop", group: "bg-orange", price: 180, rent: [14,70,200,550,750,950], mortgage: 90, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[6], left: POS[10], side: 'left' },
        { name: "Comm. Chest", type: "chest", top: POS[7], left: POS[10], side: 'left' },
        { name: "Tennessee", type: "prop", group: "bg-orange", price: 180, rent: [14,70,200,550,750,950], mortgage: 90, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[8], left: POS[10], side: 'left' },
        { name: "New York", type: "prop", group: "bg-orange", price: 200, rent: [16,80,220,600,800,1000], mortgage: 100, build: 100, owner: null, houses: 0, mortgaged: false, top: POS[9], left: POS[10], side: 'left' },
        { name: "Free Parking", type: "parking", top: POS[10], left: POS[10], side: 'top' },
        { name: "Kentucky", type: "prop", group: "bg-red", price: 220, rent: [18,90,250,700,875,1050], mortgage: 110, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[9], side: 'top' },
        { name: "Chance", type: "chance", top: POS[10], left: POS[8], side: 'top' },
        { name: "Indiana", type: "prop", group: "bg-red", price: 220, rent: [18,90,250,700,875,1050], mortgage: 110, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[7], side: 'top' },
        { name: "Illinois", type: "prop", group: "bg-red", price: 240, rent: [20,100,300,750,925,1100], mortgage: 120, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[6], side: 'top' },
        { name: "B&O RR", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[5], side: 'top' },
        { name: "Atlantic", type: "prop", group: "bg-yellow", price: 260, rent: [22,110,330,800,975,1150], mortgage: 130, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[4], side: 'top' },
        { name: "Ventnor", type: "prop", group: "bg-yellow", price: 260, rent: [22,110,330,800,975,1150], mortgage: 130, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[3], side: 'top' },
        { name: "Water Works", type: "prop", group: "bg-gray", price: 150, rent: [], mortgage: 75, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[2], side: 'top' },
        { name: "Marvin G.", type: "prop", group: "bg-yellow", price: 280, rent: [24,120,360,850,1025,1200], mortgage: 140, build: 150, owner: null, houses: 0, mortgaged: false, top: POS[10], left: POS[1], side: 'top' },
        { name: "Go To Jail", type: "gotojail", top: POS[10], left: POS[0], side: 'top' },
        { name: "Pacific", type: "prop", group: "bg-green", price: 300, rent: [26,130,390,900,1100,1275], mortgage: 150, build: 200, owner: null, houses: 0, mortgaged: false, top: POS[9], left: POS[0], side: 'right' },
        { name: "N. Carolina", type: "prop", group: "bg-green", price: 300, rent: [26,130,390,900,1100,1275], mortgage: 150, build: 200, owner: null, houses: 0, mortgaged: false, top: POS[8], left: POS[0], side: 'right' },
        { name: "Comm. Chest", type: "chest", top: POS[7], left: POS[0], side: 'right' },
        { name: "Penn Ave", type: "prop", group: "bg-green", price: 320, rent: [28,150,450,1000,1200,1400], mortgage: 160, build: 200, owner: null, houses: 0, mortgaged: false, top: POS[6], left: POS[0], side: 'right' },
        { name: "Short Line", type: "prop", group: "bg-black", price: 200, rent: [25,50,100,200,0,0], mortgage: 100, build: 0, owner: null, houses: 0, mortgaged: false, top: POS[5], left: POS[0], side: 'right' },
        { name: "Chance", type: "chance", top: POS[4], left: POS[0], side: 'right' },
        { name: "Park Place", type: "prop", group: "bg-darkblue", price: 350, rent: [35,175,500,1100,1300,1500], mortgage: 175, build: 200, owner: null, houses: 0, mortgaged: false, top: POS[3], left: POS[0], side: 'right' },
        { name: "Luxury Tax", type: "tax", cost: 100, top: POS[2], left: POS[0], side: 'right' },
        { name: "Boardwalk", type: "prop", group: "bg-darkblue", price: 400, rent: [50,200,600,1400,1700,2000], mortgage: 200, build: 200, owner: null, houses: 0, mortgaged: false, top: POS[1], left: POS[0], side: 'right' },
    ];

    let peer;
    let connections = {}; 
    let myId = null; 
    let hostConn = null;
    let heartbeater = null;
    let clientPropState = [];
    let clientTurnState = false;

    let gameState = {
        players: [], 
        rules: { pot: false, goDouble: false, snake: false, jailRent: true },
        potMoney: 0,
        turnIndex: 0,
        turnPhase: 'LOBBY', 
        pendingProp: null,
        activeCard: null,
        pendingCardAction: null,
        activeTrade: null,
        tradeNotification: null,
        gameStarted: false,
        movedByCard: false,
        waitingForReRoll: false 
    };

    // ... (Init, Helper functions, same as before) ...
    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function generateCode() { let r=""; for(let i=0;i<4;i++) r+=CODE_CHARS.charAt(Math.floor(Math.random()*CODE_CHARS.length)); return r; }
    function log(msg) { const d = document.createElement('div'); d.innerText = msg; document.getElementById('game-log').prepend(d); }
    function showError(msg) { const t = document.getElementById('error-toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000); }
    function startHeartbeat(conn) { if(heartbeater) clearInterval(heartbeater); heartbeater = setInterval(() => { if(conn && conn.open) conn.send({type: 'PING'}); }, 2000); }
    function showJoin() { document.getElementById('main-menu').style.display = 'none'; document.getElementById('join-flow').style.display = 'flex'; }
    function hideJoin() { document.getElementById('join-flow').style.display = 'none'; document.getElementById('main-menu').style.display = 'flex'; }

    // ... (addAI, initHost, etc. same as before) ...
    function addAI() {
        if (gameState.players.length >= 4) return;
        const pId = gameState.players.length;
        const newPlayer = { id: pId, name: `Bot ${pId + 1}`, colorClass: ["p-red", "p-blue", "p-green", "p-yellow"][pId], money: 1500, position: 0, jailed: false, jailTurns: 0, getOutCard: 0, doublesStreak: 0, isAI: true };
        gameState.players.push(newPlayer);
        renderLobbyList();
        broadcastState();
    }

    // ... (AI Logic same) ...
    function processAITurn() {
        const pId = gameState.turnIndex;
        const p = gameState.players[pId];
        if (!p || !p.isAI) return;
        if(gameState.activeTrade && gameState.activeTrade.to === pId) { processAITradeResponse(pId); return; }
        if(gameState.activeTrade || gameState.turnPhase === 'TRADE_SHOWCASE') return; 
        setTimeout(() => {
            if (gameState.turnIndex !== pId) return;
            if (p.money < 0) {
                const owned = boardMap.findIndex(prop => prop.owner === p.id && !prop.mortgaged);
                if (owned !== -1) { handleHostAction(pId, {type: 'MORTGAGE', propIdx: owned}); }
                return;
            }
            if (gameState.turnPhase === 'ROLLING') {
                if (p.jailed && p.money >= 600) handleHostAction(pId, {type: 'PAY_JAIL'});
                else handleHostAction(pId, {type: 'ROLL'});
            }
            else if (gameState.turnPhase === 'DECIDING') {
                const sq = boardMap[gameState.pendingProp];
                if (p.money >= sq.price) handleHostAction(pId, {type: 'BUY'});
                else handleHostAction(pId, {type: 'PASS'});
            }
            else if (gameState.turnPhase === 'ACKNOWLEDGING') handleHostAction(pId, {type: 'OK'});
            else if (gameState.turnPhase === 'IDLE') handleHostAction(pId, {type: 'END_TURN'});
        }, 1500);
    }

    // ... (Smart Trade AI) ...
    function processAITradeResponse(targetId) {
        const ai = gameState.players[targetId];
        if(!ai || !ai.isAI) return;
        setTimeout(() => {
            const trade = gameState.activeTrade;
            if (trade && trade.to === targetId) {
                if (evaluateTrade(trade, ai)) handleHostAction(targetId, {type: 'TRADE_ACCEPT'});
                else handleHostAction(targetId, {type: 'TRADE_DECLINE'});
            }
        }, 2000); 
    }
    function evaluateTrade(trade, ai) {
        const senderId = trade.from;
        if (ai.money < trade.req.money) return false;
        let valueIn = trade.offer.money;
        let valueOut = trade.req.money;
        trade.offer.props.forEach(idx => { valueIn += getPropStrategicValue(idx, ai.id, senderId); });
        trade.req.props.forEach(idx => { valueOut += getPropStrategicValue(idx, ai.id, senderId, true); });
        return valueIn >= (valueOut * 1.1);
    }
    function getPropStrategicValue(idx, aiId, opponentId, isOutgoing = false) {
        const prop = boardMap[idx];
        const group = prop.group;
        let val = prop.price;
        if (!group) return val; 
        const totalInGroup = boardMap.filter(p => p.group === group).length;
        const aiOwned = boardMap.filter(p => p.group === group && p.owner === aiId).length;
        const oppOwned = boardMap.filter(p => p.group === group && p.owner === opponentId).length;
        if (!isOutgoing) {
            if (aiOwned === totalInGroup - 1) val *= 3.0;
            else if (aiOwned === 0) val *= 1.0; 
            else val *= 1.5; 
        } else {
            if (aiOwned === totalInGroup) val *= 5.0; 
            else if (aiOwned > 1) val *= 1.5;
            if (oppOwned === totalInGroup - 1) val *= 4.0; 
        }
        return val;
    }

    // ... (Host/Client connections - condensed) ...
    function initHost() {
        if(typeof Peer === 'undefined') { showError("PeerJS failed to load."); return; }
        const code = generateCode();
        switchScreen('lobby-screen');
        document.getElementById('lobby-code').innerText = code;
        peer = new Peer(APP_ID + code, PEER_CONFIG);
        peer.on('connection', handleHostConn);
    }
    function handleHostConn(conn) {
        if(gameState.gameStarted) { conn.close(); return; }
        conn.on('data', (data) => {
            if(data.type === 'JOIN') {
                const pId = gameState.players.length;
                if(pId >= 4) { conn.send({type:'ERROR', msg:'Lobby Full'}); return; }
                const newPlayer = { id: pId, name: data.name || `Player ${pId+1}`, colorClass: ["p-red","p-blue","p-green","p-yellow"][pId], money: 1500, position: 0, jailed: false, jailTurns: 0, getOutCard: 0, doublesStreak: 0 };
                gameState.players.push(newPlayer);
                connections[pId] = conn;
                renderLobbyList();
                conn.send({ type: 'WELCOME', player: newPlayer });
                conn.send({ type: 'LOBBY_UPDATE', players: gameState.players, rules: gameState.rules });
                conn.off('data'); conn.on('data', d => handleHostAction(pId, d));
                setInterval(() => { if(conn.open) conn.send({type:'PING'}); }, 2000);
            }
        });
    }
    function renderLobbyList() {
        document.getElementById('lobby-player-list').innerHTML = gameState.players.map(p => `<div style="padding:10px; background:rgba(255,255,255,0.1); margin-bottom:5px; border-left:5px solid ${getColorHex(p.colorClass)}">${p.name} ${p.isAI ? '(BOT)' : ''}</div>`).join('');
    }
    function getColorHex(cls) { if(cls==='p-red') return '#e74c3c'; if(cls==='p-blue') return '#3498db'; if(cls==='p-green') return '#2ecc71'; return '#f1c40f'; }
    function startGame() {
        gameState.rules.pot = document.getElementById('rule-pot').checked;
        gameState.rules.goDouble = document.getElementById('rule-go').checked;
        gameState.rules.snake = document.getElementById('rule-snake').checked;
        gameState.rules.jailRent = !document.getElementById('rule-jail').checked; 
        gameState.gameStarted = true;
        gameState.turnPhase = 'ROLLING'; 
        switchScreen('host-screen');
        if(gameState.rules.pot) document.getElementById('pot-display').style.display = 'block';
        gameState.players.forEach(p => createToken(p));
        renderGameList();
        broadcastState("Game Started!");
        processAITurn();
    }

    // ... (Dice, Token, Board rendering) ...
    function renderDiceHTML(val) {
        const map = { 1: [4], 2: [0,8], 3: [0,4,8], 4: [0,2,6,8], 5: [0,2,4,6,8], 6: [0,2,3,5,6,8] };
        const dots = map[val] || [];
        let html = '<div class="die">';
        for(let i=0; i<9; i++) { html += dots.includes(i) ? '<div class="pip"></div>' : '<div></div>'; }
        html += '</div>';
        return html;
    }
    function showDiceResult(d1, d2) {
        const html = renderDiceHTML(d1) + renderDiceHTML(d2);
        document.getElementById('dice-container-host').innerHTML = html;
        document.getElementById('dice-overlay').style.display = 'flex';
        Object.values(connections).forEach(c => c.send({type: 'DICE_ANIM', html: html}));
        setTimeout(() => {
            document.getElementById('dice-overlay').style.display = 'none';
            Object.values(connections).forEach(c => c.send({type: 'HIDE_DICE'}));
        }, 2000);
    }
    function triggerMoneyAnim(pId, amount) {
        if(amount === 0) return;
        Object.values(connections).forEach(c => c.send({ type: 'MONEY_ANIM', pId: pId, amount: amount }));
        showMoneyAnim(amount, pId); 
    }
    function triggerRentAnim(payerId, receiverId, amount) {
        const payer = gameState.players[payerId].name;
        const receiver = gameState.players[receiverId].name;
        const payload = { type: 'RENT_ANIM', payer: payer, receiver: receiver, amount: amount };
        Object.values(connections).forEach(c => c.send(payload));
        showRentAnim(payload); // Host
    }
    function showMoneyAnim(amount, pId) {
        if(!document.getElementById('host-screen').classList.contains('active')) return;
        const el = document.createElement('div');
        el.className = amount > 0 ? 'money-popup mp-gain' : 'money-popup mp-loss';
        el.innerText = (amount > 0 ? '+' : '') + '$' + amount;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 2500);
    }
    function showRentAnim(data) {
        const area = document.getElementById(document.body.contains(document.getElementById('host-screen')) && document.getElementById('host-screen').classList.contains('active') ? 'host-rent-anim-area' : 'client-rent-anim-area');
        const overlay = area.parentElement;
        area.innerHTML = `
            <div>${data.payer}</div>
            <div class="rent-money-bag">üí∏ $${data.amount}</div>
            <div>${data.receiver}</div>
        `;
        overlay.style.display = 'flex';
        setTimeout(() => { overlay.style.display = 'none'; }, 2500);
    }

    async function movePlayerSequence(p, steps) {
        const direction = steps > 0 ? 1 : -1;
        const count = Math.abs(steps);
        for(let i=0; i<count; i++) {
            p.position = (p.position + direction + 40) % 40;
            if(direction === 1 && p.position === 0) {
                const sal = gameState.rules.goDouble ? 400 : 200;
                p.money += sal;
                triggerMoneyAnim(p.id, sal);
                log(`Passed GO. Collect $${sal}`);
            }
            updateToken(p);
            broadcastState();
            await new Promise(r => setTimeout(r, 250));
        }
        handleLanding(p, Math.abs(steps));
    }

    // --- GAME LOGIC UPDATES ---
    function handleHostAction(pId, action) {
        if(action.type === 'PING') return;
        if(!gameState.gameStarted && action.type !== 'JOIN') return;
        if(pId !== gameState.turnIndex && action.type !== 'TRADE_ACCEPT' && action.type !== 'TRADE_DECLINE' && action.type !== 'TRADE_OFFER') return;
        const p = gameState.players[pId];

        if(action.type === 'BUILD') {
            const cost = action.cost;
            const propsToBuild = action.props; 
            if(p.money >= cost) {
                p.money -= cost;
                triggerMoneyAnim(p.id, -cost);
                propsToBuild.forEach(idx => { if(boardMap[idx].houses < 5) boardMap[idx].houses++; });
                log(`${p.name} built houses/hotels.`);
                broadcastState();
            }
            return;
        }
        if(action.type === 'MORTGAGE') {
            const idx = action.propIdx;
            const prop = boardMap[idx];
            if(prop.owner === pId && !prop.mortgaged && prop.houses === 0) {
                prop.mortgaged = true;
                const amt = prop.mortgage;
                p.money += amt;
                triggerMoneyAnim(p.id, amt);
                log(`${p.name} mortgaged ${prop.name}`);
                broadcastState();
            }
            return;
        }
        // ... (Trade logic updated below)
        if(action.type === 'TRADE_OFFER') {
            gameState.activeTrade = { from: pId, to: parseInt(action.target), offer: action.offer, req: action.req };
            broadcastState();
            processAITradeResponse(gameState.activeTrade.to);
            return;
        }
        if(action.type === 'TRADE_DECLINE') {
            log("Trade Declined");
            gameState.activeTrade = null;
            broadcastState();
            processAITurn();
            return;
        }
        if(action.type === 'TRADE_ACCEPT') {
            const trade = gameState.activeTrade;
            const pFrom = gameState.players[trade.from];
            const pTo = gameState.players[trade.to];
            pFrom.money = pFrom.money - trade.offer.money + trade.req.money;
            pTo.money = pTo.money - trade.req.money + trade.offer.money;
            trade.offer.props.forEach(idx => { boardMap[idx].owner = trade.to; boardMap[idx].houses = 0; boardMap[idx].mortgaged = false; });
            trade.req.props.forEach(idx => { boardMap[idx].owner = trade.from; boardMap[idx].houses = 0; boardMap[idx].mortgaged = false; });
            log("Trade Completed!");
            
            // Build detailed card items for animation
            const buildItems = (props, money) => {
                let items = props.map(i => {
                    const p = boardMap[i];
                    return `<div class="fc-header ${p.group}"></div><div class="fc-body">${p.name}</div>`;
                });
                if(money > 0) items.push(`<div class="fc-money fc-body">$${money}</div>`);
                return items;
            };

            const animData = {
                type: 'TRADE_ANIM',
                leftName: pFrom.name, rightName: pTo.name,
                leftItems: buildItems(trade.offer.props, trade.offer.money),
                rightItems: buildItems(trade.req.props, trade.req.money)
            };
            Object.values(connections).forEach(c => c.send(animData));
            showTradeAnimation(animData);

            if(trade.req.money > 0) { triggerMoneyAnim(trade.from, -trade.req.money); triggerMoneyAnim(trade.to, trade.req.money); }
            if(trade.offer.money > 0) { triggerMoneyAnim(trade.from, trade.offer.money); triggerMoneyAnim(trade.to, -trade.offer.money); }

            gameState.activeTrade = null;
            broadcastState();
            setTimeout(() => { gameState.turnPhase = 'IDLE'; broadcastState(); processAITurn(); }, 6000);
            return;
        }

        if(action.type === 'PAY_JAIL') {
            if(p.money >= 50) {
                p.money -= 50;
                triggerMoneyAnim(p.id, -50);
                p.jailed = false;
                p.jailTurns = 0;
                if(gameState.rules.pot) { gameState.potMoney += 50; updatePot(); }
                log(`${p.name} paid $50 to leave jail.`);
                gameState.turnPhase = 'ROLLING';
                broadcastState();
                processAITurn();
            }
            return;
        }

        if(action.type === 'ROLL' && gameState.turnPhase === 'ROLLING') {
            if(p.money < 0) return;
            const d1 = Math.ceil(Math.random()*6);
            const d2 = Math.ceil(Math.random()*6);
            log(`${p.name} rolled ${d1+d2}`);
            showDiceResult(d1, d2);
            setTimeout(() => {
                if(d1 === d2 && !p.jailed) {
                    p.doublesStreak++;
                    if(p.doublesStreak === 3) {
                        log("3 Doubles! Jail.");
                        p.doublesStreak = 0; gameState.waitingForReRoll = false;
                        p.position = 10; p.jailed = true; p.jailTurns = 0; updateToken(p);
                        gameState.turnPhase = 'IDLE'; broadcastState(); processAITurn();
                        return;
                    }
                    gameState.waitingForReRoll = true; log("Doubles! Roll again.");
                } else { p.doublesStreak = 0; gameState.waitingForReRoll = false; }
                if(d1===1 && d2===1 && gameState.rules.snake) { p.money += 500; triggerMoneyAnim(p.id, 500); log("Snake Eyes! +$500"); }
                
                if(p.jailed) {
                    if(d1===d2) { p.jailed = false; p.jailTurns = 0; movePlayerSequence(p, d1+d2); } 
                    else {
                        p.jailTurns++; log(`Jail turn ${p.jailTurns}/3.`);
                        if(p.jailTurns >= 3) { p.money -= 50; triggerMoneyAnim(p.id, -50); if(gameState.rules.pot) { gameState.potMoney+=50; updatePot(); } p.jailed = false; p.jailTurns = 0; movePlayerSequence(p, d1+d2); }
                        else { gameState.turnPhase = 'IDLE'; broadcastState(); processAITurn(); }
                    }
                } else { movePlayerSequence(p, d1+d2); }
            }, 2000);
        }
        else if(action.type === 'BUY') {
            const sq = boardMap[gameState.pendingProp];
            if(p.money >= sq.price) {
                p.money -= sq.price;
                triggerMoneyAnim(p.id, -sq.price);
                sq.owner = pId;
                log(`Bought ${sq.name}`);
            }
            checkNextPhase();
        }
        else if(action.type === 'PASS') { checkNextPhase(); }
        else if(action.type === 'OK') {
            closeOverlay();
            if(gameState.pendingCardAction) {
                const card = gameState.pendingCardAction; gameState.pendingCardAction = null; executeCardAction(p, card);
            } else if(gameState.movedByCard) {
                gameState.movedByCard = false; handleLanding(p);
            } else { checkNextPhase(); }
        }
        else if(action.type === 'END_TURN') {
            if(p.money < 0) return;
            gameState.turnPhase = 'ROLLING'; gameState.pendingProp = null; gameState.activeCard = null; gameState.waitingForReRoll = false; p.doublesStreak = 0; 
            gameState.turnIndex = (gameState.turnIndex + 1) % gameState.players.length;
            broadcastState(); processAITurn();
        }
    }

    function checkNextPhase() {
        gameState.turnPhase = gameState.waitingForReRoll ? 'ROLLING' : 'IDLE';
        broadcastState(); processAITurn();
    }

    function handleLanding(p, diceTotal = 7) {
        const sq = boardMap[p.position];
        log(`Landed on ${sq.name}`);
        if(sq.type === 'prop') {
            if(sq.owner === null) {
                if(p.money >= sq.price) { gameState.turnPhase = 'DECIDING'; gameState.pendingProp = p.position; broadcastState(); processAITurn(); } 
                else { log("Can't afford property."); checkNextPhase(); }
            } else if (sq.owner !== p.id) {
                if (sq.mortgaged) { log("Mortgaged. No rent."); }
                else if(gameState.players[sq.owner].jailed && !gameState.rules.jailRent) { log("Owner jailed. No rent."); } 
                else {
                    let rent = 0;
                    if(sq.group === 'bg-gray') { 
                        const ownerProps = boardMap.filter(s => s.group === 'bg-gray' && s.owner === sq.owner && !s.mortgaged).length;
                        rent = (ownerProps === 2 ? 10 : 4) * diceTotal;
                        log(`Utility Rent: $${rent}`);
                    } else if (sq.group === 'bg-black') { 
                        const ownerProps = boardMap.filter(s => s.group === 'bg-black' && s.owner === sq.owner && !s.mortgaged).length;
                        rent = sq.rent[ownerProps - 1] || 0;
                    } else { 
                        rent = sq.rent[sq.houses];
                        const groupProps = boardMap.filter(s => s.group === sq.group);
                        if(sq.houses === 0 && groupProps.every(s => s.owner === sq.owner)) { rent *= 2; log("Monopoly! Rent doubled."); }
                    }
                    
                    p.money -= rent;
                    gameState.players[sq.owner].money += rent;
                    triggerRentAnim(p.id, sq.owner, rent);
                    log(`Paid $${rent} rent.`);
                }
                checkNextPhase();
            } else { checkNextPhase(); }
        }
        else if(sq.type === 'chance' || sq.type === 'chest') { drawCard(p, sq.type); }
        else if(sq.type === 'tax') { payTax(p, sq.cost); checkNextPhase(); }
        else if(sq.type === 'parking') {
            if(gameState.rules.pot && gameState.potMoney > 0) { p.money += gameState.potMoney; triggerMoneyAnim(p.id, gameState.potMoney); gameState.potMoney = 0; updatePot(); }
            checkNextPhase();
        }
        else if(sq.type === 'gotojail') { p.position = 10; p.jailed = true; p.jailTurns = 0; updateToken(p); gameState.waitingForReRoll = false; checkNextPhase(); }
        else { checkNextPhase(); }
    }

    // ... (Helper functions: payTax, drawCard, createToken, updateToken, addOwnerBar, updatePot, renderBuildings, renderGameList, showOverlay, broadcastState) ...
    // These functions remain similar but ensure renderOwnerBars is called in broadcastState
    function renderOwnerBars() {
        document.querySelectorAll('.owner-bar').forEach(el => el.remove());
        boardMap.forEach((sq, idx) => {
            if(sq.owner !== null && sq.type === 'prop') {
                const p = gameState.players[sq.owner];
                const m = document.createElement('div'); 
                m.className = `owner-bar bar-${sq.side} ${p.colorClass}`;
                m.style.top = (sq.side === 'left' || sq.side === 'right') ? sq.top + '%' : '';
                m.style.left = (sq.side === 'top' || sq.side === 'bottom') ? sq.left + '%' : '';
                document.getElementById('board-wrapper').appendChild(m);
            }
        });
    }
    function renderBuildings() {
        document.querySelectorAll('.building').forEach(el => el.remove());
        boardMap.forEach((sq, idx) => {
            if(sq.houses > 0) {
                const count = sq.houses; const isHotel = count === 5; const bType = isHotel ? 'b-hotel' : 'b-house';
                let baseTop = sq.top; let baseLeft = sq.left;
                if(sq.side === 'bottom') baseTop -= 5; if(sq.side === 'top') baseTop += 5; if(sq.side === 'left') baseLeft += 5; if(sq.side === 'right') baseLeft -= 5;
                if(isHotel) { const h = document.createElement('div'); h.className = `building ${bType}`; h.style.top = baseTop + '%'; h.style.left = baseLeft + '%'; document.getElementById('board-wrapper').appendChild(h); } 
                else { for(let i=0; i<count; i++) { const h = document.createElement('div'); h.className = `building ${bType}`; let offX = (i%2) * 2 - 1; let offY = Math.floor(i/2) * 2 - 1; h.style.top = (baseTop + offY) + '%'; h.style.left = (baseLeft + offX) + '%'; document.getElementById('board-wrapper').appendChild(h); } }
            }
        });
    }
    function broadcastState(msg) {
        if(msg) log(msg); renderGameList(); renderBuildings(); renderOwnerBars();
        const propData = boardMap.map(s => ({owner: s.owner, houses: s.houses, mortgaged: s.mortgaged}));
        const payload = { type: 'STATE', players: gameState.players, turnIndex: gameState.turnIndex, turnPhase: gameState.turnPhase, activeCard: gameState.activeCard, pendingProp: gameState.pendingProp !== null ? boardMap[gameState.pendingProp] : null, properties: propData, activeTrade: gameState.activeTrade, tradeNotification: gameState.tradeNotification };
        Object.values(connections).forEach(c => c.send(payload));
    }

    function showTradeAnimation(data) {
        const overlay = document.getElementById('trade-anim-overlay');
        const container = document.getElementById('host-trade-anim-area');
        container.innerHTML = `<div class="ta-side">${data.leftName}</div><div class="ta-center">ü§ù</div><div class="ta-side">${data.rightName}</div>`;
        data.leftItems.forEach((itemHTML, i) => { const card = document.createElement('div'); card.className = 'flying-card'; card.innerHTML = itemHTML; card.style.animation = `flyRight 2s forwards ${i*0.2}s`; container.appendChild(card); });
        data.rightItems.forEach((itemHTML, i) => { const card = document.createElement('div'); card.className = 'flying-card'; card.innerHTML = itemHTML; card.style.animation = `flyLeft 2s forwards ${i*0.2}s`; container.appendChild(card); });
        overlay.style.display = 'flex'; setTimeout(() => { overlay.style.display = 'none'; }, 5500);
    }

    // --- CLIENT: handleClientData ---
    // (Only changed parts)
    function handleClientData(data) {
        if(data.type === 'PING') return;
        if(data.type === 'DICE_ANIM') { if(clientTurnState) { document.getElementById('dice-container-client').innerHTML = data.html; document.getElementById('client-dice-overlay').style.display = 'flex'; } return; }
        if(data.type === 'HIDE_DICE') { document.getElementById('client-dice-overlay').style.display = 'none'; return; }
        if(data.type === 'MONEY_ANIM') { if(myId === data.pId) showMoneyAnim(data.amount); return; }
        if(data.type === 'RENT_ANIM') { showRentAnim(data); return; } // NEW
        if(data.type === 'TRADE_ANIM') {
            const overlay = document.getElementById('client-trade-anim-overlay');
            const container = document.getElementById('client-trade-anim-area');
            container.innerHTML = `<div class="ta-side">${data.leftName}</div><div class="ta-center">ü§ù</div><div class="ta-side">${data.rightName}</div>`;
            data.leftItems.forEach((itemHTML, i) => { const card = document.createElement('div'); card.className = 'flying-card'; card.innerHTML = itemHTML; card.style.animation = `flyRight 2s forwards ${i*0.2}s`; container.appendChild(card); });
            data.rightItems.forEach((itemHTML, i) => { const card = document.createElement('div'); card.className = 'flying-card'; card.innerHTML = itemHTML; card.style.animation = `flyLeft 2s forwards ${i*0.2}s`; container.appendChild(card); });
            overlay.style.display = 'flex'; setTimeout(() => { overlay.style.display = 'none'; }, 5500);
            return;
        }
        if(data.type === 'WELCOME') { switchScreen('client-screen'); myId = data.player.id; document.getElementById('c-name').innerText = data.player.name; lastBalance = data.player.money; }
        else if(data.type === 'STATE') { if(data.properties) clientPropState = data.properties; gameState.players = data.players; gameState.activeTrade = data.activeTrade; gameState.tradeNotification = data.tradeNotification; updateClientUI(data); }
    }

    // --- CLIENT UI & HELPER FUNCTIONS ---
    // (createToken, updateToken, addOwnerBar, updatePot, initPlayer, showMoneyAnim, updateClientUI, renderInventory, openSwipeModal, initBuildSequence, send, etc. remain structurally same but integrate new features)
</script>
</body>
</html>
