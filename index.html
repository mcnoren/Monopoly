<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly: Perfect Sync</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --bg: #121212; --green: #2ecc71; --blue: #3498db; --red: #e74c3c; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: white; font-family: 'Segoe UI', system-ui, sans-serif; 
            margin: 0; overflow: hidden; height: 100vh; width: 100vw;
        }

        /* --- SCREEN MANAGEMENT --- */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .active { display: flex; }
        .center { align-items: center; justify-content: center; }

        /* --- BUTTONS & INPUTS --- */
        button {
            padding: 15px 30px; font-size: 1.2rem; border-radius: 12px; border: none; 
            font-weight: 800; cursor: pointer; margin: 10px; width: 85%; max-width: 350px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        .btn-green { background: var(--green); color: #000; }
        .btn-blue { background: var(--blue); color: #fff; }
        
        input { 
            padding: 15px; font-size: 1.5rem; text-align: center; border-radius: 10px; 
            border: 2px solid #333; background: #222; color: white; margin: 10px; 
            width: 80%; text-transform: uppercase; font-weight: bold; letter-spacing: 2px;
        }

        /* --- BOARD (HOST) --- */
        #board-container { 
            position: relative; 
            width: 95vh; height: 95vh; 
            background: url('monopoly_board.jpg') center/cover; /* Ensure your file is named exactly this */
            box-shadow: 0 0 50px black; border-radius: 4px; 
        }
        
        /* --- TOKENS & BARS --- */
        .token { 
            position: absolute; width: 4.5%; height: 4.5%; border-radius: 50%; 
            border: 3px solid white; transform: translate(-50%, -50%); 
            z-index: 20; box-shadow: 3px 3px 6px rgba(0,0,0,0.8); transition: top 0.6s cubic-bezier(0.25, 1, 0.5, 1), left 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }
        
        .owner-bar {
            position: absolute; z-index: 5;
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.6);
            /* Positioning logic handled in JS */
        }

        /* --- OVERLAYS --- */
        .overlay {
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.92); z-index: 100; 
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .card-box {
            background: white; color: black; padding: 40px; border-radius: 15px; 
            text-align: center; width: 90%; max-width: 400px; 
            animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 50px rgba(255,255,255,0.1);
            position: relative;
        }
        .cd-chance { border: 15px solid #e67e22; }
        .cd-chest { border: 15px solid #3498db; }
        
        .dice-box {
            background: #222; color: white; border: 4px solid white; 
            padding: 30px; border-radius: 20px; text-align: center; min-width: 250px;
            animation: popUp 0.2s;
        }
        .dice-val { font-size: 5rem; font-weight: bold; color: var(--green); margin: 10px 0; }
        
        /* --- PLAYER COLORS --- */
        .p-red { background: #e74c3c; } .p-blue { background: #3498db; }
        .p-green { background: #2ecc71; } .p-yellow { background: #f1c40f; }

        @keyframes popUp { from{transform: scale(0.8); opacity:0;} to{transform: scale(1); opacity:1;} }
    </style>
</head>
<body>

    <div id="screen-landing" class="screen active center" style="background: radial-gradient(#2c3e50, #000);">
        <h1 style="font-size: 4rem; margin-bottom: 20px; letter-spacing: 5px;">MONOPOLY</h1>
        <button class="btn-green" onclick="setupHost()">HOST GAME (TV)</button>
        <button class="btn-blue" onclick="setupJoin()">JOIN GAME (PHONE)</button>
    </div>

    <div id="screen-join" class="screen center">
        <h2 style="color: #aaa;">CONNECT</h2>
        <input type="text" id="inp-code" placeholder="ROOM CODE" maxlength="4">
        <input type="text" id="inp-name" placeholder="YOUR NAME" maxlength="8">
        <div id="join-status" style="height: 30px; color: var(--f1c40f); font-weight: bold; margin-top: 10px;"></div>
        <button class="btn-blue" onclick="joinGame()">CONNECT</button>
        <button onclick="location.reload()" style="background:none; color:#555; margin-top:20px;">BACK</button>
    </div>

    <div id="screen-host" class="screen" style="flex-direction: row; background: #111;">
        <div class="center" style="flex: 1;">
            <div id="board-container">
                </div>
        </div>
        <div style="width: 320px; background: #222; border-left: 2px solid #333; padding: 20px; display: flex; flex-direction: column;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="color: #888; font-size: 0.9rem;">ROOM CODE</div>
                <div id="host-code" style="font-size: 4rem; font-weight: 900; color: var(--green); letter-spacing: 5px;">...</div>
            </div>
            <div id="host-player-list" style="flex: 1; display:flex; flex-direction:column; gap:10px;"></div>
            <button id="btn-start" class="btn-green" onclick="startGame()" style="width: 100%;">START GAME</button>
        </div>
        
        <div id="ov-host-card" class="overlay">
            <div id="host-card-box" class="card-box">
                <h2 id="hc-title" style="font-size: 2.5rem; margin:0;">TITLE</h2>
                <p id="hc-text" style="font-size: 1.5rem; margin: 20px 0;">Text</p>
            </div>
        </div>
        <div id="ov-host-dice" class="overlay">
            <div class="dice-box">
                <h2>ROLLED</h2>
                <div id="host-dice-val" class="dice-val">0 & 0</div>
            </div>
        </div>
    </div>

    <div id="screen-client" class="screen" style="background: #2c3e50; padding: 20px; justify-content: flex-start;">
        <div id="ov-client-card" class="overlay" style="z-index: 200;">
            <div id="client-card-box" class="card-box">
                <h2 id="cc-title" style="font-size: 2rem; margin:0;">TITLE</h2>
                <p id="cc-text" style="font-size: 1.3rem; margin: 20px 0;">Text</p>
                <button class="btn-green" onclick="send('OK')">OK</button>
            </div>
        </div>
        <div id="ov-client-dice" class="overlay" style="z-index: 200;">
            <div class="dice-box">
                <h2>ROLLED</h2>
                <div id="client-dice-val" class="dice-val">0 & 0</div>
            </div>
        </div>

        <div style="text-align: center; border-bottom: 1px solid #ffffff20; padding-bottom: 20px; margin-bottom: 20px;">
            <h1 id="c-name" style="margin: 0; font-size: 2.5rem;">Player</h1>
            <div id="c-money" style="font-size: 3.5rem; font-weight: bold; color: var(--green); margin: 5px 0;">$1500</div>
            <div id="c-status" style="color: #aaa; font-style: italic;">Waiting for game...</div>
        </div>
        
        <div id="c-controls" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            </div>
    </div>

<script>
    // --- CONFIG ---
    const APP_ID = "poly-final-v3-"; 
    const CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    
    // --- STATE ---
    let peer, conn, myId;
    let players = [];
    let turnIdx = 0;
    let turnPhase = 'ROLLING'; 
    let pendingProp = null;
    let activeCard = null;
    let gameStarted = false;

    // --- ACCURATE BOARD MAPPING ---
    // Standard Monopoly is a 10x10 grid (not counting corners)
    // Corners are approx 13.5% width. Spaces are approx 8.1% width.
    // We calculate percentages dynamically to match the image exactly.
    
    // Helper to get center % for a specific index 1-9 (between corners)
    // Start is 13.5% from edge, End is 86.5% from edge. 
    // The play area is 73%. Divided by 9 spaces = 8.11% per space.
    // Index 1 center = 13.5 + (8.11 * 0.5) = ~17.5%? No, let's reverse for bottom row.
    // Bottom Row: Right (Index 0) to Left. 
    // 0 is Corner (93.5%). 10 is Corner (6.5%). 
    // Spaces 1-9: 
    // 1: 85.5%, 2: 77.4%, 3: 69.3%, 4: 61.2%, 5: 53.1%, 6: 45.0%, 7: 36.9%, 8: 28.8%, 9: 20.7%
    
    const step = 8.13;
    const corner = 6.5;
    const start = 93.5;
    
    // Generate Coordinates
    const getCoord = (idx) => {
        // Bottom (0-10)
        if (idx >= 0 && idx <= 10) {
            const t = 93.5;
            if (idx === 0) return { t, l: start };
            if (idx === 10) return { t, l: corner };
            return { t, l: start - (idx * step) + 2 }; // +2 manual tweak for image alignment
        }
        // Left (11-20)
        if (idx >= 11 && idx <= 20) {
            const l = 6.5;
            const pos = idx - 10;
            if (idx === 20) return { t: corner, l };
            return { t: start - (pos * step) + 2, l };
        }
        // Top (21-30)
        if (idx >= 21 && idx <= 30) {
            const t = 6.5;
            const pos = idx - 20;
            if (idx === 30) return { t, l: start };
            return { t, l: corner + (pos * step) - 2 };
        }
        // Right (31-39)
        if (idx >= 31 && idx < 40) {
            const l = 93.5;
            const pos = idx - 30;
            return { t: corner + (pos * step) - 2, l };
        }
        return { t: 50, l: 50 };
    };

    // Build the board map
    const props = [
        "GO","Mediter","Comm","Baltic","Tax","Reading","Oriental","Chance","Vermont","Conn",
        "Jail","St.Char","Electric","States","Virginia","PennRR","St.James","Comm","Tenn","NY",
        "Parking","Kentucky","Chance","Indiana","Illinois","B&O","Atlantic","Ventnor","Water","Marvin",
        "GoJail","Pacific","NC","Comm","Penn","Short","Chance","Park","Tax","Boardwalk"
    ];

    const board = props.map((name, i) => {
        const c = getCoord(i);
        // Add game data
        let type = 'prop';
        let group = 'p-black';
        let cost = 0;
        let rent = [0];

        if(name==="GO") type="go";
        else if(name==="Jail") type="jail";
        else if(name==="Parking") type="parking";
        else if(name==="GoJail") type="gotojail";
        else if(name.includes("Comm")) type="chest";
        else if(name.includes("Chance")) type="chance";
        else if(name.includes("Tax")) { type="tax"; cost=100; } // Simplified Tax
        else if(name.includes("RR") || name==="Short") { group="p-black"; cost=200; rent=[25]; }
        else if(name.includes("Electric") || name.includes("Water")) { group="p-gray"; cost=150; type='prop'; }
        else {
            // Colors
            if(i<5) { group="p-brown"; cost=60; rent=[2]; }
            else if(i<10) { group="p-blue"; cost=100; rent=[6]; }
            else if(i<15) { group="p-pink"; cost=140; rent=[10]; }
            else if(i<20) { group="p-orange"; cost=180; rent=[14]; }
            else if(i<25) { group="p-red"; cost=220; rent=[18]; }
            else if(i<30) { group="p-yellow"; cost=260; rent=[22]; }
            else if(i<35) { group="p-green"; cost=300; rent=[26]; }
            else { group="p-blue"; cost=350; rent=[35]; if(i===39) cost=400; }
        }

        return { index:i, name, type, t:c.t, l:c.l, cost, group, rent, owner:null };
    });

    const cards = [
        {text:"Advance to GO", action:"move", target:0}, {text:"Bank Error: Collect $200", action:"money", amt:200},
        {text:"Go to Jail", action:"gotojail"}, {text:"Back 3 Spaces", action:"back3"},
        {text:"Doctor's Fee: Pay $50", action:"money", amt:-50}, {text:"Advance to Boardwalk", action:"move", target:39}
    ];

    // --- NAVIGATION ---
    function show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function genCode() { let r=""; for(let i=0;i<4;i++) r+=CHARS.charAt(Math.floor(Math.random()*CHARS.length)); return r; }
    function log(msg) { document.getElementById('join-status').innerText = msg; }
    function getColor(c) { if(c==='p-red') return '#e74c3c'; if(c==='p-blue') return '#3498db'; if(c==='p-green') return '#2ecc71'; return '#f1c40f'; }

    // --- HOST LOGIC ---
    function setupHost() {
        const code = genCode();
        show('screen-host');
        document.getElementById('host-code').innerText = code;
        
        peer = new Peer(APP_ID + code);
        
        peer.on('connection', c => {
            if(gameStarted) { c.close(); return; }
            const pid = players.length;
            if(pid >= 4) return;

            const name = c.metadata?.name || "Player " + (pid+1);
            const color = ["p-red","p-blue","p-green","p-yellow"][pid];
            const p = {id:pid, name:name, color:color, money:1500, pos:0, conn:c};
            players.push(p);

            const div = document.createElement('div');
            div.innerText = name;
            div.style.cssText = `padding:15px; background:#333; border-left: 5px solid ${getColor(color)}; font-weight:bold; color:white; margin-bottom:10px;`;
            document.getElementById('host-player-list').appendChild(div);

            spawnToken(p);

            c.on('open', () => {
                c.send({type:'WELCOME', pid:pid});
                broadcast();
            });
            c.on('data', d => handleAction(pid, d));
            c.on('close', () => {
                // Simple handle: just alert. Reconnecting specific players is hard without accounts.
                // console.log("Player disconnected");
            });
        });
    }

    function spawnToken(p) {
        const t = document.createElement('div');
        t.className = `token ${p.color}`;
        t.id = `tok-${p.id}`;
        // Slight offset
        const off = (p.id*1.5)-2.25; 
        t.style.marginLeft = off+"%"; t.style.marginTop = off+"%";
        document.getElementById('board-container').appendChild(t);
        moveTokenVisual(p);
    }

    function moveTokenVisual(p) {
        const sq = board[p.pos];
        const t = document.getElementById(`tok-${p.id}`);
        t.style.top = sq.t + "%"; t.style.left = sq.l + "%";
    }

    // --- ACCURATE BAR PLACEMENT (Inner Edge) ---
    function addBar(idx, colorClass) {
        const sq = board[idx];
        const bar = document.createElement('div');
        bar.className = 'owner-bar';
        bar.style.backgroundColor = getColor(colorClass);

        let t = sq.t, l = sq.l, w = "5.5%", h = "1.5%";

        // Bottom Row (1-9): Bar at TOP of square (Towards center)
        if(idx>0 && idx<10) { t -= 5.5; }
        // Left Row (11-19): Bar at RIGHT of square
        else if(idx>10 && idx<20) { l += 5.5; w="1.5%"; h="5.5%"; }
        // Top Row (21-29): Bar at BOTTOM of square
        else if(idx>20 && idx<30) { t += 5.5; }
        // Right Row (31-39): Bar at LEFT of square
        else if(idx>30 && idx<40) { l -= 5.5; w="1.5%"; h="5.5%"; }

        bar.style.top = t+"%"; bar.style.left = l+"%"; bar.style.width = w; bar.style.height = h;
        bar.style.transform = "translate(-50%, -50%)";
        document.getElementById('board-container').appendChild(bar);
    }

    function startGame() {
        if(players.length < 1) return alert("Wait for players");
        gameStarted = true;
        document.getElementById('btn-start').style.display = 'none';
        broadcast();
    }

    function handleAction(pid, d) {
        if(pid !== turnIdx) return;
        const p = players[pid];

        if(d.type === 'ROLL') {
            const r1 = Math.ceil(Math.random()*6);
            const r2 = Math.ceil(Math.random()*6);
            
            // SHOW DICE EVERYWHERE
            showDice(r1, r2);
            broadcast({type:'DICE_SHOW', r1:r1, r2:r2});

            setTimeout(() => {
                hideDice();
                broadcast({type:'DICE_HIDE'});
                
                p.pos += (r1+r2);
                if(p.pos >= 40) { p.pos-=40; p.money+=200; }
                moveTokenVisual(p);
                
                setTimeout(() => land(p), 800);
            }, 2500); // Wait for dice animation
        }
        else if(d.type === 'BUY') {
            const sq = board[pendingProp];
            if(p.money >= sq.cost) {
                p.money -= sq.cost;
                sq.owner = pid;
                addBar(pendingProp, p.color);
            }
            nextTurn();
        }
        else if(d.type === 'OK' || d.type === 'PASS') {
            document.getElementById('ov-host-card').style.display = 'none';
            nextTurn();
        }
    }

    function land(p) {
        const sq = board[p.pos];
        
        if(sq.type === 'prop' || sq.group.includes('p-')) {
            if(sq.owner === null) {
                if(p.money >= sq.cost) {
                    turnPhase = 'DECIDING';
                    pendingProp = p.pos;
                    broadcast();
                    return;
                }
            } else if(sq.owner !== p.id) {
                const r = sq.rent[0];
                p.money -= r;
                players[sq.owner].money += r;
            }
        }
        else if(sq.type === 'chance' || sq.type === 'chest') {
            const c = cards[Math.floor(Math.random()*cards.length)];
            turnPhase = 'ACKNOW';
            activeCard = { title:sq.type.toUpperCase(), text:c.text, type:sq.type };
            
            // Host Overlay
            document.getElementById('hc-title').innerText = activeCard.title;
            document.getElementById('hc-text').innerText = c.text;
            document.getElementById('host-card-box').className = `card-box cd-${sq.type}`;
            document.getElementById('ov-host-card').style.display = 'flex';

            // Logic
            if(c.action === 'move') { p.pos = c.target; moveTokenVisual(p); }
            else if(c.action === 'money') { p.money += c.amt; }
            else if(c.action === 'gotojail') { p.pos = 10; moveTokenVisual(p); }
            else if(c.action === 'back3') { p.pos -= 3; moveTokenVisual(p); }
            
            broadcast();
            return;
        }
        else if(sq.type === 'tax') { p.money -= sq.cost; }
        else if(sq.type === 'gotojail') { p.pos = 10; moveTokenVisual(p); }
        
        nextTurn();
    }

    function nextTurn() {
        turnPhase = 'ROLLING';
        pendingProp = null;
        activeCard = null;
        turnIdx = (turnIdx + 1) % players.length;
        broadcast();
    }

    function showDice(r1, r2) {
        document.getElementById('host-dice-val').innerText = `${r1} & ${r2}`;
        document.getElementById('ov-host-dice').style.display = 'flex';
    }
    function hideDice() { document.getElementById('ov-host-dice').style.display = 'none'; }

    function broadcast(extra) {
        if(extra) players.forEach(pl => pl.conn.send(extra));
        
        const state = {
            type: 'STATE',
            players: players.map(x=>({id:x.id, name:x.name, money:x.money})),
            turnIdx: turnIdx,
            turnPhase: turnPhase,
            pendingProp: pendingProp!==null ? board[pendingProp] : null,
            activeCard: activeCard
        };
        players.forEach(pl => pl.conn.send(state));
    }

    // --- CLIENT LOGIC ---
    function setupJoin() { show('screen-join'); }
    
    function joinGame() {
        const code = document.getElementById('inp-code').value.toUpperCase();
        const name = document.getElementById('inp-name').value || "Player";
        if(code.length !== 4) return log("Invalid Code");

        log("Connecting to Network...");
        peer = new Peer();

        peer.on('error', err => {
            log("Net Error: " + err.type);
            // Auto retry in 2s
            setTimeout(() => { if(!conn || !conn.open) joinGame(); }, 2000);
        });

        peer.on('open', id => {
            log("Finding Host...");
            conn = peer.connect(APP_ID + code, {metadata:{name:name}});
            
            const timer = setTimeout(() => {
                if(!conn.open) log("Host Not Found (Check WiFi)");
            }, 5000);

            conn.on('open', () => {
                clearTimeout(timer);
                log("Connected!");
                show('screen-client');
                document.getElementById('c-name').innerText = name;
            });

            conn.on('data', handleClientData);
            conn.on('close', () => { alert("Disconnected"); location.reload(); });
        });
    }

    function handleClientData(d) {
        if(d.type === 'WELCOME') myId = d.pid;
        else if(d.type === 'STATE') renderClient(d);
        else if(d.type === 'DICE_SHOW') {
            document.getElementById('client-dice-val').innerText = `${d.r1} & ${d.r2}`;
            document.getElementById('ov-client-dice').style.display = 'flex';
        }
        else if(d.type === 'DICE_HIDE') {
            document.getElementById('ov-client-dice').style.display = 'none';
        }
    }

    function renderClient(s) {
        const me = s.players.find(x => x.id === myId);
        document.getElementById('c-money').innerText = "$" + me.money;
        
        const isTurn = (s.turnIdx === myId);
        const con = document.getElementById('c-controls');
        con.innerHTML = "";

        // CARD OVERLAY ON PHONE
        const cardOv = document.getElementById('ov-client-card');
        if(s.turnPhase === 'ACKNOW' && s.activeCard) {
            document.getElementById('cc-title').innerText = s.activeCard.title;
            document.getElementById('cc-text').innerText = s.activeCard.text;
            document.getElementById('client-card-box').className = `card-box cd-${s.activeCard.type}`;
            cardOv.style.display = 'flex';
            // Only current player button
            cardOv.querySelector('button').style.display = isTurn ? 'inline-block' : 'none';
        } else {
            cardOv.style.display = 'none';
        }

        if(!isTurn) {
            document.getElementById('c-status').innerText = s.players[s.turnIdx].name + "'s Turn";
            return;
        }

        document.getElementById('c-status').innerText = "YOUR TURN";

        if(s.turnPhase === 'ROLLING') {
            con.innerHTML = `<button class="btn-green" onclick="send('ROLL')">ROLL DICE</button>`;
        } 
        else if(s.turnPhase === 'DECIDING') {
            const p = s.pendingProp;
            con.innerHTML = `
                <div style="background:white; color:black; padding:20px; border-radius:10px; margin-bottom:20px; text-align:center; border: 4px solid black;">
                    <div style="background:#333; color:white; padding:5px; margin-bottom:5px;">${p.name}</div>
                    <p style="font-size:2rem; font-weight:bold; margin:10px;">$${p.cost}</p>
                </div>
                <button class="btn-green" onclick="send('BUY')">BUY</button>
                <button class="btn-blue" onclick="send('PASS')">PASS</button>
            `;
        }
    }

    function send(t) { conn.send({type:t}); }

</script>
</body>
</html>
