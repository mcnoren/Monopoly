<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monopoly PeerJS</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --bg: #cdeac0;
            --border: #111;
            --brown: #8d6e63;
            --lblue: #81d4fa;
            --pink: #f48fb1;
            --orange: #ffb74d;
            --red: #e57373;
            --yellow: #fff176;
            --green: #81c784;
            --dblue: #64b5f6;
        }

        body {
            margin: 0;
            background: #222;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        .hidden {
            display: none !important;
        }

        .flex {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* --- SETUP & LOBBY UI --- */
        #ui-layer {
            position: fixed;
            inset: 0;
            background: #ecf0f1;
            z-index: 2000;
            transition: opacity 0.5s;
        }

        .panel {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .title {
            font-size: 3rem;
            font-weight: 900;
            letter-spacing: -2px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .btn {
            background: #2c3e50;
            color: white;
            padding: 15px 30px;
            font-size: 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            width: 100%;
            transition: 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-green {
            background: #27ae60;
        }

        .btn-red {
            background: #c0392b;
        }

        input {
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
            margin: 15px 0;
            border: 2px solid #ccc;
            border-radius: 6px;
            letter-spacing: 5px;
            font-family: monospace;
            text-transform: uppercase;
        }

        /* Lobby Specifics */
        #lobby-view {
            text-align: center;
        }

        .code-display {
            font-size: 4rem;
            font-family: monospace;
            letter-spacing: 10px;
            color: #e67e22;
            font-weight: bold;
            margin: 20px 0;
            background: #eee;
            padding: 10px;
            border-radius: 10px;
            border: 2px dashed #ccc;
        }

        #player-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }

        #player-list li {
            background: white;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .p-dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
        }

        /* --- THE BOARD (CSS GRID) --- */
        #game-scene {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1500px;
            background: radial-gradient(#444, #111);
        }

        #board {
            width: 95vmin;
            height: 95vmin;
            max-width: 900px;
            max-height: 900px;
            background: var(--bg);
            border: 2px solid var(--border);
            position: relative;
            display: grid;
            grid-template-columns: 13.5% repeat(9, 1fr) 13.5%;
            grid-template-rows: 13.5% repeat(9, 1fr) 13.5%;
            /* 3D TILT EFFECT */
            transform: rotateX(20deg);
            transform-style: preserve-3d;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.6);
        }

        /* SPACES */
        .space {
            border: 1px solid var(--border);
            position: relative;
            background: var(--bg);
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
        }

        /* The internal container rotates to face center */
        .s-content {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1px;
        }

        .color-bar {
            height: 22%;
            border-bottom: 2px solid var(--border);
        }

        .s-name {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.1;
            padding: 2px;
        }

        .s-price {
            margin-bottom: 3px;
            font-weight: 400;
        }

        .s-icon {
            width: 100%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: auto;
            margin-bottom: auto;
        }

        .s-icon svg {
            width: 60%;
            height: 60%;
            fill: var(--border);
        }

        /* Rotations for Sides */
        .rot-90 {
            transform: rotate(90deg);
        }

        .rot-180 {
            transform: rotate(180deg);
        }

        .rot-neg-90 {
            transform: rotate(-90deg);
        }

        /* CORNERS */
        .corner {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 900;
        }

        .go-arrow {
            color: #c0392b;
            font-size: 3rem;
            line-height: 0;
            transform: rotate(180deg);
        }

        #jail-space {
            display: grid;
            grid-template-columns: 1fr 2.5fr;
            grid-template-rows: 2.5fr 1fr;
        }

        .jail-box {
            grid-column: 2;
            grid-row: 1;
            background: #f39c12;
            border-left: 2px solid black;
            border-bottom: 2px solid black;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visiting {
            grid-column: 1/3;
            grid-row: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .visiting span {
            transform: rotate(-90deg);
            white-space: nowrap;
            margin-bottom: 5px;
        }

        /* CENTER DECORATION (The Card Decks) */
        #center-area {
            grid-column: 2/11;
            grid-row: 2/11;
            position: relative;
        }

        /* Community Chest Deck (Top Left, Tilted) */
        .deck-chest {
            position: absolute;
            top: 15%;
            left: 15%;
            width: 120px;
            height: 80px;
            border: 2px solid #2980b9;
            transform: rotate(135deg);
            background: #81d4fa;
            box-shadow: 5px 5px 0 #2980b9;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .deck-label {
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            color: #000;
        }

        /* Chance Deck (Bottom Right, Tilted) */
        .deck-chance {
            position: absolute;
            bottom: 15%;
            right: 15%;
            width: 120px;
            height: 80px;
            border: 2px solid #e67e22;
            transform: rotate(135deg);
            background: #ffcc80;
            box-shadow: 5px 5px 0 #e67e22;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .logo-main {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            background: #c0392b;
            color: white;
            padding: 10px 40px;
            font-size: 3rem;
            font-family: 'Verdana', sans-serif;
            font-weight: 900;
            letter-spacing: -2px;
            border: 4px solid white;
            outline: 3px solid black;
            box-shadow: 10px 10px 0 rgba(0, 0, 0, 0.2);
        }

        /* --- 3D PIECES --- */
        .token {
            position: absolute;
            width: 24px;
            height: 24px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            transform-style: preserve-3d;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
        }

        .pawn {
            width: 100%;
            height: 100%;
            position: relative;
            transform: rotateX(-90deg) translateZ(12px);
            transform-style: preserve-3d;
        }

        .p-body {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: inherit;
            transform: translateZ(-20px);
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .p-head {
            position: absolute;
            inset: 4px;
            border-radius: 50%;
            background: inherit;
            transform: translateZ(0px);
            filter: brightness(1.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .hop {
            animation: hopAnim 0.4s ease;
        }

        @keyframes hopAnim {
            50% {
                transform: translateZ(60px) rotateX(-90deg);
            }
        }

        /* --- PLAYER UI (PHONE) --- */
        #player-ui {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f4f4f4;
            border-top: 8px solid #2c3e50;
        }

        .p-header {
            background: #fff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
        }

        .money-badge {
            background: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        #controls {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            gap: 15px;
        }

        .big-btn {
            height: 70px;
            font-size: 1.5rem;
            text-transform: uppercase;
            border-bottom: 5px solid rgba(0, 0, 0, 0.2);
        }

        .log-box {
            height: 100px;
            background: #ddd;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
            border-top: 1px solid #bbb;
        }

        .owned-props {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
            background: #eee;
            min-height: 50px;
        }

        .prop-badge {
            padding: 5px 8px;
            font-size: 0.7rem;
            color: #000;
            border: 1px solid #333;
            font-weight: bold;
            background: #fff;
        }
    </style>
</head>

<body>

    <div id="ui-layer" class="flex">

        <div id="menu-view" class="panel">
            <div class="title">Monopoly</div>
            <p>PeerJS Edition</p>
            <button class="btn btn-green" onclick="initHost()">Create Game (Host)</button>
            <div style="margin: 15px 0; border-bottom: 1px solid #ccc;"></div>
            <button class="btn" onclick="showJoin()">Join Game</button>
        </div>

        <div id="join-view" class="panel hidden">
            <div class="title">Join Game</div>
            <input id="room-code" type="text" placeholder="CODE" maxlength="4">
            <button class="btn btn-green" onclick="initPlayer()">Connect</button>
            <button class="btn btn-red" onclick="location.reload()">Back</button>
        </div>

        <div id="lobby-view" class="panel hidden">
            <h2>Lobby</h2>
            <p>Join Code:</p>
            <div class="code-display" id="lobby-code">----</div>
            <p>Players Connected:</p>
            <ul id="player-list"></ul>
            <button id="btn-start" class="btn btn-green hidden" onclick="startGame()">START GAME</button>
        </div>

        <div id="player-wait-view" class="panel hidden">
            <h2>Connected!</h2>
            <p>Waiting for host to start...</p>
            <div class="p-dot" id="my-color-dot" style="width:40px; height:40px; margin:20px;"></div>
        </div>
    </div>

    <div id="game-scene" class="hidden">
        <div id="board">
            <div id="grid-container" style="display:contents"></div>
            <div id="center-area">
                <div class="logo-main">MONOPOLY</div>

                <div class="deck-chest">
                    <div class="deck-label">COMMUNITY CHEST</div>
                    <svg viewBox="0 0 24 24" width="30" height="30">
                        <path fill="none" stroke="#000" stroke-width="2" d="M3 6h18v14H3zM3 11h18M12 11v4" />
                    </svg>
                </div>

                <div class="deck-chance">
                    <div class="deck-label">CHANCE</div>
                    <div style="font-size: 2rem; color: #e67e22; font-weight:900;">?</div>
                </div>

                <div id="host-log"
                    style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.8); padding: 5px 20px; border-radius: 20px; font-weight: bold; border: 2px solid #000;">
                    Waiting for turns...
                </div>
            </div>
        </div>
    </div>

    <div id="player-ui" class="hidden">
        <div class="p-header">
            <strong id="p-name-disp">Player</strong>
            <div class="money-badge" id="p-money-disp">$1500</div>
        </div>
        <div style="background: #2c3e50; color: white; text-align: center; padding: 5px;" id="p-status">Wait...</div>

        <div id="controls">
            <button id="btn-roll" class="btn big-btn btn-green hidden" onclick="send('ROLL')">ROLL DICE</button>
            <button id="btn-buy" class="btn big-btn btn-blue hidden" onclick="send('BUY')">BUY</button>
            <button id="btn-pass" class="btn big-btn btn-red hidden" onclick="send('PASS')">PASS / END</button>
        </div>

        <div class="owned-props" id="p-props"></div>
        <div class="log-box" id="p-log">Welcome!</div>
    </div>

    <script>
        // --- ASSETS (SVGs) ---
        const ICONS = {
            train: `<svg viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-1zm-4 15.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm10-5.5H0v-5h24v5zm-4 5.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg>`,
            bulb: `<svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>`,
            faucet: `<svg viewBox="0 0 24 24"><path d="M19 11h-2V7c0-1.1-.9-2-2-2h-4v2h4v4h-2v2h2v4h-2v2h4v-2h-2v-4h2v-2zM9 19v2h2v-2H9zm-2-2H5v2h2v-2zm0-4H5v2h2v-2zm-2-4H3v2h2V9zm4 0H9v2h2V9zm-4-4H3v2h2V5z"/></svg>`,
            ring: `<svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`,
            chest: `<svg viewBox="0 0 24 24"><path d="M20 6h-2.18c-.11-.31-.26-.61-.44-.89l1.12-1.12c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0l-1.12 1.12c-.28-.18-.58-.33-.89-.44V1c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v2.18c-.31.11-.61.26-.89.44L4.91 2.5c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.12 1.12c-.18.28-.33.58-.44.89H2c-.55 0-1 .45-1 1v14c0 .55.45 1 1 1h18c.55 0 1-.45 1-1V7c0-.55-.45-1-1-1z"/></svg>`,
            question: `<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>`,
            car: `<svg viewBox="0 0 24 24"><path d="M19 6c0-1.1-.9-2-2-2H7c-1.1 0-2 .9-2 2v2H3v10h2v2h2v-2h10v2h2v-2h2V8h-2V6zm-2 2H7V6h10v2z"/></svg>`,
            police: `<svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h-3v-3h3v3zm0-4.5h-3v-3h3v3z"/></svg>`
        };

        const SPACES = [
            { n: "GO", t: "go" },
            { n: "MEDITER. AVE", p: 60, c: "var(--brown)", t: "prop" },
            { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
            { n: "BALTIC AVE", p: 60, c: "var(--brown)", t: "prop" },
            { n: "INCOME TAX", p: 200, t: "icon", i: `<div style="font-size:1.5rem">♦</div>` },
            { n: "READING RR", p: 200, t: "icon", i: ICONS.train },
            { n: "ORIENTAL AVE", p: 100, c: "var(--lblue)", t: "prop" },
            { n: "CHANCE", t: "icon", i: ICONS.question },
            { n: "VERMONT AVE", p: 100, c: "var(--lblue)", t: "prop" },
            { n: "CONN. AVE", p: 120, c: "var(--lblue)", t: "prop" },
            { n: "JAIL", t: "jail" },
            { n: "ST. CHARLES", p: 140, c: "var(--pink)", t: "prop" },
            { n: "ELECTRIC CO", p: 150, t: "icon", i: ICONS.bulb },
            { n: "STATES AVE", p: 140, c: "var(--pink)", t: "prop" },
            { n: "VIRGINIA AVE", p: 160, c: "var(--pink)", t: "prop" },
            { n: "PENN RR", p: 200, t: "icon", i: ICONS.train },
            { n: "ST. JAMES", p: 180, c: "var(--orange)", t: "prop" },
            { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
            { n: "TENN. AVE", p: 180, c: "var(--orange)", t: "prop" },
            { n: "NEW YORK AVE", p: 200, c: "var(--orange)", t: "prop" },
            { n: "FREE PARKING", t: "icon", i: ICONS.car },
            { n: "KENTUCKY AVE", p: 220, c: "var(--red)", t: "prop" },
            { n: "CHANCE", t: "icon", i: ICONS.question },
            { n: "INDIANA AVE", p: 220, c: "var(--red)", t: "prop" },
            { n: "ILLINOIS AVE", p: 240, c: "var(--red)", t: "prop" },
            { n: "B. & O. RR", p: 200, t: "icon", i: ICONS.train },
            { n: "ATLANTIC AVE", p: 260, c: "var(--yellow)", t: "prop" },
            { n: "VENTNOR AVE", p: 260, c: "var(--yellow)", t: "prop" },
            { n: "WATER WORKS", p: 150, t: "icon", i: ICONS.faucet },
            { n: "MARVIN GDN", p: 280, c: "var(--yellow)", t: "prop" },
            { n: "GO TO JAIL", t: "icon", i: ICONS.police },
            { n: "PACIFIC AVE", p: 300, c: "var(--green)", t: "prop" },
            { n: "N. CAROL AVE", p: 300, c: "var(--green)", t: "prop" },
            { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
            { n: "PENN AVE", p: 320, c: "var(--green)", t: "prop" },
            { n: "SHORT LINE", p: 200, t: "icon", i: ICONS.train },
            { n: "CHANCE", t: "icon", i: ICONS.question },
            { n: "PARK PLACE", p: 350, c: "var(--dblue)", t: "prop" },
            { n: "LUXURY TAX", p: 100, t: "icon", i: ICONS.ring },
            { n: "BOARDWALK", p: 400, c: "var(--dblue)", t: "prop" }
        ];

        // --- APP STATE ---
        let peer, conn;
        let myCode = "";
        let players = [];
        let turnIndex = 0;
        let phase = "LOBBY"; // LOBBY, IDLE, ACTION
        let boardData = SPACES.map(s => ({ ...s, owner: null }));

        // --- HOST LOGIC ---

        function initHost() {
            // 1. Generate 4-digit Code
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            myCode = "";
            for (let i = 0; i < 4; i++) myCode += chars.charAt(Math.floor(Math.random() * chars.length));

            // 2. Setup Peer
            // Prefixing to avoid collisions on public server with other apps
            const peerId = "monopoly-peer-" + myCode;
            peer = new Peer(peerId);

            peer.on('open', (id) => {
                document.getElementById('menu-view').classList.add('hidden');
                document.getElementById('lobby-view').classList.remove('hidden');
                document.getElementById('lobby-code').innerText = myCode;
                generateBoard();
            });

            peer.on('error', (err) => {
                alert("Code collision. Retrying...");
                initHost(); // Recursive retry (rare)
            });

            peer.on('connection', (c) => {
                if (phase !== "LOBBY") return c.close(); // Lock game after start

                c.on('open', () => {
                    const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f1c40f', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];
                    const p = {
                        id: c.peer, conn: c,
                        name: `Player ${players.length + 1}`,
                        money: 1500, pos: 0,
                        color: colors[players.length % colors.length],
                        props: [], jail: false
                    };
                    players.push(p);

                    // Update Lobby UI
                    updateLobbyUI();

                    // Send Init to Player
                    c.send({ type: 'LOBBY_INIT', p: sanitize(p) });
                });

                c.on('data', (data) => handleGameAction(c.peer, data));

                c.on('close', () => {
                    players = players.filter(pl => pl.id !== c.peer);
                    updateLobbyUI();
                    // In game? Handle dropout (simplified: just remove)
                    removePiece(c.peer);
                });
            });
        }

        function updateLobbyUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = players.map(p => `<li><span class="p-dot" style="background:${p.color}"></span> ${p.name}</li>`).join('');
            if (players.length >= 2) document.getElementById('btn-start').classList.remove('hidden');
        }

        function startGame() {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('game-scene').classList.remove('hidden');
            phase = "IDLE";

            // Spawn Pieces
            players.forEach(p => createPiece(p));

            broadcastState();
            promptTurn();
        }

        function handleGameAction(pid, data) {
            const p = players.find(pl => pl.id === pid);
            if (!p || players.indexOf(p) !== turnIndex) return;

            if (data.act === 'ROLL' && phase === 'IDLE') {
                const r1 = Math.ceil(Math.random() * 6);
                const r2 = Math.ceil(Math.random() * 6);
                const roll = r1 + r2;
                hostLog(`${p.name} rolled ${roll}`);

                // Move
                const oldPos = p.pos;
                p.pos = (p.pos + roll) % 40;
                movePiece(p);

                // Pass Go
                if (p.pos < oldPos) {
                    p.money += 200;
                    hostLog("Passed GO! +$200");
                }

                const space = boardData[p.pos];

                // Logic
                if (space.n === "GO TO JAIL") {
                    setTimeout(() => {
                        p.pos = 10;
                        movePiece(p);
                        hostLog("Sent to Jail!");
                        endTurn();
                    }, 1000);
                    return;
                }

                if (space.t === 'prop') {
                    if (!space.owner) {
                        if (p.money >= space.p) {
                            phase = "ACTION";
                            p.conn.send({ type: 'OFFER', s: space });
                            return;
                        }
                    } else if (space.owner !== p.id) {
                        // Rent
                        p.money -= 20; // Simplified
                        const owner = players.find(x => x.id === space.owner);
                        if (owner) owner.money += 20;
                        hostLog(`Paid $20 rent to ${owner.name}`);
                    }
                }

                // Auto End if nothing to do
                setTimeout(endTurn, 1500);
            }

            if (data.act === 'BUY' && phase === 'ACTION') {
                const s = boardData[p.pos];
                if (p.money >= s.p && !s.owner) {
                    p.money -= s.p;
                    s.owner = p.id;
                    p.props.push(s.n);
                    hostLog(`${p.name} bought ${s.n}`);
                    // Visual Marker
                    document.getElementById(`space-${p.pos}`).style.boxShadow = `inset 0 0 0 4px ${p.color}`;
                }
                endTurn();
            }

            if (data.act === 'PASS' && phase === 'ACTION') {
                endTurn();
            }
        }

        function endTurn() {
            turnIndex = (turnIndex + 1) % players.length;
            phase = "IDLE";
            broadcastState();
            promptTurn();
        }

        function promptTurn() {
            players.forEach((p, i) => {
                if (i === turnIndex) p.conn.send({ type: 'TURN' });
                else p.conn.send({ type: 'WAIT' });
            });
        }

        function broadcastState() {
            const safePlayers = players.map(sanitize);
            players.forEach(p => p.conn.send({ type: 'STATE', players: safePlayers }));
        }

        // --- BOARD RENDERING ---

        function generateBoard() {
            const grid = document.getElementById('grid-container');
            SPACES.forEach((s, i) => {
                const el = document.createElement('div');
                el.className = 'space';
                el.id = `space-${i}`;

                // GRID MATH
                let r, c, rotClass;
                if (i <= 10) { r = 11; c = 11 - i; rotClass = ''; }
                else if (i <= 20) { r = 11 - (i - 10); c = 1; rotClass = 'rot-90'; }
                else if (i <= 30) { r = 1; c = (i - 20) + 1; rotClass = 'rot-180'; }
                else { r = (i - 30) + 1; c = 11; rotClass = 'rot-neg-90'; }

                el.style.gridRow = r;
                el.style.gridColumn = c;

                // INNER CONTENT
                let inner = '';
                if (s.t === 'prop') {
                    inner = `
                <div class="s-content ${rotClass}">
                    <div class="color-bar" style="background:${s.c}"></div>
                    <div class="s-name">${s.n}</div>
                    <div class="s-price">$${s.p}</div>
                </div>`;
                } else if (s.t === 'icon') {
                    inner = `
                <div class="s-content ${rotClass}">
                    <div class="s-name">${s.n}</div>
                    <div class="s-icon">${s.i}</div>
                    <div class="s-price">${s.p ? '$' + s.p : ''}</div>
                </div>`;
                } else if (s.n === 'GO') {
                    inner = `<div class="s-content"><div class="corner">GO<br><div class="go-arrow">➜</div></div></div>`;
                } else if (s.n === 'JAIL') {
                    el.id = 'jail-space';
                    inner = `<div class="jail-box">IN JAIL</div><div class="visiting"><span>JUST VISITING</span></div>`;
                } else {
                    // Corners
                    inner = `<div class="s-content ${rotClass}"><div class="corner">${s.n}</div></div>`;
                }

                el.innerHTML = inner;
                grid.appendChild(el);
            });
        }

        function createPiece(p) {
            const el = document.createElement('div');
            el.className = 'token';
            el.id = `token-${p.id}`;
            el.innerHTML = `
        <div class="pawn">
            <div class="p-body" style="background:${p.color}"></div>
            <div class="p-head" style="background:${p.color}"></div>
        </div>`;
            // Attach to board container but position absolute based on grid
            document.getElementById('board').appendChild(el);
            movePiece(p); // Init position
        }

        function movePiece(p) {
            const token = document.getElementById(`token-${p.id}`);
            const space = document.getElementById(`space-${p.pos}`);
            if (!token || !space) return;

            // Hacky Center Position calc
            // We temporarily append token to space to get relative 0,0, then move back
            space.appendChild(token);
            const rect = token.getBoundingClientRect();
            const boardRect = document.getElementById('board').getBoundingClientRect();
            document.getElementById('board').appendChild(token);

            const left = rect.left - boardRect.left;
            const top = rect.top - boardRect.top;

            token.style.left = left + 'px';
            token.style.top = top + 'px';

            // Animation trigger
            const pawn = token.querySelector('.pawn');
            pawn.classList.remove('hop');
            void pawn.offsetWidth; // Reflow
            pawn.classList.add('hop');
        }

        function hostLog(msg) {
            document.getElementById('host-log').innerText = msg;
        }

        // --- PLAYER CLIENT LOGIC ---

        function showJoin() {
            document.getElementById('menu-view').classList.add('hidden');
            document.getElementById('join-view').classList.remove('hidden');
        }

        function initPlayer() {
            const input = document.getElementById('room-code').value.toUpperCase();
            if (input.length !== 4) return alert("Code must be 4 characters");

            const fullId = "monopoly-peer-" + input;
            peer = new Peer();

            peer.on('open', (id) => {
                conn = peer.connect(fullId);

                conn.on('open', () => {
                    document.getElementById('join-view').classList.add('hidden');
                    document.getElementById('player-wait-view').classList.remove('hidden');
                });

                conn.on('data', handlePlayerMsg);

                conn.on('close', () => alert("Disconnected from Host"));

                // Timeout check
                setTimeout(() => {
                    if (!conn.open) alert("Could not connect. Check code.");
                }, 5000);
            });
        }

        function handlePlayerMsg(d) {
            const ui = document.getElementById('player-ui');
            const wait = document.getElementById('player-wait-view');
            const bRoll = document.getElementById('btn-roll');
            const bBuy = document.getElementById('btn-buy');
            const bPass = document.getElementById('btn-pass');
            const status = document.getElementById('p-status');

            if (d.type === 'LOBBY_INIT') {
                document.getElementById('my-color-dot').style.background = d.p.color;
            }

            if (d.type === 'STATE') {
                wait.classList.add('hidden');
                ui.classList.remove('hidden');

                const me = d.players.find(p => p.id === peer.id);
                if (me) {
                    document.getElementById('p-name-disp').innerText = me.name;
                    document.getElementById('p-name-disp').style.color = me.color;
                    document.getElementById('p-money-disp').innerText = `$${me.money}`;
                    document.getElementById('p-props').innerHTML = me.props.map(prop => `<span class="prop-badge">${prop}</span>`).join('');
                }
            }

            // Reset controls state
            bRoll.classList.add('hidden');
            bBuy.classList.add('hidden');
            bPass.classList.add('hidden');

            if (d.type === 'WAIT') {
                status.innerText = "Waiting for other players...";
                status.style.background = "#2c3e50";
            }

            if (d.type === 'TURN') {
                status.innerText = "YOUR TURN!";
                status.style.background = "#27ae60";
                bRoll.classList.remove('hidden');
                clientLog("It's your turn.");
            }

            if (d.type === 'OFFER') {
                status.innerText = `Buy ${d.s.n}?`;
                status.style.background = "#2980b9";
                bBuy.innerText = `BUY ($${d.s.p})`;
                bBuy.classList.remove('hidden');
                bPass.classList.remove('hidden');
            }
        }

        function send(act) {
            if (conn && conn.open) conn.send({ act: act });
        }

        function clientLog(msg) {
            const log = document.getElementById('p-log');
            log.innerHTML = `<div>${msg}</div>` + log.innerHTML;
        }

        // Helper
        function sanitize(p) { return { id: p.id, name: p.name, money: p.money, color: p.color, props: p.props }; }
        function removePiece(id) {
            const el = document.getElementById(`token-${id}`);
            if (el) el.remove();
        }

    </script>
</body>

</html>
