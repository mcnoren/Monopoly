<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Monopoly Authentic Board</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- VARIABLES --- */
    :root { 
        --board-bg: #d4eac8; 
        --border: #000;
        --brown: #8b4513; --lblue: #87ceeb; --pink: #ff69b4; --orange: #ffa500; 
        --red: #ff0000; --yellow: #ffff00; --green: #008000; --dblue: #0000ff;
    }
    body { margin: 0; background: #222; font-family: 'Verdana', sans-serif; overflow: hidden; user-select: none; }
    .hidden { display: none !important; }

    /* --- SETUP UI --- */
    #ui-layer { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .panel { background: white; padding: 40px; border-radius: 4px; text-align: center; width: 320px; box-shadow: 0 0 20px rgba(0,0,0,0.5); border: 2px solid #000; }
    .btn { background: #ce0e2d; color: white; padding: 15px; font-size: 1.1rem; border: 2px solid #000; cursor: pointer; font-weight: bold; width: 100%; margin: 10px 0; text-transform: uppercase; }
    .btn:hover { background: #b00b26; }
    .input-code { width: 100%; padding: 10px; font-size: 1.5rem; text-align: center; border: 2px solid #000; margin: 10px 0; text-transform: uppercase; font-family: monospace; letter-spacing: 5px; }

    /* --- THE BOARD --- */
    #game-scene { height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; background: #222; }
    
    #board {
        width: 95vmin; height: 95vmin;
        max-width: 900px; max-height: 900px;
        background: var(--board-bg);
        border: 2px solid var(--border);
        display: grid;
        /* 11x11 Grid. Corners ~13.2%, others ~8.17% */
        grid-template-columns: 13.2% repeat(9, 1fr) 13.2%;
        grid-template-rows: 13.2% repeat(9, 1fr) 13.2%;
        position: relative;
        box-shadow: 0 0 50px #000;
    }

    /* --- SPACES --- */
    .space {
        border: 1px solid var(--border);
        position: relative;
        background: var(--board-bg);
        font-size: 0.6vmin; 
        font-weight: 700;
        text-transform: uppercase;
        text-align: center;
        color: #000;
        display: flex; align-items: center; justify-content: center;
    }

    /* Internal Container for Rotation */
    .rot-box {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
    }
    
    /* Layout: Color bar is typically closest to center. 
       We will rotate the .rot-box so 'top' is always the inner edge. */
    .bar { height: 22%; width: 100%; border-bottom: 2px solid #000; box-sizing: border-box; }
    .name { flex: 1; display: flex; align-items: center; justify-content: center; line-height: 1.2; padding: 0 2px; }
    .icon { flex: 1; display: flex; align-items: center; justify-content: center; }
    .icon svg { width: 70%; height: 70%; }
    .price { height: 18%; display: flex; align-items: flex-start; justify-content: center; font-weight: normal; font-size: 0.55vmin; }

    /* Rotations (Orientation: Bottom of text points to center) */
    .rot-0 { transform: rotate(0deg); }       /* Bottom Row */
    .rot-90 { transform: rotate(90deg); }     /* Left Row */
    .rot-180 { transform: rotate(180deg); }   /* Top Row */
    .rot-270 { transform: rotate(-90deg); }   /* Right Row */

    /* --- CORNERS --- */
    .corner { width: 100%; height: 100%; position: relative; }
    
    /* GO */
    .go-arrow { position: absolute; width: 70%; left: 15%; top: 45%; transform: rotate(180deg); fill: #ce0e2d; }
    .go-text { position: absolute; top: 5%; left: 5%; transform: rotate(-45deg); font-size: 1.8vmin; font-weight: 900; }

    /* JAIL */
    #jail-space { display: grid; grid-template-columns: 1fr 2.5fr; grid-template-rows: 2.5fr 1fr; padding: 0 !important; border: 1px solid #000; }
    .jail-cell { grid-column: 2; grid-row: 1; background: #ff9900; border-left: 2px solid #000; border-bottom: 2px solid #000; display:flex; align-items:center; justify-content:center;}
    .jail-v { grid-column: 1; grid-row: 1/3; display: flex; align-items: center; justify-content: center; writing-mode: vertical-rl; transform: rotate(180deg); font-size: 1vmin;}
    .jail-j { grid-column: 2; grid-row: 2; display: flex; align-items: center; justify-content: center; font-size: 1vmin; }

    /* --- CENTER ART --- */
    #center-board {
        grid-column: 2/11; grid-row: 2/11;
        position: relative;
        pointer-events: none; /* Let clicks pass through if needed */
    }

    .logo-box {
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        background: #ce0e2d; color: white;
        padding: 1.2vmin 5vmin;
        border: 3px solid white; outline: 2px solid black;
        box-shadow: 1vmin 1vmin 0 rgba(0,0,0,0.15);
        font-family: 'Arial Black', sans-serif; font-size: 6vmin; letter-spacing: -2px;
    }

    .card-slot {
        position: absolute; width: 14vmin; height: 9vmin;
        border: 2px solid #000;
        display: flex; align-items: center; justify-content: center;
        text-align: center; font-weight: bold; font-size: 0.8vmin; transform: rotate(135deg);
        box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }
    .slot-cc { top: 15%; left: 15%; background: #aae0fa; }
    .slot-ch { bottom: 15%; right: 15%; background: #ff9900; }

    /* --- TOKENS --- */
    .token {
        position: absolute; width: 3vmin; height: 3vmin;
        border-radius: 50%; z-index: 100;
        transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        border: 2px solid white;
    }

    /* --- PLAYER CONTROLS --- */
    #controls {
        position: absolute; bottom: 0; left: 0; width: 100%;
        background: white; border-top: 4px solid #000;
        display: flex; justify-content: space-between; align-items: center;
        padding: 15px 30px; box-sizing: border-box; z-index: 3000;
    }
    .ctrl-group { display: flex; gap: 10px; }
    .c-btn { padding: 10px 20px; font-size: 1.2rem; border: 2px solid #000; cursor: pointer; font-weight: bold; text-transform: uppercase; }
    .b-roll { background: #ce0e2d; color: white; }
    .b-buy { background: #008000; color: white; }
    .b-pass { background: #555; color: white; }
    
</style>
</head>
<body>

<div id="ui-layer">
    <div id="panel-menu" class="panel">
        <h1 style="font-family:'Arial Black'; margin-top:0;">MONOPOLY</h1>
        <button class="btn" onclick="startHost()">Create Game</button>
        <button class="btn" style="background:#0072bb" onclick="showJoin()">Join Game</button>
    </div>

    <div id="panel-join" class="panel hidden">
        <h2>Enter Code</h2>
        <input id="input-code" class="input-code" maxlength="4" placeholder="CODE">
        <button class="btn" style="background:#008000" onclick="joinGame()">Connect</button>
        <button class="btn" style="background:#555" onclick="location.reload()">Back</button>
    </div>

    <div id="panel-lobby" class="panel hidden">
        <h2>Lobby</h2>
        <div id="disp-code" style="font-size:3rem; font-family:monospace; margin:10px 0; color:#ce0e2d;">----</div>
        <div id="disp-status">Waiting for players...</div>
        <button id="btn-start" class="btn hidden" style="background:#008000" onclick="hostStart()">START GAME</button>
    </div>
</div>

<div id="game-scene" class="hidden">
    <div id="board">
        <div id="center-board">
            <div class="logo-box">MONOPOLY</div>
            <div class="card-slot slot-cc">COMMUNITY<br>CHEST</div>
            <div class="card-slot slot-ch">CHANCE<br><span style="font-size:2.5vmin; color:#ce0e2d">?</span></div>
            <div id="turn-log" style="position:absolute; bottom:10%; left:50%; transform:translateX(-50%); background:white; border:2px solid #000; padding:5px 15px; font-weight:bold;">Waiting...</div>
        </div>
    </div>
</div>

<div id="controls" class="hidden">
    <div>
        <div id="p-name" style="font-weight:bold; font-size:1.2rem;">Player</div>
        <div id="p-money" style="color:#008000; font-weight:bold;">$1500</div>
    </div>
    <div class="ctrl-group">
        <button id="btn-roll" class="c-btn b-roll disabled" onclick="send('ROLL')">ROLL</button>
        <button id="btn-buy" class="c-btn b-buy hidden" onclick="send('BUY')">BUY</button>
        <button id="btn-pass" class="c-btn b-pass hidden" onclick="send('PASS')">PASS</button>
    </div>
</div>

<script>
// --- ICONS (SVG) ---
const SVG = {
    train: `<svg viewBox="0 0 100 100"><path d="M20,70 L80,70 L80,50 L70,50 L70,30 L60,30 L60,50 L40,50 L40,70 M30,70 A5,5 0 1,0 40,70 M60,70 A5,5 0 1,0 70,70" stroke="black" stroke-width="4" fill="none"/></svg>`,
    bulb: `<svg viewBox="0 0 100 100"><path d="M35,20 A15,15 0 1,1 65,20 L65,60 L35,60 Z M35,60 L65,60 L60,80 L40,80 Z" stroke="black" stroke-width="3" fill="none"/></svg>`,
    tap: `<svg viewBox="0 0 100 100"><path d="M20,40 L80,40 M50,40 L50,80 M30,20 L70,20 L70,40 L30,40 Z" stroke="black" stroke-width="3" fill="none"/></svg>`,
    ring: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="25" stroke="black" stroke-width="4" fill="none"/><path d="M50,25 L55,15 L45,15 Z" fill="black"/></svg>`,
    chest: `<svg viewBox="0 0 100 80"><rect x="10" y="20" width="80" height="50" rx="5" stroke="black" stroke-width="3" fill="none"/><path d="M10,35 L90,35" stroke="black" stroke-width="2"/></svg>`,
    chance: `<text x="50" y="70" font-size="60" text-anchor="middle" font-family="serif" fill="#ce0e2d" font-weight="bold">?</text>`,
    car: `<svg viewBox="0 0 100 50"><path d="M10,30 L90,30 L80,15 L20,15 Z M20,30 A5,5 0 1,0 30,30 M70,30 A5,5 0 1,0 80,30" fill="red"/></svg>`,
    diamond: `<svg viewBox="0 0 100 100"><path d="M50,10 L80,50 L50,90 L20,50 Z" fill="black"/></svg>`,
    police: `<svg viewBox="0 0 100 100"><path d="M30,20 L70,20 L80,40 L20,40 Z M20,40 L20,80 L80,80 L80,40" stroke="blue" stroke-width="3" fill="none"/></svg>`
};

// --- DATA: CLASSIC MONOPOLY ORDER ---
// Order: Bottom Right (GO) -> Left -> Top -> Right -> Bottom Right
const SPACES = [
    {n:"GO", t:"go"},
    {n:"MEDITER. AVE", p:60, c:"var(--brown)", t:"prop"},
    {n:"COMM. CHEST", t:"icon", i:SVG.chest},
    {n:"BALTIC AVE", p:60, c:"var(--brown)", t:"prop"},
    {n:"INCOME TAX", p:200, t:"icon", i:SVG.diamond},
    {n:"READING R.R.", p:200, t:"icon", i:SVG.train},
    {n:"ORIENTAL AVE", p:100, c:"var(--lblue)", t:"prop"},
    {n:"CHANCE", t:"icon", i:SVG.chance},
    {n:"VERMONT AVE", p:100, c:"var(--lblue)", t:"prop"},
    {n:"CONN. AVE", p:120, c:"var(--lblue)", t:"prop"},
    {n:"JAIL", t:"jail"}, // Corner 2 (Bottom Left)
    {n:"ST. CHARLES", p:140, c:"var(--pink)", t:"prop"},
    {n:"ELECTRIC CO.", p:150, t:"icon", i:SVG.bulb},
    {n:"STATES AVE", p:140, c:"var(--pink)", t:"prop"},
    {n:"VIRGINIA AVE", p:160, c:"var(--pink)", t:"prop"},
    {n:"PENN. R.R.", p:200, t:"icon", i:SVG.train},
    {n:"ST. JAMES", p:180, c:"var(--orange)", t:"prop"},
    {n:"COMM. CHEST", t:"icon", i:SVG.chest},
    {n:"TENN. AVE", p:180, c:"var(--orange)", t:"prop"},
    {n:"NEW YORK AVE", p:200, c:"var(--orange)", t:"prop"},
    {n:"FREE PARKING", t:"fp"}, // Corner 3 (Top Left)
    {n:"KENTUCKY AVE", p:220, c:"var(--red)", t:"prop"},
    {n:"CHANCE", t:"icon", i:SVG.chance},
    {n:"INDIANA AVE", p:220, c:"var(--red)", t:"prop"},
    {n:"ILLINOIS AVE", p:240, c:"var(--red)", t:"prop"},
    {n:"B. & O. R.R.", p:200, t:"icon", i:SVG.train},
    {n:"ATLANTIC AVE", p:260, c:"var(--yellow)", t:"prop"},
    {n:"VENTNOR AVE", p:260, c:"var(--yellow)", t:"prop"},
    {n:"WATER WORKS", p:150, t:"icon", i:SVG.tap},
    {n:"MARVIN GDN", p:280, c:"var(--yellow)", t:"prop"},
    {n:"GO TO JAIL", t:"gtj"}, // Corner 4 (Top Right)
    {n:"PACIFIC AVE", p:300, c:"var(--green)", t:"prop"},
    {n:"N. CAROL AVE", p:300, c:"var(--green)", t:"prop"},
    {n:"COMM. CHEST", t:"icon", i:SVG.chest},
    {n:"PENN. AVE", p:320, c:"var(--green)", t:"prop"},
    {n:"SHORT LINE", p:200, t:"icon", i:SVG.train},
    {n:"CHANCE", t:"icon", i:SVG.chance},
    {n:"PARK PLACE", p:350, c:"var(--dblue)", t:"prop"},
    {n:"LUXURY TAX", p:100, t:"icon", i:SVG.ring},
    {n:"BOARDWALK", p:400, c:"var(--dblue)", t:"prop"}
];

// --- LOGIC ---
let peer, conn, myCode, players=[], turnIdx=0, boardState=[];

function init() {
    boardState = SPACES.map(s => ({...s, owner:null}));
    renderBoard();
}

function renderBoard() {
    const board = document.getElementById('board');
    
    SPACES.forEach((d, i) => {
        const el = document.createElement('div');
        el.className = 'space';
        el.id = `s-${i}`;

        // Grid Logic (11x11)
        // 0=11,11 | 1-9=11,10..2 | 10=11,1
        // 11-19=10..2,1 | 20=1,1
        // 21-29=1,2..10 | 30=1,11
        // 31-39=2..10,11
        let r, c, rot;

        if(i===0) { r=11; c=11; rot='rot-0'; }
        else if(i<=9) { r=11; c=11-i; rot='rot-0'; }
        else if(i===10) { r=11; c=1; rot='rot-0'; }
        else if(i<=19) { r=11-(i-10); c=1; rot='rot-90'; }
        else if(i===20) { r=1; c=1; rot='rot-0'; }
        else if(i<=29) { r=1; c=(i-20)+1; rot='rot-180'; }
        else if(i===30) { r=1; c=11; rot='rot-0'; }
        else if(i<=39) { r=(i-30)+1; c=11; rot='rot-270'; }
        
        el.style.gridRow = r;
        el.style.gridColumn = c;

        // Content
        if(d.t === 'prop') {
            el.innerHTML = `
                <div class="rot-box ${rot}">
                    <div class="bar" style="background:${d.c}"></div>
                    <div class="name">${d.n}</div>
                    <div class="price">$${d.p}</div>
                </div>`;
        } else if(d.t === 'icon') {
            el.innerHTML = `
                <div class="rot-box ${rot}">
                    <div class="name" style="margin-top:5%">${d.n}</div>
                    <div class="icon">${d.i}</div>
                    <div class="price">${d.p ? '$'+d.p : ''}</div>
                </div>`;
        } else if(d.t === 'go') {
            el.innerHTML = `<div class="corner"><div class="go-text">COLLECT<br>$200 SALARY<br>AS YOU PASS<br>GO</div><svg class="go-arrow" viewBox="0 0 100 50"><path d="M10,25 L90,25 M10,25 L30,5 M10,25 L30,45" stroke="#ce0e2d" stroke-width="8" fill="none"/></svg></div>`;
        } else if(d.t === 'jail') {
            el.id = 'jail-space';
            el.innerHTML = `<div class="jail-cell"></div><div class="jail-v">JUST</div><div class="jail-j">VISITING</div>`;
        } else if(d.t === 'fp') {
            el.innerHTML = `<div class="rot-box rot-180" style="justify-content:center"><div class="name">FREE</div><div class="icon">${SVG.car}</div><div class="name">PARKING</div></div>`;
        } else if(d.t === 'gtj') {
            el.innerHTML = `<div class="rot-box rot-270" style="justify-content:center"><div class="name">GO TO</div><div class="icon">${SVG.police}</div><div class="name">JAIL</div></div>`;
        }

        board.appendChild(el);
    });
}

// --- NETWORK ---
function startHost() {
    myCode = Math.random().toString(36).substring(2,6).toUpperCase();
    peer = new Peer("mono-"+myCode);
    peer.on('open', id => {
        document.getElementById('panel-menu').classList.add('hidden');
        document.getElementById('panel-lobby').classList.remove('hidden');
        document.getElementById('disp-code').innerText = myCode;
        init();
    });
    peer.on('connection', c => {
        c.on('open', () => {
            const colors = ['#ce0e2d', '#0000ff', '#008000', '#ffa500'];
            const p = {id:c.peer, conn:c, name:`P${players.length+1}`, money:1500, pos:0, color:colors[players.length%4]};
            players.push(p);
            updateLobby();
            c.send({type:'INIT', p:san(p)});
        });
        c.on('data', d => handleAct(c.peer, d));
    });
}

function updateLobby() {
    document.getElementById('disp-status').innerText = `${players.length} Players connected`;
    if(players.length>0) document.getElementById('btn-start').classList.remove('hidden');
}

function hostStart() {
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('game-scene').classList.remove('hidden');
    players.forEach(p => spawn(p));
    broadcast();
    sendTurn();
}

function spawn(p) {
    const t = document.createElement('div');
    t.className = 'token';
    t.id = `t-${p.id}`;
    t.style.background = p.color;
    document.getElementById('board').appendChild(t);
    move(p);
}

function move(p) {
    const t = document.getElementById(`t-${p.id}`);
    const s = document.getElementById(`s-${p.pos}`);
    if(!t || !s) return;
    const bR = document.getElementById('board').getBoundingClientRect();
    const sR = s.getBoundingClientRect();
    t.style.left = (sR.left - bR.left + sR.width/2 - t.offsetWidth/2) + 'px';
    t.style.top = (sR.top - bR.top + sR.height/2 - t.offsetHeight/2) + 'px';
}

function handleAct(pid, d) {
    const p = players.find(x => x.id === pid);
    if(!p || players.indexOf(p) !== turnIdx) return;
    
    if(d.act === 'ROLL') {
        const r = Math.ceil(Math.random()*6) + Math.ceil(Math.random()*6);
        log(`${p.name} rolled ${r}`);
        const old = p.pos;
        p.pos = (p.pos + r) % 40;
        if(p.pos < old) p.money += 200;
        move(p);
        
        const s = boardState[p.pos];
        if(s.t === 'prop' && !s.owner && p.money >= s.p) p.conn.send({type:'BUY_OPT'});
        else setTimeout(nextTurn, 1500);
    }
    if(d.act === 'BUY') {
        const s = boardState[p.pos];
        if(!s.owner && p.money >= s.p) {
            p.money -= s.p; s.owner = p.id;
            document.getElementById(`s-${p.pos}`).style.boxShadow = `inset 0 0 0 4px ${p.color}`;
        }
        nextTurn();
    }
    if(d.act === 'PASS') nextTurn();
    broadcast();
}

function nextTurn() {
    turnIdx = (turnIdx + 1) % players.length;
    sendTurn();
}
function sendTurn() {
    players.forEach((p, i) => {
        if(i === turnIdx) { p.conn.send({type:'TURN'}); log(`Turn: ${p.name}`); }
        else p.conn.send({type:'WAIT'});
    });
}
function broadcast() { players.forEach(p => p.conn.send({type:'STATE', pl:players.map(san)})); }
function san(p) { return {id:p.id, name:p.name, money:p.money, color:p.color}; }
function log(m) { document.getElementById('turn-log').innerText = m; }

// --- CLIENT ---
function showJoin() {
    document.getElementById('panel-menu').classList.add('hidden');
    document.getElementById('panel-join').classList.remove('hidden');
}
function joinGame() {
    const c = document.getElementById('input-code').value.toUpperCase();
    peer = new Peer();
    peer.on('open', id => {
        conn = peer.connect("mono-"+c);
        conn.on('open', () => {
            init(); // Client needs visual board
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('game-scene').classList.remove('hidden');
        });
        conn.on('data', clientData);
    });
}
function clientData(d) {
    if(d.type === 'INIT') {
        document.getElementById('p-name').innerText = d.p.name;
        document.getElementById('p-name').style.color = d.p.color;
    }
    if(d.type === 'STATE') {
        const me = d.pl.find(x => x.name === document.getElementById('p-name').innerText);
        if(me) document.getElementById('p-money').innerText = `$${me.money}`;
    }
    // Buttons
    document.getElementById('btn-roll').classList.add('disabled');
    document.getElementById('btn-buy').classList.add('hidden');
    document.getElementById('btn-pass').classList.add('hidden');

    if(d.type === 'TURN') document.getElementById('btn-roll').classList.remove('disabled');
    if(d.type === 'BUY_OPT') {
        document.getElementById('btn-buy').classList.remove('hidden');
        document.getElementById('btn-pass').classList.remove('hidden');
    }
}
function send(a) { conn.send({act:a}); }

</script>
</body>
</html>
