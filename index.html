<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Monopoly Fixed 2D</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
    /* --- RESET & BASICS --- */
    :root { 
        --board-bg: #bfdbae; 
        --border-color: #000;
        /* Classic Colors */
        --brown: #955436; --lblue: #aae0fa; --pink: #d93a96; --orange: #f7941d; 
        --red: #ed1b24; --yellow: #fef200; --green: #1fb25a; --dblue: #0072bb;
    }
    body { margin: 0; background: #222; font-family: 'Arial', sans-serif; overflow: hidden; user-select: none; }
    .hidden { display: none !important; }

    /* --- SETUP UI --- */
    #ui-layer { position: fixed; inset: 0; background: #f0f0f0; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .panel { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 300px; border: 2px solid #000; }
    .btn { background: #ed1b24; color: white; padding: 12px 24px; font-size: 1.1rem; border: 2px solid #000; cursor: pointer; font-weight: bold; width: 100%; margin: 5px 0; }
    input { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #000; box-sizing: border-box; text-align: center; font-size: 1.2rem; }

    /* --- THE BOARD (FLAT 2D) --- */
    #game-scene { 
        height: 100vh; width: 100vw; 
        display: flex; align-items: center; justify-content: center; 
        background: #333;
    }
    
    #board {
        /* Fixed Aspect Ratio Square */
        width: 95vmin; height: 95vmin;
        max-width: 900px; max-height: 900px;
        background: var(--board-bg);
        border: 2px solid #000;
        display: grid;
        /* Classic Monopoly Grid: Corners are ~13-14%, 9 spaces in between */
        grid-template-columns: 13.5% repeat(9, 1fr) 13.5%;
        grid-template-rows: 13.5% repeat(9, 1fr) 13.5%;
        position: relative;
        box-shadow: 0 0 50px rgba(0,0,0,0.5);
    }

    /* --- SPACES --- */
    .space {
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
        background: var(--board-bg);
        font-size: 0.65vmin; /* Dynamic text sizing */
        font-weight: bold;
        text-transform: uppercase;
        text-align: center;
        /* Flex to center the rotating container */
        display: flex; align-items: center; justify-content: center;
    }

    /* The Container inside space that rotates */
    .container {
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        justify-content: space-between;
    }

    /* ROTATION CLASSES (Text faces center) */
    .rot-0 { /* Bottom Row - Upright */ }
    .rot-90 { transform: rotate(90deg); } /* Left Row */
    .rot-180 { transform: rotate(180deg); } /* Top Row */
    .rot-270 { transform: rotate(-90deg); } /* Right Row */

    /* PROPERTY STYLING */
    .color-bar {
        width: 100%;
        height: 22%; /* Classic proportion */
        border-bottom: 2px solid #000;
        box-sizing: border-box;
    }
    .name { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0 2px; line-height: 1.1; }
    .price { margin-bottom: 5%; font-weight: normal; }
    
    /* ICON STYLING */
    .icon-box { flex: 1; display: flex; align-items: center; justify-content: center; padding: 5%; }
    .icon-box svg { width: 80%; height: 80%; fill: none; stroke: #000; stroke-width: 2; }
    .icon-box svg.filled { fill: #000; stroke: none; }

    /* CORNERS */
    .corner { width: 100%; height: 100%; position: relative; }
    
    /* GO */
    .go-arrow { position: absolute; width: 80%; left: 10%; top: 40%; transform: rotate(180deg); }
    .go-text { position: absolute; top: 5%; left: 5%; font-size: 1vmin; }

    /* JAIL */
    #jail-space { display: grid; grid-template-columns: 1fr 2.5fr; grid-template-rows: 2.5fr 1fr; }
    .jail-visiting { grid-column: 1/3; grid-row: 2; display: flex; align-items: center; justify-content: center; font-size: 0.8vmin; }
    .jail-cell { grid-column: 2; grid-row: 1; border-left: 2px solid #000; border-bottom: 2px solid #000; background: #f7941d; display: flex; align-items: center; justify-content: center; }
    
    /* CENTER BOARD ART */
    #center-art {
        grid-column: 2 / 11;
        grid-row: 2 / 11;
        position: relative;
        pointer-events: none;
    }
    
    .monopoly-logo {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        background: #ed1b24; color: white;
        padding: 1vmin 4vmin;
        font-family: 'Verdana', sans-serif;
        font-size: 5vmin; font-weight: 900;
        border: 0.4vmin solid white;
        outline: 2px solid black;
        box-shadow: 1vmin 1vmin 0 rgba(0,0,0,0.2);
    }

    .card-slot {
        position: absolute;
        width: 14vmin; height: 9vmin;
        border: 2px solid #000;
        display: flex; align-items: center; justify-content: center; text-align: center;
        font-weight: bold; font-size: 0.9vmin;
        box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
    }
    .slot-chest { top: 15%; left: 15%; background: #aae0fa; transform: rotate(135deg); }
    .slot-chance { bottom: 15%; right: 15%; background: #f7941d; transform: rotate(135deg); }

    /* --- TOKENS --- */
    .token {
        position: absolute; width: 3vmin; height: 3vmin;
        z-index: 100; transition: all 0.5s ease;
        filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5));
    }
    /* 3D illusion in 2D space - Top down cylinder look */
    .token-shape {
        width: 100%; height: 100%; border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.8);
        box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
    }

    /* --- PLAYER UI --- */
    #player-hud {
        position: absolute; bottom: 0; left: 0; width: 100%; height: 80px;
        background: white; border-top: 3px solid #000;
        display: flex; align-items: center; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        z-index: 2000;
    }
    .hud-stat { font-size: 1.2rem; font-weight: bold; }
    .hud-controls { display: flex; gap: 10px; }
    .hud-btn { padding: 10px 20px; font-size: 1rem; cursor: pointer; border: 2px solid #000; font-weight: bold; text-transform: uppercase; }
    .btn-roll { background: #ed1b24; color: white; }
    .btn-buy { background: #1fb25a; color: white; }
    .btn-pass { background: #999; color: white; }

</style>
</head>
<body>

<div id="ui-layer">
    <div class="panel" id="main-menu">
        <h1 style="font-family:'Verdana'; color:#ed1b24; text-transform:uppercase; margin-top:0;">Monopoly</h1>
        <button class="btn" onclick="startHost()">Create Game</button>
        <button class="btn" style="background:#0072bb" onclick="showJoin()">Join Game</button>
    </div>
    <div class="panel hidden" id="join-menu">
        <h2>Enter Code</h2>
        <input id="host-code" maxlength="4" placeholder="CODE">
        <button class="btn" style="background:#1fb25a" onclick="joinGame()">Connect</button>
        <button class="btn" style="background:#999" onclick="location.reload()">Back</button>
    </div>
    <div class="panel hidden" id="lobby-menu">
        <h2>Lobby</h2>
        <div style="font-size:3rem; font-family:monospace; margin:10px 0;" id="code-display">----</div>
        <p id="player-count">Waiting for players...</p>
        <button class="btn hidden" id="start-btn" onclick="hostStart()">START GAME</button>
    </div>
</div>

<div id="game-scene" class="hidden">
    <div id="board">
        <div id="center-art">
            <div class="monopoly-logo">MONOPOLY</div>
            <div class="card-slot slot-chest">COMMUNITY<br>CHEST</div>
            <div class="card-slot slot-chance">CHANCE<br><span style="font-size:2vmin; color:#ed1b24;">?</span></div>
            <div id="host-msg" style="position:absolute; bottom:10%; left:50%; transform:translateX(-50%); background:white; padding:5px 10px; border:2px solid black; font-weight:bold;">Waiting for turn...</div>
        </div>
    </div>
    
    <div id="player-hud" class="hidden">
        <div>
            <div id="p-name">Player</div>
            <div id="p-money" style="color:#1fb25a">$1500</div>
        </div>
        <div class="hud-controls">
            <button id="btn-roll" class="hud-btn btn-roll disabled" onclick="sendAct('ROLL')">Roll</button>
            <button id="btn-buy" class="hud-btn btn-buy hidden" onclick="sendAct('BUY')">Buy</button>
            <button id="btn-pass" class="hud-btn btn-pass hidden" onclick="sendAct('PASS')">Pass</button>
        </div>
    </div>
</div>

<script>
// --- ASSETS (Corrected SVGs) ---
const ICONS = {
    train: `<svg viewBox="0 0 100 60" class="filled"><path d="M10,40 L90,40 L90,20 L70,20 L70,10 L60,10 L60,20 L30,20 L30,40 M20,40 A5,5 0 1,0 30,40 M70,40 A5,5 0 1,0 80,40" /></svg>`,
    bulb: `<svg viewBox="0 0 50 80"><path d="M15,10 A20,20 0 1,1 35,10 L35,50 L15,50 Z M15,50 L35,50 L35,60 L25,70 L15,60 Z" /></svg>`,
    tap: `<svg viewBox="0 0 60 60"><path d="M10,20 L50,20 M30,20 L30,50 M20,10 L40,10 L40,20 L20,20 Z" /></svg>`,
    ring: `<svg viewBox="0 0 60 60"><path d="M15,20 L45,20 L50,10 L10,10 Z M10,20 A20,20 0 0,0 50,20" /></svg>`,
    chest: `<svg viewBox="0 0 60 50" class="filled"><rect x="5" y="10" width="50" height="35" rx="2" /><path d="M5,20 L55,20" stroke="white" stroke-width="2"/></svg>`,
    chance: `<text x="50%" y="80%" text-anchor="middle" font-size="40" font-family="serif" fill="#ed1b24" font-weight="bold">?</text>`,
    cop: `<svg viewBox="0 0 60 60" class="filled"><path d="M20,10 L40,10 L45,20 L15,20 Z M15,20 L15,40 L45,40 L45,20" /></svg>`,
    car: `<svg viewBox="0 0 80 40" class="filled"><path d="M10,30 L70,30 L70,20 L60,10 L20,10 L10,20 Z M15,30 A5,5 0 1,0 25,30 M55,30 A5,5 0 1,0 65,30" /></svg>`,
    diamond: `<svg viewBox="0 0 60 60" class="filled"><path d="M30,5 L55,30 L30,55 L5,30 Z" /></svg>`
};

const DATA = [
    { n: "GO", t: "go" }, // 0 Bottom Right
    { n: "MEDITER. AVE", p: 60, c: "var(--brown)", t: "prop" },
    { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
    { n: "BALTIC AVE", p: 60, c: "var(--brown)", t: "prop" },
    { n: "INCOME TAX", p: 200, t: "icon", i: ICONS.diamond },
    { n: "READING R.R.", p: 200, t: "icon", i: ICONS.train },
    { n: "ORIENTAL AVE", p: 100, c: "var(--lblue)", t: "prop" },
    { n: "CHANCE", t: "icon", i: ICONS.chance },
    { n: "VERMONT AVE", p: 100, c: "var(--lblue)", t: "prop" },
    { n: "CONN. AVE", p: 120, c: "var(--lblue)", t: "prop" },
    { n: "JAIL", t: "jail" }, // 10 Bottom Left
    { n: "ST. CHARLES", p: 140, c: "var(--pink)", t: "prop" },
    { n: "ELECTRIC CO.", p: 150, t: "icon", i: ICONS.bulb },
    { n: "STATES AVE", p: 140, c: "var(--pink)", t: "prop" },
    { n: "VIRGINIA AVE", p: 160, c: "var(--pink)", t: "prop" },
    { n: "PENN. R.R.", p: 200, t: "icon", i: ICONS.train },
    { n: "ST. JAMES", p: 180, c: "var(--orange)", t: "prop" },
    { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
    { n: "TENN. AVE", p: 180, c: "var(--orange)", t: "prop" },
    { n: "NEW YORK AVE", p: 200, c: "var(--orange)", t: "prop" },
    { n: "FREE PARKING", t: "fp" }, // 20 Top Left
    { n: "KENTUCKY AVE", p: 220, c: "var(--red)", t: "prop" },
    { n: "CHANCE", t: "icon", i: ICONS.chance },
    { n: "INDIANA AVE", p: 220, c: "var(--red)", t: "prop" },
    { n: "ILLINOIS AVE", p: 240, c: "var(--red)", t: "prop" },
    { n: "B. & O. R.R.", p: 200, t: "icon", i: ICONS.train },
    { n: "ATLANTIC AVE", p: 260, c: "var(--yellow)", t: "prop" },
    { n: "VENTNOR AVE", p: 260, c: "var(--yellow)", t: "prop" },
    { n: "WATER WORKS", p: 150, t: "icon", i: ICONS.tap },
    { n: "MARVIN GDN", p: 280, c: "var(--yellow)", t: "prop" },
    { n: "GO TO JAIL", t: "gtj" }, // 30 Top Right
    { n: "PACIFIC AVE", p: 300, c: "var(--green)", t: "prop" },
    { n: "N. CAROL AVE", p: 300, c: "var(--green)", t: "prop" },
    { n: "COMM. CHEST", t: "icon", i: ICONS.chest },
    { n: "PENN. AVE", p: 320, c: "var(--green)", t: "prop" },
    { n: "SHORT LINE", p: 200, t: "icon", i: ICONS.train },
    { n: "CHANCE", t: "icon", i: ICONS.chance },
    { n: "PARK PLACE", p: 350, c: "var(--dblue)", t: "prop" },
    { n: "LUXURY TAX", p: 100, t: "icon", i: ICONS.ring },
    { n: "BOARDWALK", p: 400, c: "var(--dblue)", t: "prop" }
];

// --- APP LOGIC ---
let peer, conn, myCode;
let players = [];
let turnIdx = 0;
let phase = 'LOBBY';
let boardState = DATA.map(s => ({...s, owner:null}));

function generateBoard() {
    const board = document.getElementById('board');
    // Generate Cells based on Grid Logic
    DATA.forEach((d, i) => {
        const el = document.createElement('div');
        el.className = 'space';
        el.id = `space-${i}`;
        
        // GRID PLACEMENT & ROTATION
        // Index 0 (GO) is Row 11, Col 11
        // Indices 1-9 are Row 11, Cols 10-2
        // Index 10 (JAIL) is Row 11, Col 1
        // Indices 11-19 are Rows 10-2, Col 1
        // Index 20 (FP) is Row 1, Col 1
        // Indices 21-29 are Row 1, Cols 2-10
        // Index 30 (GTJ) is Row 1, Col 11
        // Indices 31-39 are Rows 2-10, Col 11
        
        let r, c, rot;
        
        if (i === 0) { r=11; c=11; rot='rot-0'; }
        else if (i <= 9) { r=11; c=11-i; rot='rot-0'; }
        else if (i === 10) { r=11; c=1; rot='rot-0'; } // Jail handles its own rotation
        else if (i <= 19) { r=11-(i-10); c=1; rot='rot-90'; }
        else if (i === 20) { r=1; c=1; rot='rot-0'; }
        else if (i <= 29) { r=1; c=(i-20)+1; rot='rot-180'; }
        else if (i === 30) { r=1; c=11; rot='rot-0'; }
        else if (i <= 39) { r=(i-30)+1; c=11; rot='rot-270'; }
        
        el.style.gridRow = r;
        el.style.gridColumn = c;

        // INNER CONTENT
        let inner = '';
        if (d.t === 'prop') {
            inner = `
                <div class="container ${rot}">
                    <div class="color-bar" style="background:${d.c}"></div>
                    <div class="name">${d.n}</div>
                    <div class="price">$${d.p}</div>
                </div>`;
        } else if (d.t === 'icon') {
            inner = `
                <div class="container ${rot}">
                    <div class="name" style="margin-top:5%;">${d.n}</div>
                    <div class="icon-box">${d.i}</div>
                    <div class="price">${d.p ? '$'+d.p : ''}</div>
                </div>`;
        } else if (d.t === 'go') {
            inner = `<div class="corner"><div class="go-arrow" style="font-size:3vmin; color:#ed1b24;">&#10140;</div><div class="go-text" style="transform:rotate(-45deg); font-weight:900; font-size:2vmin; margin-top:20%;">COLLECT<br>$200 SALARY<br>AS YOU PASS<br><span style="font-size:4vmin; color:#ed1b24">GO</span></div></div>`;
        } else if (d.t === 'jail') {
            el.id = 'jail-space';
            inner = `<div class="jail-cell"></div><div class="jail-visiting"><div style="transform:rotate(-90deg)">JUST</div><div>VISITING</div></div>`;
        } else if (d.t === 'fp') {
            inner = `<div class="container rot-180" style="justify-content:center"><div class="name">FREE</div><div class="icon-box" style="flex:0; padding:2px;">${ICONS.car}</div><div class="name">PARKING</div></div>`;
        } else if (d.t === 'gtj') {
            inner = `<div class="container rot-270" style="justify-content:center"><div class="name">GO TO</div><div class="icon-box" style="flex:0; padding:2px;">${ICONS.cop}</div><div class="name">JAIL</div></div>`;
        }
        
        el.innerHTML = inner;
        board.appendChild(el);
    });
}

// --- HOST ---
function startHost() {
    myCode = Math.random().toString(36).substring(2,6).toUpperCase();
    const pid = "mono-game-" + myCode;
    peer = new Peer(pid);
    
    peer.on('open', id => {
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('lobby-menu').classList.remove('hidden');
        document.getElementById('code-display').innerText = myCode;
        generateBoard();
    });

    peer.on('connection', c => {
        c.on('open', () => {
            const colors = ['#ed1b24', '#0072bb', '#1fb25a', '#f7941d'];
            const p = { 
                id: c.peer, conn: c, name: `Player ${players.length+1}`, 
                money: 1500, pos: 0, color: colors[players.length%4], props: [] 
            };
            players.push(p);
            updateLobby();
            c.send({type:'INIT', p:san(p)});
        });
        c.on('data', d => handleAct(c.peer, d));
    });
}

function updateLobby() {
    document.getElementById('player-count').innerText = `${players.length} Players connected`;
    if(players.length > 0) document.getElementById('start-btn').classList.remove('hidden');
}

function hostStart() {
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('game-scene').classList.remove('hidden');
    players.forEach(p => spawnToken(p));
    phase = 'TURN';
    broadcast();
    sendTurn();
}

function handleAct(pid, act) {
    const p = players.find(x => x.id === pid);
    if (!p || players.indexOf(p) !== turnIdx) return;
    
    if (act === 'ROLL') {
        const roll = Math.floor(Math.random()*6)+1 + Math.floor(Math.random()*6)+1;
        msg(`Player ${players.indexOf(p)+1} rolled ${roll}`);
        
        // Move
        const old = p.pos;
        p.pos = (p.pos + roll) % 40;
        if (p.pos < old) p.money += 200;
        moveToken(p);
        
        // Logic
        const s = boardState[p.pos];
        if (s.t === 'gtj') {
            setTimeout(() => { p.pos=10; moveToken(p); nextTurn(); }, 1000);
        } else if (s.t === 'prop') {
            if (!s.owner && p.money >= s.p) {
                p.conn.send({type:'BUY_OPT'});
            } else if (s.owner && s.owner !== p.id) {
                p.money -= 20; // Rent
                const owner = players.find(x => x.id === s.owner);
                if(owner) owner.money += 20;
                nextTurn();
            } else {
                nextTurn();
            }
        } else {
            nextTurn();
        }
        broadcast();
    } else if (act === 'BUY') {
        const s = boardState[p.pos];
        if(!s.owner && p.money >= s.p) {
            p.money -= s.p; s.owner = p.id;
            p.props.push(s.n);
            // Visual Mark
            const el = document.getElementById(`space-${p.pos}`);
            el.style.border = `3px solid ${p.color}`;
        }
        nextTurn();
    } else if (act === 'PASS') {
        nextTurn();
    }
}

function nextTurn() {
    turnIdx = (turnIdx + 1) % players.length;
    setTimeout(() => { sendTurn(); broadcast(); }, 1000);
}

function sendTurn() {
    players.forEach((p, i) => {
        if (i === turnIdx) {
            msg(`Turn: ${p.name}`);
            p.conn.send({type:'TURN'});
        } else {
            p.conn.send({type:'WAIT'});
        }
    });
}

function spawnToken(p) {
    const el = document.createElement('div');
    el.className = 'token';
    el.id = `t-${p.id}`;
    el.innerHTML = `<div class="token-shape" style="background:${p.color}"></div>`;
    document.getElementById('board').appendChild(el);
    moveToken(p);
}

function moveToken(p) {
    const t = document.getElementById(`t-${p.id}`);
    const s = document.getElementById(`space-${p.pos}`);
    // Calc pos relative to board
    const bRect = document.getElementById('board').getBoundingClientRect();
    const sRect = s.getBoundingClientRect();
    
    // Center in space
    const top = sRect.top - bRect.top + (sRect.height/2) - (t.offsetHeight/2);
    const left = sRect.left - bRect.left + (sRect.width/2) - (t.offsetWidth/2);
    
    t.style.top = top + 'px';
    t.style.left = left + 'px';
}

function broadcast() {
    const safe = players.map(san);
    players.forEach(p => p.conn.send({type:'STATE', pl:safe}));
}
function msg(txt) { document.getElementById('host-msg').innerText = txt; }
function san(p) { return {id:p.id, name:p.name, money:p.money, color:p.color}; }

// --- CLIENT ---
function showJoin() {
    document.getElementById('main-menu').classList.add('hidden');
    document.getElementById('join-menu').classList.remove('hidden');
}

function joinGame() {
    const code = document.getElementById('host-code').value.toUpperCase();
    peer = new Peer();
    peer.on('open', id => {
        conn = peer.connect("mono-game-" + code);
        conn.on('open', () => {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('player-hud').classList.remove('hidden');
            document.getElementById('game-scene').classList.remove('hidden');
            generateBoard(); // Client needs visual board too
        });
        conn.on('data', clientHandle);
    });
}

function clientHandle(d) {
    if(d.type === 'INIT') {
        document.getElementById('p-name').innerText = d.p.name;
        document.getElementById('p-name').style.color = d.p.color;
    }
    if(d.type === 'STATE') {
        const me = d.pl.find(x => x.name === document.getElementById('p-name').innerText);
        if(me) document.getElementById('p-money').innerText = `$${me.money}`;
    }
    
    const bRoll = document.getElementById('btn-roll');
    const bBuy = document.getElementById('btn-buy');
    const bPass = document.getElementById('btn-pass');
    
    bRoll.classList.add('disabled'); bRoll.style.opacity = 0.5;
    bBuy.classList.add('hidden');
    bPass.classList.add('hidden');
    
    if(d.type === 'TURN') {
        bRoll.classList.remove('disabled');
        bRoll.style.opacity = 1;
    }
    if(d.type === 'BUY_OPT') {
        bBuy.classList.remove('hidden');
        bPass.classList.remove('hidden');
    }
}

function sendAct(a) { conn.send(a); }

</script>
</body>
</html>
